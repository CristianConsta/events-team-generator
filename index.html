<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://apis.google.com https://www.gstatic.com https://accounts.google.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://lh3.googleusercontent.com; connect-src 'self' https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://www.googleapis.com https://*.googleapis.com; font-src 'self' data:; base-uri 'none'; frame-ancestors 'none'; frame-src https://accounts.google.com https://*.google.com https://*.firebaseapp.com https://last-war-game-desert-storm.firebaseapp.com; form-action 'self';">
    <title>Desert Storm - Player Selection</title>
    <script src="vendor/xlsx.full.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="vendor/firebase-app-compat.js"></script>
    <script src="vendor/firebase-auth-compat.js"></script>
    <script src="vendor/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-module.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213E 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; color: #FDC830; font-size: 2.5rem; margin-bottom: 30px; }
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .page-header h1 { margin: 0; }
        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(253, 200, 48, 0.3);
        }
        .card h2 { color: #FDC830; margin-bottom: 15px; }
        button {
            background: linear-gradient(135deg, #FF6B35, #F7931E);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 5px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 107, 53, 0.5); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        button.secondary { background: linear-gradient(135deg, #FDC830, #F7931E); }
        .hidden { display: none !important; }
        .coord-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 12, 20, 0.7);
            backdrop-filter: blur(3px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        input[type="file"] { display: none; }

        /* ── Onboarding Tour Tooltip ── */
        @keyframes onboarding-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(253, 200, 48, 0.6); }
            50%      { box-shadow: 0 0 0 6px rgba(253, 200, 48, 0); }
        }
        .onboarding-highlight {
            outline: 2px solid #FDC830;
            outline-offset: 3px;
            border-radius: 6px;
            animation: onboarding-pulse 1.8s ease-in-out infinite;
        }
        .onboarding-tooltip {
            position: fixed;
            z-index: 3000;
            max-width: 280px;
            background: rgba(26, 26, 46, 0.96);
            border: 1px solid rgba(253, 200, 48, 0.45);
            border-radius: 12px;
            padding: 18px 20px 14px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(8px);
            pointer-events: auto;
        }
        .onboarding-tooltip .onboarding-step-label {
            color: #FDC830;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        .onboarding-tooltip .onboarding-title {
            color: #FDC830;
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 6px;
        }
        .onboarding-tooltip .onboarding-desc {
            color: rgba(255, 255, 255, 0.82);
            font-size: 13px;
            line-height: 1.45;
            margin-bottom: 10px;
        }
        .onboarding-tooltip .onboarding-skip {
            display: block;
            text-align: right;
            color: rgba(255, 255, 255, 0.4);
            font-size: 12px;
            cursor: pointer;
            user-select: none;
        }
        .onboarding-tooltip .onboarding-skip:hover { color: rgba(255, 255, 255, 0.7); }
        /* Arrow pointing down (tooltip is above target) */
        .onboarding-tooltip[data-arrow="bottom"]::after {
            content: '';
            position: absolute;
            bottom: -7px;
            left: var(--arrow-offset, 50%);
            width: 14px;
            height: 7px;
            background: rgba(26, 26, 46, 0.96);
            clip-path: polygon(0 0, 100% 0, 50% 100%);
        }
        /* Arrow pointing up (tooltip is below target) */
        .onboarding-tooltip[data-arrow="top"]::after {
            content: '';
            position: absolute;
            top: -7px;
            left: var(--arrow-offset, 50%);
            width: 14px;
            height: 7px;
            background: rgba(26, 26, 46, 0.96);
            clip-path: polygon(50% 0, 0 100%, 100% 100%);
        }

        /* Collapsible Panel */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 15px 0;
            border-bottom: 2px solid rgba(253, 200, 48, 0.3);
            user-select: none;
        }
        .collapsible-header:hover { opacity: 0.8; }
        .collapsible-content {
            margin-top: 20px;
            max-height: 9999px;
            overflow: hidden;
            transition: max-height 0.4s ease-out, margin-top 0.3s ease-out;
        }
        .collapsible-content.collapsed {
            max-height: 0;
            margin-top: 0;
        }
        .expand-icon {
            font-size: 24px;
            transition: transform 0.3s;
            display: inline-block;
        }
        .expand-icon.rotated {
            transform: rotate(180deg);
        }
        
        /* Player Selection Interface */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filters input, .filters select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
        }
        .filters input::placeholder { color: rgba(255,255,255,0.6); }
        
        /* Fix dropdown option colors */
        .filters select option {
            background: #2c2c2c;
            color: white;
            padding: 10px;
        }
        .filters select option:hover {
            background: #3c3c3c;
        }
        
        .team-counters {
            display: flex;
            gap: 30px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .counter {
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
        }
        .counter.team-a { background: linear-gradient(135deg, #4169E1, #1E90FF); }
        .counter.team-b { background: linear-gradient(135deg, #DC143C, #FF6347); }
        .counter.full { animation: pulse 1s infinite; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .players-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .players-table th {
            background: rgba(253, 200, 48, 0.3);
            padding: 12px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #FDC830;
        }
        .players-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .players-table tr:hover {
            background: rgba(255,255,255,0.05);
        }
        .players-table tr.selected-a {
            background: rgba(65, 105, 225, 0.2);
        }
        .players-table tr.selected-b {
            background: rgba(220, 20, 60, 0.2);
        }
        #buildingsTable input[type="number"] {
            width: 70px;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.2);
            color: #fff;
            box-sizing: border-box;
        }
        #languageSelect {
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 12px;
            cursor: pointer;
        }
        #languageSelect option {
            background: #2c2c2c;
            color: white;
        }
        
        .team-buttons {
            display: flex;
            gap: 10px;
        }
        .team-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: 2px solid;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
            margin: 0;
        }
        .team-btn.team-a-btn {
            border-color: #4169E1;
            color: #4169E1;
        }
        .team-btn.team-a-btn:hover { background: #4169E1; color: white; }
        .team-btn.team-a-btn.active { background: #4169E1; color: white; }
        .team-btn.team-b-btn {
            border-color: #DC143C;
            color: #DC143C;
        }
        .team-btn.team-b-btn:hover { background: #DC143C; color: white; }
        .team-btn.team-b-btn.active { background: #DC143C; color: white; }
        .team-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .clear-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            color: rgba(255,255,255,0.6);
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin: 0;
        }
        .clear-btn:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .generate-section {
            text-align: center;
            padding: 30px;
            margin-top: 20px;
        }
        .generate-btn {
            background: linear-gradient(135deg, #00C853, #64DD17);
            padding: 20px 50px;
            font-size: 20px;
            box-shadow: 0 4px 15px rgba(0, 200, 83, 0.4);
        }
        .generate-btn:disabled {
            background: linear-gradient(135deg, #666, #888);
            box-shadow: none;
        }
        
        /* Floating Generate Buttons */
        .floating-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(26, 26, 46, 0) 0%, rgba(26, 26, 46, 0.95) 20%, rgba(26, 26, 46, 1) 100%);
            padding: 20px;
            display: flex;
            gap: 20px;
            justify-content: center;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        }
        .floating-buttons button {
            min-width: 280px;
            padding: 18px 40px;
            font-size: 18px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        .floating-buttons button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
        }
        
        .message { padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center; font-weight: bold; }
        .success { background: rgba(144, 238, 144, 0.2); border: 2px solid #90EE90; color: #90EE90; }
        .error { background: rgba(255, 107, 53, 0.2); border: 2px solid #FF6B35; color: #FF6B35; }
        .warning { background: rgba(255, 193, 7, 0.2); border: 2px solid #FFC107; color: #FFC107; }
        .processing { background: rgba(253, 200, 48, 0.2); border: 2px solid #FDC830; color: #FDC830; }
        
        /* Team specific sections */
        .team-section {
            border-left: 4px solid;
            padding-left: 20px;
            margin-top: 20px;
        }
        .team-section.team-a-section {
            border-left-color: #4169E1;
        }
        .team-section.team-b-section {
            border-left-color: #DC143C;
        }

        /* =============================================
           TABLET  (≤ 768px)
           ============================================= */
        @media (max-width: 768px) {
            body { padding: 15px; }
            h1 { font-size: 2rem; margin-bottom: 20px; }
            .card { padding: 22px; }

            .filters input, .filters select, .filters button {
                flex: 1 1 45%;
                min-width: 0;
            }
            .filters input, .filters select { font-size: 16px; }

            .floating-buttons button {
                min-width: 200px;
                padding: 16px 24px;
                font-size: 16px;
            }

            .counter { padding: 12px 22px; font-size: 16px; }
        }

        /* =============================================
           PHONE  (≤ 480px)
           ============================================= */
        @media (max-width: 480px) {
            body { padding: 10px; }
            h1 { font-size: 1.5rem; margin-bottom: 16px; }
            .card { padding: 16px; margin: 12px 0; }
            .card h2 { font-size: 1.2rem; }

            /* Global button tweaks */
            button { margin: 4px 0; touch-action: manipulation; }

            /* Page header */
            .page-header { gap: 8px; }

            /* ── Filters — full-width stack ── */
            .filters { gap: 10px; }
            .filters input, .filters select, .filters button {
                flex: 1 1 100%;
                width: 100%;
                min-width: 0;
            }
            .filters input, .filters select { font-size: 16px; }

            /* ── Team counters ── */
            .team-counters { gap: 10px; }
            .counter { padding: 10px 14px; font-size: 14px; flex: 1; min-width: 0; }

            /* ── Players table → card layout ── */
            #playersTable, #buildingsTable { display: block; }
            #playersTable thead, #buildingsTable thead { display: none; }
            #playersTable tbody, #buildingsTable tbody { display: block; }

            #playersTable tr, #buildingsTable tr {
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                background: rgba(255,255,255,0.07);
                border-radius: 10px;
                padding: 12px;
                margin-bottom: 10px;
                border: 1px solid rgba(255,255,255,0.12);
            }
            #buildingsTable tr {
                display: grid;
                grid-template-columns: minmax(0, 1fr) auto auto;
                column-gap: 10px;
                row-gap: 4px;
                align-items: center;
            }
            #playersTable tr:hover { background: rgba(255,255,255,0.07); }
            #playersTable tr.selected-a { background: rgba(65,105,225,0.2); border-color: rgba(65,105,225,0.4); }
            #playersTable tr.selected-b { background: rgba(220,20,60,0.2); border-color: rgba(220,20,60,0.4); }

            #playersTable td, #buildingsTable td {
                border-bottom: none;
                padding: 5px 0;
            }
            #buildingsTable td {
                display: block;
                min-width: 0;
            }

            /* Players: name + power + troops on one line, buttons below */
            #playersTable td:first-child {
                flex: 1;
                min-width: 0;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            #playersTable td:first-child strong { font-size: 16px; }

            #playersTable td:nth-child(2) { flex: 0 0 auto; white-space: nowrap; opacity: 0.85; }
            #playersTable td:nth-child(3) { flex: 0 0 auto; white-space: nowrap; }

            #playersTable td:nth-child(4) {
                width: 100%;
                padding-top: 8px;
                border-top: 1px solid rgba(255,255,255,0.08);
                margin-top: 2px;
            }

            /* Team buttons — touch-friendly */
            .team-buttons { gap: 8px; }
            .team-btn { padding: 10px 14px; font-size: 14px; flex: 1; min-width: 0; }
            .clear-btn {
                padding: 10px 12px;
                font-size: 13px;
                min-height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* ── Buildings table → card layout ── */
            #buildingsTable td:first-child {
                flex: 1;
                min-width: 0;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                font-weight: bold;
            }
            #buildingsTable td:nth-child(2) {
                flex: 0 0 auto;
                display: flex;
                align-items: center;
                gap: 4px;
            }
            #buildingsTable td:nth-child(2)::before {
                content: attr(data-label);
                font-size: 12px;
                opacity: 0.6;
                white-space: nowrap;
            }
            #buildingsTable td:nth-child(3) {
                flex: 0 0 auto;
                display: flex;
                align-items: center;
                gap: 4px;
            }
            #buildingsTable td:nth-child(3)::before {
                content: attr(data-label);
                font-size: 12px;
                opacity: 0.6;
                white-space: nowrap;
            }
            #buildingsTable input[type="number"] {
                width: 50px !important;
                font-size: 16px;
            }

            /* ── Floating generate buttons — vertical stack ── */
            .floating-buttons {
                flex-direction: column;
                padding: 10px 14px;
                gap: 10px;
            }
            .floating-buttons button {
                min-width: unset;
                width: 100%;
                margin: 0;
                padding: 14px 16px;
                font-size: 16px;
            }
            .floating-buttons button span { font-size: 12px !important; }

            /* ── Touch feedback on collapsible headers ── */
            .collapsible-header:active { opacity: 0.7; }

            /* ── Overlays — tighter padding on small screens ── */
            .coord-overlay > div { padding: 16px !important; }

            /* ── Download modal buttons ── */
            #downloadMapBtn, #downloadExcelBtn { padding: 18px 16px !important; }

            /* ── Login screen ── */
            #loginScreen > div { padding: 24px !important; }

            /* ── User header ── */
            #userHeader                { padding: 10px !important; }
            #userHeader > div:first-child { gap: 10px !important; }
            #userEmail                 { font-size: 13px !important; }
            #playerCount               { font-size: 11px !important; }
            #syncStatus svg            { width: 16px !important; height: 16px !important; }
            #headerRight               { gap: 6px !important; }
            #languageSelect            { padding: 4px 6px !important; font-size: 11px !important; }
            #signOutBtn                { padding: 6px 8px !important; }
            #signOutBtn svg            { width: 16px !important; height: 16px !important; }

            /* ── Onboarding tooltip ── */
            .onboarding-tooltip { max-width: 240px; padding: 14px 16px 10px; font-size: 12px; }
            .onboarding-tooltip .onboarding-title { font-size: 14px; }
            .onboarding-tooltip .onboarding-desc { font-size: 12px; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" style="display: none;">
        <div style="max-width: 400px; margin: 100px auto; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h1 style="text-align: center; color: #333;" data-i18n="login_title">🏜️ Desert Storm</h1>
            <h3 style="text-align: center; color: #666; margin-bottom: 30px;" data-i18n="login_subtitle">Sign in to continue</h3>
            
            <button id="googleSignInBtn" onclick="handleGoogleSignIn()" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; cursor: pointer; background: white; border: 1px solid #ddd; border-radius: 8px; color: #333;">
                🔵 <span data-i18n="login_google">Sign in with Google</span>
            </button>
            
            <div style="text-align: center; margin: 20px 0; color: #999;" data-i18n="login_or">or</div>
            
            <input type="email" id="emailInput" placeholder="Email" data-i18n-placeholder="login_email_placeholder" style="width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;">
            <input type="password" id="passwordInput" placeholder="Password" data-i18n-placeholder="login_password_placeholder" style="width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;">
            
            <button onclick="handleEmailSignIn()" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 8px;">
                <span data-i18n="login_sign_in">Sign In</span>
            </button>
            
            <button onclick="showSignUpForm()" style="width: 100%; padding: 12px; margin: 5px 0; font-size: 14px; cursor: pointer; background: #2196F3; color: white; border: none; border-radius: 8px;">
                <span data-i18n="login_create_account">Create New Account</span>
            </button>
            
            <button onclick="handlePasswordReset()" style="width: 100%; padding: 8px; margin: 10px 0; font-size: 12px; cursor: pointer; background: transparent; color: #666; border: none;">
                <span data-i18n="login_forgot_password">Forgot Password?</span>
            </button>
            
            <select id="loginLanguageSelect" style="display: block; margin: 18px auto 0; padding: 6px 10px; border-radius: 6px; border: 1px solid #ddd; background: #fff; color: #333; font-size: 13px; cursor: pointer;">
                <option value="en">EN</option>
                <option value="fr">FR</option>
                <option value="de">DE</option>
                <option value="it">IT</option>
                <option value="ko">KO</option>
                <option value="ro">RO</option>
            </select>

            <div id="statusMessage" style="margin-top: 20px; padding: 10px; border-radius: 8px; text-align: center; display: none;"></div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display: none;">
        <!-- User Header -->
        <div id="userHeader" style="background: rgba(255,255,255,0.1); padding: 15px; margin-bottom: 20px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto 20px auto;">
            <div style="display: flex; align-items: center; gap: 16px;">
                <div>
                    <div id="userEmail" style="color: #FDC830; font-weight: bold;"></div>
                    <div id="playerCount" style="color: rgba(255,255,255,0.65); font-size: 13px;"></div>
                </div>
                <span id="syncStatus" style="display: flex; align-items: center;" title="Synced">
                    <svg id="syncIconSynced"    xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#90EE90" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.39 17.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/><polyline points="9 12 11 14 15 10"/></svg>
                    <svg id="syncIconNotSynced" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#FF6B35" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;"><path d="M20.39 17.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/><line x1="10" y1="10" x2="16" y2="16"/><line x1="16" y1="10" x2="10" y2="16"/></svg>
                </span>
            </div>
            <div id="headerRight" style="display: flex; align-items: center; gap: 10px;">
                <select id="languageSelect">
                    <option value="en">EN</option>
                    <option value="fr">FR</option>
                    <option value="de">DE</option>
                    <option value="it">IT</option>
                    <option value="ko">KO</option>
                    <option value="ro">RO</option>
                </select>
                <button id="signOutBtn" onclick="handleSignOut()" title="Sign Out" style="padding: 8px 10px; background: #FF6B35; color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                </button>
            </div>
        </div>

        <div class="container">
            <div class="page-header">
                <h1 data-i18n="main_title">🏜️ DESERT STORM</h1>
                <button class="secondary" onclick="toggleBuildingsPanel()"><span data-i18n="buildings_button">Buildings &amp; Priorities</span></button>
            </div>

            <div id="buildingsPanel" class="card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <h2 style="margin: 0;" data-i18n="buildings_panel_title">Buildings &amp; Priorities</h2>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="clear-btn" onclick="openCoordinatesPicker()"><span data-i18n="map_coordinates">Map Coordinates</span></button>
                        <button class="clear-btn" onclick="toggleBuildingsPanel()"><span data-i18n="close">Close</span></button>
                    </div>
                </div>
                <p style="opacity: 0.9; margin: 15px 0;" data-i18n="buildings_intro">Update building slots and priorities. Total slots across all buildings must be 20 or less.</p>
                <div style="overflow-x: auto;">
                    <table class="players-table" id="buildingsTable">
                        <thead>
                            <tr>
                                <th data-i18n="buildings_table_building">Building</th>
                                <th data-i18n="buildings_table_slots">Slots</th>
                                <th data-i18n="buildings_table_priority">Priority</th>
                            </tr>
                        </thead>
                        <tbody id="buildingsTableBody">
                            <!-- Building rows will be rendered here -->
                        </tbody>
                    </table>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                    <button class="secondary" onclick="resetBuildingsToDefault()"><span data-i18n="reset_default">Reset to Default</span></button>
                    <button onclick="saveBuildingConfig()"><span data-i18n="save_changes">Save Changes</span></button>
                </div>
                <div id="buildingsStatus"></div>
            </div>

            <div id="coordPickerOverlay" class="coord-overlay hidden">
                <div style="width: min(1000px, 95vw); max-height: 90vh; overflow: auto; background: rgba(26, 26, 46, 0.98); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <h2 style="margin: 0;" data-i18n="coord_picker_title">Map Coordinates Picker</h2>
                        <button class="clear-btn" onclick="closeCoordinatesPicker()"><span data-i18n="close">Close</span></button>
                    </div>
                    <p style="opacity: 0.9; margin: 10px 0 15px;" data-i18n="coord_picker_help">Click on the map to set the position for the selected building. Coordinates update one by one.</p>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center; margin-bottom: 6px;">
                        <strong id="coordBuildingLabel" data-i18n="coord_label_building">Building</strong>
                        <span id="coordBuildingIndex" style="opacity: 0.7;"></span>
                    </div>
                    <div id="coordPrompt" style="opacity: 0.85; margin-bottom: 10px;" data-i18n="coord_prompt_default">Click on the map to set coordinates.</div>
                    <div id="coordBuildingValue" style="opacity: 0.7; margin-bottom: 10px;"></div>
                    <canvas id="coordCanvas" style="width: 100%; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2);"></canvas>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                        <button class="secondary" onclick="prevCoordBuilding()"><span data-i18n="coord_prev">Prev</span></button>
                        <button class="secondary" onclick="nextCoordBuilding()"><span data-i18n="coord_next">Next</span></button>
                        <button onclick="saveBuildingPositions()"><span data-i18n="coord_save">Save Coordinates</span></button>
                    </div>
                    <div id="coordStatus" style="margin-top: 10px;"></div>
                </div>
            </div>
            
            <!-- Upload Section (Collapsible when players exist) -->
            <div id="uploadSection" class="card">
                <div class="collapsible-header" onclick="toggleUploadPanel()">
                    <div>
                        <h2 style="display: inline; margin: 0;" data-i18n="player_db_title">📊 Player Database</h2>
                        <span id="uploadHint" style="margin-left: 15px; opacity: 0.7; font-size: 14px;"></span>
                    </div>
                    <span class="expand-icon rotated" id="uploadExpandIcon">▼</span>
                </div>
                
                <div class="collapsible-content" id="uploadContent">
                    <p style="opacity: 0.9; margin-bottom: 20px;" data-i18n="upload_help">Upload your player data. Template headers start at row 10: Player Name, E1 Total Power(M), E1 Troops.</p>
                    
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button id="downloadTemplateBtn" class="secondary" onclick="downloadPlayerTemplate()">📥 <span data-i18n="download_template">Download Template</span></button>
                        <button id="uploadPlayerBtn" onclick="document.getElementById('playerFileInput').click()">📤 <span data-i18n="upload_player_data">Upload Player Data</span></button>
                        <input type="file" id="playerFileInput" accept=".xlsx,.xls" onchange="uploadPlayerData()">
                    </div>
                    
                    <div id="uploadMessage"></div>
                </div>
            </div>
            
            <!-- Player Selection Section -->
            <div id="selectionSection" class="card hidden">
                <h2 data-i18n="select_teams_title">⚔️ Select Teams</h2>
                <p style="opacity: 0.9; margin-bottom: 20px;" data-i18n="select_teams_help">Select players for Team A and Team B independently. Maximum 20 players per team.</p>
                
                <!-- Team Counters -->
                <div class="team-counters">
                    <div class="counter team-a">
                        <span data-i18n="team_a_label">Team A</span>: <span id="teamACount">0</span><span data-i18n="team_count_suffix">/20</span>
                    </div>
                    <div class="counter team-b">
                        <span data-i18n="team_b_label">Team B</span>: <span id="teamBCount">0</span><span data-i18n="team_count_suffix">/20</span>
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="filters">
                    <input type="text" id="searchFilter" placeholder="🔍 Search player name..." data-i18n-placeholder="search_placeholder" onkeyup="filterPlayers()">
                    <select id="troopsFilter" onchange="filterPlayers()">
                        <option value="" data-i18n="troops_filter_all">All Troop Types</option>
                        <option value="Tank" data-i18n="troops_filter_tank">Tank</option>
                        <option value="Aero" data-i18n="troops_filter_aero">Aero</option>
                        <option value="Missile" data-i18n="troops_filter_missile">Missile</option>
                    </select>
                    <select id="sortFilter" onchange="filterPlayers()">
                        <option value="power-desc" data-i18n="sort_power_desc">Sort by Power (High to Low)</option>
                        <option value="power-asc" data-i18n="sort_power_asc">Sort by Power (Low to High)</option>
                        <option value="name-asc" data-i18n="sort_name_asc">Sort by Name (A-Z)</option>
                        <option value="name-desc" data-i18n="sort_name_desc">Sort by Name (Z-A)</option>
                    </select>
                    <button class="secondary" onclick="clearAllSelections()"><span data-i18n="clear_all_selections">Clear All Selections</span></button>
                </div>
                
                <!-- Players Table -->
                <div style="overflow-x: auto;">
                    <table class="players-table" id="playersTable">
                        <thead>
                            <tr>
                                <th data-i18n="table_header_player_name">Player Name</th>
                                <th data-i18n="table_header_power">E1 Power (M)</th>
                                <th data-i18n="table_header_troop">Troop Type</th>
                                <th data-i18n="table_header_team_selection">Team Selection</th>
                            </tr>
                        </thead>
                        <tbody id="playersTableBody">
                            <!-- Players will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Team A & B Sections removed - replaced with floating buttons -->
            
            
            <!-- Download Modal -->
            <div id="downloadModalOverlay" class="coord-overlay hidden">
                <div style="width: min(480px, 90vw); background: rgba(26, 26, 46, 0.98); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); padding: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h2 id="downloadModalTitle" style="margin: 0;"></h2>
                        <button class="clear-btn" onclick="closeDownloadModal()"><span data-i18n="close">Close</span></button>
                    </div>
                    <p id="downloadModalSubtitle" style="opacity: 0.9; margin: 0 0 25px;"></p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <button id="downloadMapBtn" style="font-size: 17px; padding: 16px 25px;">
                            🗺️ <span data-i18n="download_map">Map</span>
                        </button>
                        <button id="downloadExcelBtn" style="padding: 16px 25px;">
                            📊 <span data-i18n="download_excel">Excel</span>
                        </button>
                    </div>
                    <div id="downloadStatus" style="margin-top: 15px;"></div>
                </div>
            </div>
        </div>

        <!-- Floating Generate Buttons -->
        <div class="floating-buttons" id="floatingButtons" style="display: none;">
            <button class="generate-btn" id="generateBtnA" onclick="generateTeamAssignments('A')" style="background: linear-gradient(135deg, #4169E1, #1E90FF);" disabled>
                <span style="display: block; font-size: 14px; opacity: 0.9;"><span data-i18n="team_a_label">Team A</span> (<span id="teamAFloatCount">0</span><span data-i18n="team_count_suffix">/20</span>)</span>
                🚀 <span data-i18n="generate_team_a">Generate Team A</span>
            </button>
            <button class="generate-btn" id="generateBtnB" onclick="generateTeamAssignments('B')" style="background: linear-gradient(135deg, #DC143C, #FF6347);" disabled>
                <span style="display: block; font-size: 14px; opacity: 0.9;"><span data-i18n="team_b_label">Team B</span> (<span id="teamBFloatCount">0</span><span data-i18n="team_count_suffix">/20</span>)</span>
                🚀 <span data-i18n="generate_team_b">Generate Team B</span>
            </button>
        </div>

        <!-- Onboarding Tour Tooltip (reused for each step) -->
        <div id="onboardingTooltip" class="onboarding-tooltip hidden">
            <div class="onboarding-step-label" id="onboardingStepLabel"></div>
            <div class="onboarding-title"      id="onboardingTitle"></div>
            <div class="onboarding-desc"       id="onboardingDesc"></div>
            <div class="onboarding-skip"       id="onboardingSkip"></div>
        </div>
    </div>

    <script>
        // ============================================================
        // I18N
        // ============================================================
        const translations = {
            en: {
                app_title: 'Desert Storm - Player Selection',
                login_title: '🏜️ Desert Storm',
                login_subtitle: 'Sign in to continue',
                login_google: 'Sign in with Google',
                login_or: 'or',
                login_email_placeholder: 'Email',
                login_password_placeholder: 'Password',
                login_sign_in: 'Sign In',
                login_create_account: 'Create New Account',
                login_forgot_password: 'Forgot Password?',
                main_title: '🏜️ DESERT STORM',
                buildings_button: 'Buildings & Priorities',
                buildings_panel_title: 'Buildings & Priorities',
                map_coordinates: 'Map Coordinates',
                close: 'Close',
                buildings_intro: 'Update building slots and priorities. Total slots across all buildings must be 20 or less.',
                buildings_table_building: 'Building',
                buildings_table_slots: 'Slots',
                buildings_table_priority: 'Priority',
                slots_label: 'Slots: ',
                priority_label: 'Pri: ',
                reset_default: 'Reset to Default',
                save_changes: 'Save Changes',
                coord_picker_title: 'Map Coordinates Picker',
                coord_picker_help: 'Click on the map to set the position for the selected building. Coordinates update one by one.',
                coord_label_building: 'Building',
                coord_prompt_default: 'Click on the map to set coordinates.',
                coord_prev: 'Prev',
                coord_next: 'Next',
                coord_save: 'Save Coordinates',
                player_db_title: '📊 Player Database',
                upload_help: 'Upload your player data. Template headers start at row 10: Player Name, E1 Total Power(M), E1 Troops.',
                download_template: 'Download Template',
                upload_player_data: 'Upload Player Data',
                template_title: 'PLAYER DATABASE TEMPLATE',
                template_instructions: 'Instructions:',
                template_step1: '1. Fill Player Name column with exact names from game',
                template_step2: '2. Fill E1 Total Power(M) column with numeric value (e.g., 65.0)',
                template_step3: '3. Fill E1 Troops column with: Tank, Aero, or Missile',
                template_step4: '4. Upload this file to the system',
                template_step5: '5. Select teams in the web interface',
                template_header_player_name: 'Player Name',
                template_header_power: 'E1 Total Power(M)',
                template_header_troops: 'E1 Troops',
                template_sheet_name: 'Players',
                excel_header_building: 'Building',
                excel_header_priority: 'Priority',
                excel_header_player: 'Player',
                excel_sheet_name: 'Team {team}',
                select_teams_title: '⚔️ Select Teams',
                select_teams_help: 'Select players for Team A and Team B independently. Maximum 20 players per team.',
                team_a_label: 'Team A',
                team_b_label: 'Team B',
                team_count_suffix: '/20',
                search_placeholder: '🔍 Search player name...',
                troops_filter_all: 'All Troop Types',
                troops_filter_tank: 'Tank',
                troops_filter_aero: 'Aero',
                troops_filter_missile: 'Missile',
                sort_power_desc: 'Sort by Power (High to Low)',
                sort_power_asc: 'Sort by Power (Low to High)',
                sort_name_asc: 'Sort by Name (A-Z)',
                sort_name_desc: 'Sort by Name (Z-A)',
                clear_all_selections: 'Clear All Selections',
                table_header_player_name: 'Player Name',
                table_header_power: 'E1 Power (M)',
                table_header_troop: 'Troop Type',
                table_header_team_selection: 'Team Selection',
                download_map: 'Map',
                download_excel: 'Excel',
                generate_team_a: 'Generate Team A',
                generate_team_b: 'Generate Team B',
                team_a_button: 'Team A',
                team_b_button: 'Team B',
                clear_button: 'Clear',
                player_count: '{count} players stored',
                upload_hint: '(Click to expand if you need to update player data)',
                error_firebase_sdk_missing: '❌ Firebase SDK not loaded! Make sure you have internet connection.',
                error_xlsx_missing: '❌ XLSX library not loaded! Make sure you have internet connection.',
                error_firebase_module_missing: '❌ firebase-module.js not found! Make sure firebase-module.js is in the same folder as this HTML file.',
                error_loading_title: '❌ Error Loading Application',
                error_missing_firebase_line1: 'The firebase-module.js file is missing or not in the same folder as this HTML file.',
                error_missing_firebase_line2: 'Please ensure both files are in the same directory:',
                error_missing_firebase_file1: 'desert_storm_final.html',
                error_missing_firebase_file2: 'firebase-module.js',
                error_missing_firebase_line3: 'Then refresh the page.',
                error_firebase_not_loaded: 'Firebase not loaded. Please refresh the page.',
                error_sign_in_failed: 'Sign-in failed: {error}',
                error_enter_email_password: 'Please enter email and password',
                error_password_length: 'Password must be at least 6 characters',
                success_account_created: 'Account created! Check your email for verification.',
                error_sign_up_failed: 'Sign-up failed: {error}',
                error_enter_email: 'Please enter your email address',
                success_password_reset: 'Password reset email sent!',
                error_failed: 'Failed: {error}',
                confirm_create_account: 'Create new account with: {email}',
                confirm_sign_out: 'Sign out?',
                confirm_clear_all: 'Clear all team selections?',
                message_template_downloaded: '✅ Template downloaded! Headers start at row 10.',
                message_upload_processing: '⏳ Processing file...',
                message_upload_failed: '❌ Upload failed: {error}',
                buildings_slots_exceeded_saved: '❌ Total slots exceeded {max} in saved config. Reset to defaults.',
                buildings_slots_exceeded: '❌ Total slots cannot exceed {max}. Currently: {total}.',
                buildings_changes_not_saved: 'Firebase not loaded. Changes not saved.',
                buildings_saved: '✅ Buildings saved.',
                buildings_save_failed: '❌ Save failed: {error}',
                coord_no_buildings: 'No buildings available for coordinates.',
                coord_current: 'Current: x {x}, y {y}',
                coord_current_not_set: 'Current: not set',
                coord_select_prompt: 'Select coordinates for {name}',
                coord_map_not_loaded: 'Map image not loaded. Please verify desert-storm-map.png exists.',
                coord_changes_not_saved: 'Firebase not loaded. Changes not saved.',
                coord_saved: '✅ Coordinates saved.',
                coord_save_failed: '❌ Save failed: {error}',
                alert_total_slots_exceed: 'Total slots across all buildings cannot exceed {max}.',
                alert_select_at_least_one: 'Please select at least 1 player for Team {team}!',
                alert_max_players: 'Maximum 20 players per team! Currently selected: {count}',
                download_modal_title: 'Team {team} Downloads',
                download_modal_subtitle: 'Team {team} assignments are ready!',
                alert_no_assignments: 'No assignments generated yet! Click "Generate Team {team} Assignments" first.',
                message_excel_downloaded: '✅ Excel downloaded!',
                message_map_wait: '⏳ Waiting for map to load...',
                confirm_map_without_background: 'Map image is still loading. Generate without map background?',
                message_map_cancelled: '⚠️ Cancelled. Refresh page to retry loading map.',
                message_generating_map_no_bg: '🎨 Generating Team {team} map (no background)...',
                message_team_downloaded_list: '✅ Team {team} downloaded (list format - no map)',
                message_generating_map: '🎨 Generating Team {team} map...',
                message_team_map_downloaded: '✅ Team {team} map downloaded! ({drawnCount} players + {bombSquad} bomb squad)',
                error_generic: '❌ {error}',
                map_footer_text: 'Roam free, help others',
                onboarding_step: 'Step {current} of {total}',
                onboarding_skip: 'Skip tour',
                onboarding_step1_title: 'Download Template',
                onboarding_step1_desc: 'Start here — download the Excel template to prepare your player list.',
                onboarding_step2_title: 'Upload Players',
                onboarding_step2_desc: 'Upload your completed Excel file to load players into the database.',
                onboarding_step3_title: 'Select Team A',
                onboarding_step3_desc: 'Click "Team A" on each player you want on Team A (up to 20).',
                onboarding_step4_title: 'Select Team B',
                onboarding_step4_desc: 'Now click "Team B" on each player you want on Team B (up to 20).',
                onboarding_step5_title: 'Generate & Download',
                onboarding_step5_desc: 'You\'re all set! Click Generate to create assignments and download them.'
            },
            fr: {
                app_title: 'Desert Storm - Sélection des joueurs',
                login_title: '🏜️ Desert Storm',
                login_subtitle: 'Connectez-vous pour continuer',
                login_google: 'Se connecter avec Google',
                login_or: 'ou',
                login_email_placeholder: 'E-mail',
                login_password_placeholder: 'Mot de passe',
                login_sign_in: 'Se connecter',
                login_create_account: 'Créer un compte',
                login_forgot_password: 'Mot de passe oublié ?',
                main_title: '🏜️ DESERT STORM',
                buildings_button: 'Bâtiments & Priorités',
                buildings_panel_title: 'Bâtiments & Priorités',
                map_coordinates: 'Coordonnées de la carte',
                close: 'Fermer',
                buildings_intro: 'Mettez à jour les emplacements et priorités des bâtiments. Le total des emplacements doit être de 20 ou moins.',
                buildings_table_building: 'Bâtiment',
                buildings_table_slots: 'Emplacements',
                buildings_table_priority: 'Priorité',
                slots_label: 'Slots : ',
                priority_label: 'Prio : ',
                reset_default: 'Réinitialiser',
                save_changes: 'Enregistrer',
                coord_picker_title: 'Sélecteur de coordonnées',
                coord_picker_help: 'Cliquez sur la carte pour définir la position du bâtiment sélectionné. Les coordonnées se mettent à jour une par une.',
                coord_label_building: 'Bâtiment',
                coord_prompt_default: 'Cliquez sur la carte pour définir les coordonnées.',
                coord_prev: 'Préc',
                coord_next: 'Suiv',
                coord_save: 'Enregistrer les coordonnées',
                player_db_title: '📊 Base de joueurs',
                upload_help: 'Téléversez vos données de joueurs. Les en-têtes du modèle commencent à la ligne 10 : Nom du joueur, Puissance E1 (M), Troupes E1.',
                download_template: 'Télécharger le modèle',
                upload_player_data: 'Téléverser les données',
                template_title: 'MODÈLE DE BASE DE JOUEURS',
                template_instructions: 'Instructions :',
                template_step1: '1. Renseignez la colonne Nom du joueur avec les noms exacts du jeu',
                template_step2: '2. Renseignez la colonne Puissance E1 (M) avec une valeur numérique (ex. 65.0)',
                template_step3: '3. Renseignez la colonne Troupes E1 avec : Tank, Aéro ou Missile',
                template_step4: '4. Téléversez ce fichier dans le système',
                template_step5: '5. Sélectionnez les équipes dans l\'interface web',
                template_header_player_name: 'Nom du joueur',
                template_header_power: 'Puissance E1 (M)',
                template_header_troops: 'Troupes E1',
                template_sheet_name: 'Joueurs',
                excel_header_building: 'Bâtiment',
                excel_header_priority: 'Priorité',
                excel_header_player: 'Joueur',
                excel_sheet_name: 'Équipe {team}',
                select_teams_title: '⚔️ Sélectionner les équipes',
                select_teams_help: 'Sélectionnez des joueurs pour les équipes A et B indépendamment. Maximum 20 joueurs par équipe.',
                team_a_label: 'Équipe A',
                team_b_label: 'Équipe B',
                team_count_suffix: '/20',
                search_placeholder: '🔍 Rechercher un joueur...',
                troops_filter_all: 'Tous les types',
                troops_filter_tank: 'Tank',
                troops_filter_aero: 'Aéro',
                troops_filter_missile: 'Missile',
                sort_power_desc: 'Trier par puissance (décroissant)',
                sort_power_asc: 'Trier par puissance (croissant)',
                sort_name_asc: 'Trier par nom (A-Z)',
                sort_name_desc: 'Trier par nom (Z-A)',
                clear_all_selections: 'Tout effacer',
                table_header_player_name: 'Nom du joueur',
                table_header_power: 'Puissance E1 (M)',
                table_header_troop: 'Type de troupe',
                table_header_team_selection: 'Sélection d\'équipe',
                download_map: 'Carte',
                download_excel: 'Excel',
                generate_team_a: 'Générer l\'équipe A',
                generate_team_b: 'Générer l\'équipe B',
                team_a_button: 'Équipe A',
                team_b_button: 'Équipe B',
                clear_button: 'Effacer',
                player_count: '{count} joueurs enregistrés',
                upload_hint: '(Cliquez pour développer si vous devez mettre à jour les données)',
                error_firebase_sdk_missing: '❌ SDK Firebase non chargé ! Vérifiez votre connexion Internet.',
                error_xlsx_missing: '❌ Bibliothèque XLSX non chargée ! Vérifiez votre connexion Internet.',
                error_firebase_module_missing: '❌ firebase-module.js introuvable ! Assurez-vous qu\'il est dans le même dossier que ce fichier HTML.',
                error_loading_title: '❌ Erreur de chargement de l\'application',
                error_missing_firebase_line1: 'Le fichier firebase-module.js est manquant ou pas dans le même dossier que ce fichier HTML.',
                error_missing_firebase_line2: 'Veuillez vous assurer que les deux fichiers sont dans le même répertoire :',
                error_missing_firebase_file1: 'desert_storm_final.html',
                error_missing_firebase_file2: 'firebase-module.js',
                error_missing_firebase_line3: 'Puis actualisez la page.',
                error_firebase_not_loaded: 'Firebase non chargé. Veuillez actualiser la page.',
                error_sign_in_failed: 'Échec de connexion : {error}',
                error_enter_email_password: 'Veuillez saisir l\'e-mail et le mot de passe',
                error_password_length: 'Le mot de passe doit contenir au moins 6 caractères',
                success_account_created: 'Compte créé ! Vérifiez votre e-mail pour la confirmation.',
                error_sign_up_failed: 'Échec de l\'inscription : {error}',
                error_enter_email: 'Veuillez saisir votre adresse e-mail',
                success_password_reset: 'E-mail de réinitialisation envoyé !',
                error_failed: 'Échec : {error}',
                confirm_create_account: 'Créer un compte avec : {email}',
                confirm_sign_out: 'Se déconnecter ?',
                confirm_clear_all: 'Effacer toutes les sélections d\'équipe ?',
                message_template_downloaded: '✅ Modèle téléchargé ! Les en-têtes commencent à la ligne 10.',
                message_upload_processing: '⏳ Traitement du fichier...',
                message_upload_failed: '❌ Échec du téléversement : {error}',
                buildings_slots_exceeded_saved: '❌ Le total des emplacements dépasse {max} dans la config enregistrée. Réinitialisé aux valeurs par défaut.',
                buildings_slots_exceeded: '❌ Le total des emplacements ne peut pas dépasser {max}. Actuel : {total}.',
                buildings_changes_not_saved: 'Firebase non chargé. Modifications non enregistrées.',
                buildings_saved: '✅ Bâtiments enregistrés.',
                buildings_save_failed: '❌ Échec de l\'enregistrement : {error}',
                coord_no_buildings: 'Aucun bâtiment disponible pour les coordonnées.',
                coord_current: 'Actuel : x {x}, y {y}',
                coord_current_not_set: 'Actuel : non défini',
                coord_select_prompt: 'Sélectionnez les coordonnées pour {name}',
                coord_map_not_loaded: 'Image de carte non chargée. Vérifiez que desert-storm-map.png existe.',
                coord_changes_not_saved: 'Firebase non chargé. Modifications non enregistrées.',
                coord_saved: '✅ Coordonnées enregistrées.',
                coord_save_failed: '❌ Échec de l\'enregistrement : {error}',
                alert_total_slots_exceed: 'Le total des emplacements ne peut pas dépasser {max}.',
                alert_select_at_least_one: 'Veuillez sélectionner au moins 1 joueur pour l\'équipe {team} !',
                alert_max_players: 'Maximum 20 joueurs par équipe ! Actuel : {count}',
                download_modal_title: 'Téléchargements équipe {team}',
                download_modal_subtitle: 'Les affectations de l\'équipe {team} sont prêtes !',
                alert_no_assignments: 'Aucune affectation générée ! Cliquez d\'abord sur « Générer l\'équipe {team} ».',
                message_excel_downloaded: '✅ Excel téléchargé !',
                message_map_wait: '⏳ En attente du chargement de la carte...',
                confirm_map_without_background: 'L\'image de la carte charge encore. Générer sans fond ?',
                message_map_cancelled: '⚠️ Annulé. Actualisez la page pour réessayer.',
                message_generating_map_no_bg: '🎨 Génération de la carte de l\'équipe {team} (sans fond)...',
                message_team_downloaded_list: '✅ Équipe {team} téléchargée (liste, sans carte)',
                message_generating_map: '🎨 Génération de la carte de l\'équipe {team}...',
                message_team_map_downloaded: '✅ Carte de l\'équipe {team} téléchargée ! ({drawnCount} joueurs + {bombSquad} bomb squad)',
                error_generic: '❌ {error}',
                map_footer_text: 'Soyez libres, aidez les autres',
                onboarding_step: 'Étape {current} sur {total}',
                onboarding_skip: 'Ignorer la visite',
                onboarding_step1_title: 'Télécharger le modèle',
                onboarding_step1_desc: 'Commencez ici — téléchargez le modèle Excel pour préparer votre liste de joueurs.',
                onboarding_step2_title: 'Télécharger les joueurs',
                onboarding_step2_desc: 'Téléchargez votre fichier Excel complété pour charger les joueurs dans la base de données.',
                onboarding_step3_title: 'Sélectionner l\'Équipe A',
                onboarding_step3_desc: 'Cliquez sur « Équipe A » pour chaque joueur que vous souhaitez dans l\'Équipe A (jusqu\'à 20).',
                onboarding_step4_title: 'Sélectionner l\'Équipe B',
                onboarding_step4_desc: 'Cliquez maintenant sur « Équipe B » pour chaque joueur que vous souhaitez dans l\'Équipe B (jusqu\'à 20).',
                onboarding_step5_title: 'Générer & Télécharger',
                onboarding_step5_desc: 'Vous êtes prêt ! Cliquez sur Générer pour créer les attributions et les télécharger.'
            },
            de: {
                app_title: 'Desert Storm – Spielerauswahl',
                login_title: '🏜️ Desert Storm',
                login_subtitle: 'Bitte anmelden, um fortzufahren',
                login_google: 'Mit Google anmelden',
                login_or: 'oder',
                login_email_placeholder: 'E-Mail',
                login_password_placeholder: 'Passwort',
                login_sign_in: 'Anmelden',
                login_create_account: 'Neues Konto erstellen',
                login_forgot_password: 'Passwort vergessen?',
                main_title: '🏜️ DESERT STORM',
                buildings_button: 'Gebäude & Prioritäten',
                buildings_panel_title: 'Gebäude & Prioritäten',
                map_coordinates: 'Kartenkoordinaten',
                close: 'Schließen',
                buildings_intro: 'Gebäudeslots und Prioritäten aktualisieren. Gesamtslots über alle Gebäude müssen 20 oder weniger sein.',
                buildings_table_building: 'Gebäude',
                buildings_table_slots: 'Slots',
                buildings_table_priority: 'Priorität',
                slots_label: 'Slots: ',
                priority_label: 'Prio: ',
                reset_default: 'Zurücksetzen',
                save_changes: 'Änderungen speichern',
                coord_picker_title: 'Koordinaten-Auswahl',
                coord_picker_help: 'Klicken Sie auf die Karte, um die Position des ausgewählten Gebäudes festzulegen. Die Koordinaten werden nacheinander aktualisiert.',
                coord_label_building: 'Gebäude',
                coord_prompt_default: 'Klicken Sie auf die Karte, um Koordinaten festzulegen.',
                coord_prev: 'Zurück',
                coord_next: 'Weiter',
                coord_save: 'Koordinaten speichern',
                player_db_title: '📊 Spielerdatenbank',
                upload_help: 'Laden Sie Ihre Spielerdaten hoch. Vorlagenköpfe beginnen in Zeile 10: Spielername, E1 Power (M), E1 Truppen.',
                download_template: 'Vorlage herunterladen',
                upload_player_data: 'Spielerdaten hochladen',
                template_title: 'SPIELERDATENBANK-VORLAGE',
                template_instructions: 'Anleitung:',
                template_step1: '1. Spalte Spielername mit den exakten Namen aus dem Spiel füllen',
                template_step2: '2. Spalte E1 Power (M) mit numerischem Wert füllen (z. B. 65.0)',
                template_step3: '3. Spalte E1 Truppen mit: Panzer, Aero oder Rakete füllen',
                template_step4: '4. Diese Datei in das System hochladen',
                template_step5: '5. Teams in der Weboberfläche auswählen',
                template_header_player_name: 'Spielername',
                template_header_power: 'E1 Power (M)',
                template_header_troops: 'E1 Truppen',
                template_sheet_name: 'Spieler',
                excel_header_building: 'Gebäude',
                excel_header_priority: 'Priorität',
                excel_header_player: 'Spieler',
                excel_sheet_name: 'Team {team}',
                select_teams_title: '⚔️ Teams auswählen',
                select_teams_help: 'Wählen Sie Spieler für Team A und Team B unabhängig aus. Maximal 20 Spieler pro Team.',
                team_a_label: 'Team A',
                team_b_label: 'Team B',
                team_count_suffix: '/20',
                search_placeholder: '🔍 Spielernamen suchen...',
                troops_filter_all: 'Alle Truppentypen',
                troops_filter_tank: 'Panzer',
                troops_filter_aero: 'Aero',
                troops_filter_missile: 'Rakete',
                sort_power_desc: 'Nach Power sortieren (hoch → niedrig)',
                sort_power_asc: 'Nach Power sortieren (niedrig → hoch)',
                sort_name_asc: 'Nach Name sortieren (A–Z)',
                sort_name_desc: 'Nach Name sortieren (Z–A)',
                clear_all_selections: 'Alle Auswahlen löschen',
                table_header_player_name: 'Spielername',
                table_header_power: 'E1 Power (M)',
                table_header_troop: 'Truppentyp',
                table_header_team_selection: 'Team-Auswahl',
                download_map: 'Karte',
                download_excel: 'Excel',
                generate_team_a: 'Team A generieren',
                generate_team_b: 'Team B generieren',
                team_a_button: 'Team A',
                team_b_button: 'Team B',
                clear_button: 'Löschen',
                player_count: '{count} Spieler gespeichert',
                upload_hint: '(Zum Erweitern klicken, wenn Sie Spielerdaten aktualisieren müssen)',
                error_firebase_sdk_missing: '❌ Firebase SDK nicht geladen! Bitte Internetverbindung prüfen.',
                error_xlsx_missing: '❌ XLSX-Bibliothek nicht geladen! Bitte Internetverbindung prüfen.',
                error_firebase_module_missing: '❌ firebase-module.js nicht gefunden! Stellen Sie sicher, dass es im selben Ordner wie diese HTML-Datei liegt.',
                error_loading_title: '❌ Fehler beim Laden der Anwendung',
                error_missing_firebase_line1: 'Die Datei firebase-module.js fehlt oder befindet sich nicht im selben Ordner wie diese HTML-Datei.',
                error_missing_firebase_line2: 'Bitte stellen Sie sicher, dass beide Dateien im selben Verzeichnis liegen:',
                error_missing_firebase_file1: 'desert_storm_final.html',
                error_missing_firebase_file2: 'firebase-module.js',
                error_missing_firebase_line3: 'Dann Seite neu laden.',
                error_firebase_not_loaded: 'Firebase nicht geladen. Bitte Seite aktualisieren.',
                error_sign_in_failed: 'Anmeldung fehlgeschlagen: {error}',
                error_enter_email_password: 'Bitte E-Mail und Passwort eingeben',
                error_password_length: 'Passwort muss mindestens 6 Zeichen haben',
                success_account_created: 'Konto erstellt! Bitte E-Mail zur Bestätigung prüfen.',
                error_sign_up_failed: 'Registrierung fehlgeschlagen: {error}',
                error_enter_email: 'Bitte E-Mail-Adresse eingeben',
                success_password_reset: 'Passwort-Reset-E-Mail gesendet!',
                error_failed: 'Fehlgeschlagen: {error}',
                confirm_create_account: 'Neues Konto erstellen mit: {email}',
                confirm_sign_out: 'Abmelden?',
                confirm_clear_all: 'Alle Teamauswahlen löschen?',
                message_template_downloaded: '✅ Vorlage heruntergeladen! Kopfzeilen beginnen in Zeile 10.',
                message_upload_processing: '⏳ Datei wird verarbeitet...',
                message_upload_failed: '❌ Upload fehlgeschlagen: {error}',
                buildings_slots_exceeded_saved: '❌ Gesamtslots überschreiten {max} in der gespeicherten Konfiguration. Auf Standard zurückgesetzt.',
                buildings_slots_exceeded: '❌ Gesamtslots dürfen {max} nicht überschreiten. Aktuell: {total}.',
                buildings_changes_not_saved: 'Firebase nicht geladen. Änderungen nicht gespeichert.',
                buildings_saved: '✅ Gebäude gespeichert.',
                buildings_save_failed: '❌ Speichern fehlgeschlagen: {error}',
                coord_no_buildings: 'Keine Gebäude für Koordinaten verfügbar.',
                coord_current: 'Aktuell: x {x}, y {y}',
                coord_current_not_set: 'Aktuell: nicht gesetzt',
                coord_select_prompt: 'Koordinaten für {name} auswählen',
                coord_map_not_loaded: 'Kartenbild nicht geladen. Bitte prüfen, ob desert-storm-map.png vorhanden ist.',
                coord_changes_not_saved: 'Firebase nicht geladen. Änderungen nicht gespeichert.',
                coord_saved: '✅ Koordinaten gespeichert.',
                coord_save_failed: '❌ Speichern fehlgeschlagen: {error}',
                alert_total_slots_exceed: 'Gesamtslots über alle Gebäude dürfen {max} nicht überschreiten.',
                alert_select_at_least_one: 'Bitte mindestens 1 Spieler für Team {team} auswählen!',
                alert_max_players: 'Maximal 20 Spieler pro Team! Aktuell ausgewählt: {count}',
                download_modal_title: 'Team {team} Downloads',
                download_modal_subtitle: 'Team-{team}-Zuweisungen sind bereit!',
                alert_no_assignments: 'Keine Zuweisungen erzeugt! Klicken Sie zuerst auf „Team {team} generieren“.',
                message_excel_downloaded: '✅ Excel heruntergeladen!',
                message_map_wait: '⏳ Warte auf das Laden der Karte...',
                confirm_map_without_background: 'Kartenbild lädt noch. Ohne Hintergrund generieren?',
                message_map_cancelled: '⚠️ Abgebrochen. Seite neu laden, um erneut zu versuchen.',
                message_generating_map_no_bg: '🎨 Team-{team}-Karte wird generiert (ohne Hintergrund)...',
                message_team_downloaded_list: '✅ Team {team} heruntergeladen (Listenformat – ohne Karte)',
                message_generating_map: '🎨 Team-{team}-Karte wird generiert...',
                message_team_map_downloaded: '✅ Team-{team}-Karte heruntergeladen! ({drawnCount} Spieler + {bombSquad} Bomb Squad)',
                error_generic: '❌ {error}',
                map_footer_text: 'Frei umherziehen, anderen helfen',
                onboarding_step: 'Schritt {current} von {total}',
                onboarding_skip: 'Tour überspringen',
                onboarding_step1_title: 'Vorlage herunterladen',
                onboarding_step1_desc: 'Beginnen Sie hier — laden Sie die Excel-Vorlage herunter, um Ihre Spielerliste vorzubereiten.',
                onboarding_step2_title: 'Spieler hochladen',
                onboarding_step2_desc: 'Laden Sie Ihre ausgefüllte Excel-Datei hoch, um Spieler in die Datenbank zu laden.',
                onboarding_step3_title: 'Team A auswählen',
                onboarding_step3_desc: 'Klicken Sie auf „Team A" für jeden Spieler, den Sie in Team A haben möchten (bis zu 20).',
                onboarding_step4_title: 'Team B auswählen',
                onboarding_step4_desc: 'Klicken Sie jetzt auf „Team B" für jeden Spieler, den Sie in Team B haben möchten (bis zu 20).',
                onboarding_step5_title: 'Generieren & Herunterladen',
                onboarding_step5_desc: 'Sie sind bereit! Klicken Sie auf Generieren, um Zuweisungen zu erstellen und herunterzuladen.'
            },
            it: {
                app_title: 'Desert Storm - Selezione giocatori',
                login_title: '🏜️ Desert Storm',
                login_subtitle: 'Accedi per continuare',
                login_google: 'Accedi con Google',
                login_or: 'oppure',
                login_email_placeholder: 'Email',
                login_password_placeholder: 'Password',
                login_sign_in: 'Accedi',
                login_create_account: 'Crea nuovo account',
                login_forgot_password: 'Password dimenticata?',
                main_title: '🏜️ DESERT STORM',
                buildings_button: 'Edifici e Priorità',
                buildings_panel_title: 'Edifici e Priorità',
                map_coordinates: 'Coordinate mappa',
                close: 'Chiudi',
                buildings_intro: 'Aggiorna slot e priorità degli edifici. Il totale degli slot deve essere 20 o meno.',
                buildings_table_building: 'Edificio',
                buildings_table_slots: 'Slot',
                buildings_table_priority: 'Priorità',
                slots_label: 'Slot: ',
                priority_label: 'Prio: ',
                reset_default: 'Ripristina predefiniti',
                save_changes: 'Salva modifiche',
                coord_picker_title: 'Selettore coordinate mappa',
                coord_picker_help: 'Clicca sulla mappa per impostare la posizione dell\'edificio selezionato. Le coordinate si aggiornano una per volta.',
                coord_label_building: 'Edificio',
                coord_prompt_default: 'Clicca sulla mappa per impostare le coordinate.',
                coord_prev: 'Prec',
                coord_next: 'Succ',
                coord_save: 'Salva coordinate',
                player_db_title: '📊 Database giocatori',
                upload_help: 'Carica i dati dei giocatori. Le intestazioni del modello iniziano alla riga 10: Nome giocatore, Potenza E1 (M), Truppe E1.',
                download_template: 'Scarica modello',
                upload_player_data: 'Carica dati giocatori',
                template_title: 'MODELLO DATABASE GIOCATORI',
                template_instructions: 'Istruzioni:',
                template_step1: '1. Compila la colonna Nome giocatore con i nomi esatti del gioco',
                template_step2: '2. Compila la colonna Potenza E1 (M) con un valore numerico (es. 65.0)',
                template_step3: '3. Compila la colonna Truppe E1 con: Carro, Aereo o Missile',
                template_step4: '4. Carica questo file nel sistema',
                template_step5: '5. Seleziona le squadre nell\'interfaccia web',
                template_header_player_name: 'Nome giocatore',
                template_header_power: 'Potenza E1 (M)',
                template_header_troops: 'Truppe E1',
                template_sheet_name: 'Giocatori',
                excel_header_building: 'Edificio',
                excel_header_priority: 'Priorità',
                excel_header_player: 'Giocatore',
                excel_sheet_name: 'Squadra {team}',
                select_teams_title: '⚔️ Seleziona squadre',
                select_teams_help: 'Seleziona i giocatori per Team A e Team B indipendentemente. Massimo 20 giocatori per team.',
                team_a_label: 'Team A',
                team_b_label: 'Team B',
                team_count_suffix: '/20',
                search_placeholder: '🔍 Cerca nome giocatore...',
                troops_filter_all: 'Tutti i tipi di truppa',
                troops_filter_tank: 'Carro',
                troops_filter_aero: 'Aereo',
                troops_filter_missile: 'Missile',
                sort_power_desc: 'Ordina per potenza (alta → bassa)',
                sort_power_asc: 'Ordina per potenza (bassa → alta)',
                sort_name_asc: 'Ordina per nome (A-Z)',
                sort_name_desc: 'Ordina per nome (Z-A)',
                clear_all_selections: 'Cancella tutte le selezioni',
                table_header_player_name: 'Nome giocatore',
                table_header_power: 'Potenza E1 (M)',
                table_header_troop: 'Tipo di truppa',
                table_header_team_selection: 'Selezione team',
                download_map: 'Mappa',
                download_excel: 'Excel',
                generate_team_a: 'Genera Team A',
                generate_team_b: 'Genera Team B',
                team_a_button: 'Team A',
                team_b_button: 'Team B',
                clear_button: 'Cancella',
                player_count: '{count} giocatori memorizzati',
                upload_hint: '(Clicca per espandere se devi aggiornare i dati dei giocatori)',
                error_firebase_sdk_missing: '❌ Firebase SDK non caricato! Verifica la connessione Internet.',
                error_xlsx_missing: '❌ Libreria XLSX non caricata! Verifica la connessione Internet.',
                error_firebase_module_missing: '❌ firebase-module.js non trovato! Assicurati che sia nella stessa cartella di questo file HTML.',
                error_loading_title: '❌ Errore durante il caricamento dell\'applicazione',
                error_missing_firebase_line1: 'Il file firebase-module.js manca o non è nella stessa cartella di questo file HTML.',
                error_missing_firebase_line2: 'Assicurati che entrambi i file siano nella stessa directory:',
                error_missing_firebase_file1: 'desert_storm_final.html',
                error_missing_firebase_file2: 'firebase-module.js',
                error_missing_firebase_line3: 'Poi aggiorna la pagina.',
                error_firebase_not_loaded: 'Firebase non caricato. Aggiorna la pagina.',
                error_sign_in_failed: 'Accesso non riuscito: {error}',
                error_enter_email_password: 'Inserisci email e password',
                error_password_length: 'La password deve avere almeno 6 caratteri',
                success_account_created: 'Account creato! Controlla l\'email per la verifica.',
                error_sign_up_failed: 'Registrazione non riuscita: {error}',
                error_enter_email: 'Inserisci il tuo indirizzo email',
                success_password_reset: 'Email di reset inviata!',
                error_failed: 'Errore: {error}',
                confirm_create_account: 'Creare un nuovo account con: {email}',
                confirm_sign_out: 'Vuoi uscire?',
                confirm_clear_all: 'Cancellare tutte le selezioni del team?',
                message_template_downloaded: '✅ Modello scaricato! Le intestazioni iniziano alla riga 10.',
                message_upload_processing: '⏳ Elaborazione file...',
                message_upload_failed: '❌ Caricamento non riuscito: {error}',
                buildings_slots_exceeded_saved: '❌ Il totale degli slot supera {max} nella configurazione salvata. Ripristinato ai valori predefiniti.',
                buildings_slots_exceeded: '❌ Il totale degli slot non può superare {max}. Attuale: {total}.',
                buildings_changes_not_saved: 'Firebase non caricato. Modifiche non salvate.',
                buildings_saved: '✅ Edifici salvati.',
                buildings_save_failed: '❌ Salvataggio non riuscito: {error}',
                coord_no_buildings: 'Nessun edificio disponibile per le coordinate.',
                coord_current: 'Attuale: x {x}, y {y}',
                coord_current_not_set: 'Attuale: non impostato',
                coord_select_prompt: 'Seleziona coordinate per {name}',
                coord_map_not_loaded: 'Immagine mappa non caricata. Verifica che desert-storm-map.png esista.',
                coord_changes_not_saved: 'Firebase non caricato. Modifiche non salvate.',
                coord_saved: '✅ Coordinate salvate.',
                coord_save_failed: '❌ Salvataggio non riuscito: {error}',
                alert_total_slots_exceed: 'Il totale degli slot in tutti gli edifici non può superare {max}.',
                alert_select_at_least_one: 'Seleziona almeno 1 giocatore per Team {team}!',
                alert_max_players: 'Massimo 20 giocatori per team! Attualmente selezionati: {count}',
                download_modal_title: 'Download Team {team}',
                download_modal_subtitle: 'Le assegnazioni del Team {team} sono pronte!',
                alert_no_assignments: 'Nessuna assegnazione generata! Clicca prima su "Genera Team {team}".',
                message_excel_downloaded: '✅ Excel scaricato!',
                message_map_wait: '⏳ In attesa del caricamento della mappa...',
                confirm_map_without_background: 'L\'immagine della mappa è ancora in caricamento. Generare senza sfondo?',
                message_map_cancelled: '⚠️ Annullato. Aggiorna la pagina per riprovare.',
                message_generating_map_no_bg: '🎨 Generazione mappa Team {team} (senza sfondo)...',
                message_team_downloaded_list: '✅ Team {team} scaricato (formato elenco - senza mappa)',
                message_generating_map: '🎨 Generazione mappa Team {team}...',
                message_team_map_downloaded: '✅ Mappa del Team {team} scaricata! ({drawnCount} giocatori + {bombSquad} bomb squad)',
                error_generic: '❌ {error}',
                map_footer_text: 'Muoviti liberamente, aiuta gli altri',
                onboarding_step: 'Passo {current} di {total}',
                onboarding_skip: 'Salta il tour',
                onboarding_step1_title: 'Scarica il modello',
                onboarding_step1_desc: 'Inizia qui — scarica il modello Excel per preparare la tua lista di giocatori.',
                onboarding_step2_title: 'Carica i giocatori',
                onboarding_step2_desc: 'Carica il tuo file Excel compilato per caricare i giocatori nel database.',
                onboarding_step3_title: 'Seleziona il Team A',
                onboarding_step3_desc: 'Clicca su «Team A» per ogni giocatore che vuoi nel Team A (fino a 20).',
                onboarding_step4_title: 'Seleziona il Team B',
                onboarding_step4_desc: 'Ora clicca su «Team B» per ogni giocatore che vuoi nel Team B (fino a 20).',
                onboarding_step5_title: 'Genera & Scarica',
                onboarding_step5_desc: 'Sei pronto! Clicca su Genera per creare le assegnazioni e scaricarle.'
            },
            ko: {
                app_title: 'Desert Storm - 플레이어 선택',
                login_title: '🏜️ Desert Storm',
                login_subtitle: '계속하려면 로그인하세요',
                login_google: 'Google로 로그인',
                login_or: '또는',
                login_email_placeholder: '이메일',
                login_password_placeholder: '비밀번호',
                login_sign_in: '로그인',
                login_create_account: '새 계정 만들기',
                login_forgot_password: '비밀번호를 잊으셨나요?',
                main_title: '🏜️ DESERT STORM',
                buildings_button: '건물 및 우선순위',
                buildings_panel_title: '건물 및 우선순위',
                map_coordinates: '지도 좌표',
                close: '닫기',
                buildings_intro: '건물 슬롯과 우선순위를 업데이트하세요. 모든 건물의 총 슬롯은 20 이하입니다.',
                buildings_table_building: '건물',
                buildings_table_slots: '슬롯',
                buildings_table_priority: '우선순위',
                slots_label: '슬롯: ',
                priority_label: '우선: ',
                reset_default: '기본값으로 재설정',
                save_changes: '변경사항 저장',
                coord_picker_title: '지도 좌표 선택기',
                coord_picker_help: '선택한 건물의 위치를 설정하려면 지도를 클릭하세요. 좌표는 하나씩 업데이트됩니다.',
                coord_label_building: '건물',
                coord_prompt_default: '좌표를 설정하려면 지도를 클릭하세요.',
                coord_prev: '이전',
                coord_next: '다음',
                coord_save: '좌표 저장',
                player_db_title: '📊 플레이어 데이터베이스',
                upload_help: '플레이어 데이터를 업로드하세요. 템플릿 헤더는 10행부터 시작합니다: 플레이어 이름, E1 전투력(M), E1 병종.',
                download_template: '템플릿 다운로드',
                upload_player_data: '플레이어 데이터 업로드',
                template_title: '플레이어 데이터베이스 템플릿',
                template_instructions: '사용 방법:',
                template_step1: '1. 플레이어 이름 열에 게임의 정확한 이름을 입력하세요',
                template_step2: '2. E1 전투력(M) 열에 숫자 값(예: 65.0)을 입력하세요',
                template_step3: '3. E1 병종 열에 탱크, 항공, 미사일 중 하나를 입력하세요',
                template_step4: '4. 이 파일을 시스템에 업로드하세요',
                template_step5: '5. 웹 인터페이스에서 팀을 선택하세요',
                template_header_player_name: '플레이어 이름',
                template_header_power: 'E1 전투력(M)',
                template_header_troops: 'E1 병종',
                template_sheet_name: '플레이어',
                excel_header_building: '건물',
                excel_header_priority: '우선순위',
                excel_header_player: '플레이어',
                excel_sheet_name: '팀 {team}',
                select_teams_title: '⚔️ 팀 선택',
                select_teams_help: '팀 A와 팀 B에 독립적으로 플레이어를 선택하세요. 팀당 최대 20명.',
                team_a_label: '팀 A',
                team_b_label: '팀 B',
                team_count_suffix: '/20',
                search_placeholder: '🔍 플레이어 이름 검색...',
                troops_filter_all: '모든 병종',
                troops_filter_tank: '탱크',
                troops_filter_aero: '항공',
                troops_filter_missile: '미사일',
                sort_power_desc: '전투력 순 (높음 → 낮음)',
                sort_power_asc: '전투력 순 (낮음 → 높음)',
                sort_name_asc: '이름 순 (A-Z)',
                sort_name_desc: '이름 순 (Z-A)',
                clear_all_selections: '모든 선택 해제',
                table_header_player_name: '플레이어 이름',
                table_header_power: 'E1 전투력 (M)',
                table_header_troop: '병종',
                table_header_team_selection: '팀 선택',
                download_map: '지도',
                download_excel: '엑셀',
                generate_team_a: '팀 A 생성',
                generate_team_b: '팀 B 생성',
                team_a_button: '팀 A',
                team_b_button: '팀 B',
                clear_button: '삭제',
                player_count: '저장된 플레이어 {count}명',
                upload_hint: '(플레이어 데이터를 업데이트하려면 클릭하여 확장)',
                error_firebase_sdk_missing: '❌ Firebase SDK를 불러오지 못했습니다! 인터넷 연결을 확인하세요.',
                error_xlsx_missing: '❌ XLSX 라이브러리를 불러오지 못했습니다! 인터넷 연결을 확인하세요.',
                error_firebase_module_missing: '❌ firebase-module.js를 찾을 수 없습니다! 이 HTML 파일과 같은 폴더에 있는지 확인하세요.',
                error_loading_title: '❌ 애플리케이션 로딩 오류',
                error_missing_firebase_line1: 'firebase-module.js 파일이 없거나 이 HTML 파일과 같은 폴더에 있지 않습니다.',
                error_missing_firebase_line2: '두 파일이 같은 디렉터리에 있는지 확인하세요:',
                error_missing_firebase_file1: 'desert_storm_final.html',
                error_missing_firebase_file2: 'firebase-module.js',
                error_missing_firebase_line3: '그 후 페이지를 새로고침하세요.',
                error_firebase_not_loaded: 'Firebase가 로드되지 않았습니다. 페이지를 새로고침하세요.',
                error_sign_in_failed: '로그인 실패: {error}',
                error_enter_email_password: '이메일과 비밀번호를 입력하세요',
                error_password_length: '비밀번호는 최소 6자 이상이어야 합니다',
                success_account_created: '계정이 생성되었습니다! 이메일을 확인하세요.',
                error_sign_up_failed: '회원가입 실패: {error}',
                error_enter_email: '이메일 주소를 입력하세요',
                success_password_reset: '비밀번호 재설정 이메일을 보냈습니다!',
                error_failed: '실패: {error}',
                confirm_create_account: '다음 이메일로 새 계정을 만들까요? {email}',
                confirm_sign_out: '로그아웃할까요?',
                confirm_clear_all: '모든 팀 선택을 지울까요?',
                message_template_downloaded: '✅ 템플릿 다운로드 완료! 헤더는 10행부터 시작합니다.',
                message_upload_processing: '⏳ 파일 처리 중...',
                message_upload_failed: '❌ 업로드 실패: {error}',
                buildings_slots_exceeded_saved: '❌ 저장된 설정의 총 슬롯이 {max}를 초과했습니다. 기본값으로 재설정했습니다.',
                buildings_slots_exceeded: '❌ 총 슬롯은 {max}를 초과할 수 없습니다. 현재: {total}.',
                buildings_changes_not_saved: 'Firebase가 로드되지 않았습니다. 변경 사항이 저장되지 않았습니다.',
                buildings_saved: '✅ 건물이 저장되었습니다.',
                buildings_save_failed: '❌ 저장 실패: {error}',
                coord_no_buildings: '좌표를 설정할 건물이 없습니다.',
                coord_current: '현재: x {x}, y {y}',
                coord_current_not_set: '현재: 설정되지 않음',
                coord_select_prompt: '{name}의 좌표를 선택하세요',
                coord_map_not_loaded: '지도 이미지를 불러오지 못했습니다. desert-storm-map.png가 있는지 확인하세요.',
                coord_changes_not_saved: 'Firebase가 로드되지 않았습니다. 변경 사항이 저장되지 않았습니다.',
                coord_saved: '✅ 좌표가 저장되었습니다.',
                coord_save_failed: '❌ 저장 실패: {error}',
                alert_total_slots_exceed: '모든 건물의 총 슬롯은 {max}를 초과할 수 없습니다.',
                alert_select_at_least_one: '팀 {team}에 최소 1명의 플레이어를 선택하세요!',
                alert_max_players: '팀당 최대 20명! 현재 선택: {count}',
                download_modal_title: '팀 {team} 다운로드',
                download_modal_subtitle: '팀 {team} 배치가 준비되었습니다!',
                alert_no_assignments: '아직 배치가 생성되지 않았습니다! 먼저 "팀 {team} 생성"을 클릭하세요.',
                message_excel_downloaded: '✅ 엑셀 다운로드 완료!',
                message_map_wait: '⏳ 지도 로드를 기다리는 중...',
                confirm_map_without_background: '지도 이미지가 아직 로드 중입니다. 배경 없이 생성할까요?',
                message_map_cancelled: '⚠️ 취소됨. 다시 시도하려면 페이지를 새로고침하세요.',
                message_generating_map_no_bg: '🎨 팀 {team} 지도 생성 중(배경 없음)...',
                message_team_downloaded_list: '✅ 팀 {team} 다운로드 완료(목록 형식 - 지도 없음)',
                message_generating_map: '🎨 팀 {team} 지도 생성 중...',
                message_team_map_downloaded: '✅ 팀 {team} 지도 다운로드 완료! ({drawnCount}명 + {bombSquad} 봄 스쿼드)',
                error_generic: '❌ {error}',
                map_footer_text: '자유롭게 이동하며 다른 사람을 도와주세요',
                onboarding_step: '{current}단계 / {total}단계',
                onboarding_skip: '튜토리얼 건너뛰기',
                onboarding_step1_title: '템플릿 다운로드',
                onboarding_step1_desc: '여기서 시작합니다 — 선수 목록을 준비하기 위해 Excel 템플릿을 다운로드합니다.',
                onboarding_step2_title: '선수 업로드',
                onboarding_step2_desc: '작성된 Excel 파일을 업로드하여 데이터베이스에 선수를 로드합니다.',
                onboarding_step3_title: 'A팀 선수 선택',
                onboarding_step3_desc: 'A팀에 원하는 선수마다 «A팀» 버튼을 클릭합니다 (최대 20명).',
                onboarding_step4_title: 'B팀 선수 선택',
                onboarding_step4_desc: '이제 B팀에 원하는 선수마다 «B팀» 버튼을 클릭합니다 (최대 20명).',
                onboarding_step5_title: '생성 및 다운로드',
                onboarding_step5_desc: '준비 완료! 생성 버튼을 클릭하여 배정을 생성하고 다운로드합니다.'
            },
            ro: {
                app_title: 'Desert Storm - Selecție jucători',
                login_title: '🏜️ Desert Storm',
                login_subtitle: 'Autentifică-te pentru a continua',
                login_google: 'Conectare cu Google',
                login_or: 'sau',
                login_email_placeholder: 'Email',
                login_password_placeholder: 'Parolă',
                login_sign_in: 'Autentificare',
                login_create_account: 'Creează cont nou',
                login_forgot_password: 'Ai uitat parola?',
                main_title: '🏜️ DESERT STORM',
                buildings_button: 'Clădiri și priorități',
                buildings_panel_title: 'Clădiri și priorități',
                map_coordinates: 'Coordonate hartă',
                close: 'Închide',
                buildings_intro: 'Actualizează sloturile și prioritățile clădirilor. Totalul sloturilor trebuie să fie 20 sau mai puțin.',
                buildings_table_building: 'Clădire',
                buildings_table_slots: 'Sloturi',
                buildings_table_priority: 'Prioritate',
                slots_label: 'Sloturi: ',
                priority_label: 'Prio: ',
                reset_default: 'Resetare la implicit',
                save_changes: 'Salvează modificările',
                coord_picker_title: 'Selector coordonate hartă',
                coord_picker_help: 'Apasă pe hartă pentru a seta poziția clădirii selectate. Coordonatele se actualizează pe rând.',
                coord_label_building: 'Clădire',
                coord_prompt_default: 'Apasă pe hartă pentru a seta coordonatele.',
                coord_prev: 'Înapoi',
                coord_next: 'Înainte',
                coord_save: 'Salvează coordonatele',
                player_db_title: '📊 Baza de date jucători',
                upload_help: 'Încarcă datele jucătorilor. Antetele șablonului încep la rândul 10: Nume jucător, Putere E1 (M), Trupe E1.',
                download_template: 'Descarcă șablon',
                upload_player_data: 'Încarcă datele jucătorilor',
                template_title: 'ȘABLON BAZĂ DE DATE JUCĂTORI',
                template_instructions: 'Instrucțiuni:',
                template_step1: '1. Completează coloana Nume jucător cu numele exacte din joc',
                template_step2: '2. Completează coloana Putere E1 (M) cu o valoare numerică (ex. 65.0)',
                template_step3: '3. Completează coloana Trupe E1 cu: Tanc, Aero sau Rachetă',
                template_step4: '4. Încarcă acest fișier în sistem',
                template_step5: '5. Selectează echipele în interfața web',
                template_header_player_name: 'Nume jucător',
                template_header_power: 'Putere E1 (M)',
                template_header_troops: 'Trupe E1',
                template_sheet_name: 'Jucători',
                excel_header_building: 'Clădire',
                excel_header_priority: 'Prioritate',
                excel_header_player: 'Jucător',
                excel_sheet_name: 'Echipa {team}',
                select_teams_title: '⚔️ Selectează echipele',
                select_teams_help: 'Selectează jucători pentru Echipa A și Echipa B independent. Maxim 20 de jucători per echipă.',
                team_a_label: 'Echipa A',
                team_b_label: 'Echipa B',
                team_count_suffix: '/20',
                search_placeholder: '🔍 Caută nume jucător...',
                troops_filter_all: 'Toate tipurile',
                troops_filter_tank: 'Tanc',
                troops_filter_aero: 'Aero',
                troops_filter_missile: 'Rachetă',
                sort_power_desc: 'Sortează după putere (mare → mică)',
                sort_power_asc: 'Sortează după putere (mică → mare)',
                sort_name_asc: 'Sortează după nume (A-Z)',
                sort_name_desc: 'Sortează după nume (Z-A)',
                clear_all_selections: 'Șterge toate selecțiile',
                table_header_player_name: 'Nume jucător',
                table_header_power: 'Putere E1 (M)',
                table_header_troop: 'Tip de trupă',
                table_header_team_selection: 'Selecție echipă',
                download_map: 'Hartă',
                download_excel: 'Excel',
                generate_team_a: 'Generează Echipa A',
                generate_team_b: 'Generează Echipa B',
                team_a_button: 'Echipa A',
                team_b_button: 'Echipa B',
                clear_button: 'Șterge',
                player_count: '{count} jucători salvați',
                upload_hint: '(Apasă pentru a extinde dacă trebuie să actualizezi datele jucătorilor)',
                error_firebase_sdk_missing: '❌ SDK Firebase neîncărcat! Verifică conexiunea la internet.',
                error_xlsx_missing: '❌ Biblioteca XLSX neîncărcată! Verifică conexiunea la internet.',
                error_firebase_module_missing: '❌ firebase-module.js nu a fost găsit! Asigură-te că este în același folder cu acest fișier HTML.',
                error_loading_title: '❌ Eroare la încărcarea aplicației',
                error_missing_firebase_line1: 'Fișierul firebase-module.js lipsește sau nu este în același folder cu acest fișier HTML.',
                error_missing_firebase_line2: 'Asigură-te că ambele fișiere sunt în același director:',
                error_missing_firebase_file1: 'desert_storm_final.html',
                error_missing_firebase_file2: 'firebase-module.js',
                error_missing_firebase_line3: 'Apoi reîmprospătează pagina.',
                error_firebase_not_loaded: 'Firebase nu este încărcat. Reîmprospătează pagina.',
                error_sign_in_failed: 'Autentificare eșuată: {error}',
                error_enter_email_password: 'Introdu emailul și parola',
                error_password_length: 'Parola trebuie să aibă cel puțin 6 caractere',
                success_account_created: 'Cont creat! Verifică emailul pentru confirmare.',
                error_sign_up_failed: 'Înregistrare eșuată: {error}',
                error_enter_email: 'Introdu adresa de email',
                success_password_reset: 'Email de resetare a parolei trimis!',
                error_failed: 'Eșuat: {error}',
                confirm_create_account: 'Creezi un cont nou cu: {email}',
                confirm_sign_out: 'Te deconectezi?',
                confirm_clear_all: 'Ștergi toate selecțiile de echipă?',
                message_template_downloaded: '✅ Șablon descărcat! Antetele încep la rândul 10.',
                message_upload_processing: '⏳ Se procesează fișierul...',
                message_upload_failed: '❌ Încărcare eșuată: {error}',
                buildings_slots_exceeded_saved: '❌ Totalul sloturilor depășește {max} în configurația salvată. Resetat la implicit.',
                buildings_slots_exceeded: '❌ Totalul sloturilor nu poate depăși {max}. Curent: {total}.',
                buildings_changes_not_saved: 'Firebase nu este încărcat. Modificările nu au fost salvate.',
                buildings_saved: '✅ Clădirile au fost salvate.',
                buildings_save_failed: '❌ Salvare eșuată: {error}',
                coord_no_buildings: 'Nu există clădiri disponibile pentru coordonate.',
                coord_current: 'Curent: x {x}, y {y}',
                coord_current_not_set: 'Curent: nesetat',
                coord_select_prompt: 'Selectează coordonatele pentru {name}',
                coord_map_not_loaded: 'Imaginea hărții nu s-a încărcat. Verifică dacă există desert-storm-map.png.',
                coord_changes_not_saved: 'Firebase nu este încărcat. Modificările nu au fost salvate.',
                coord_saved: '✅ Coordonate salvate.',
                coord_save_failed: '❌ Salvare eșuată: {error}',
                alert_total_slots_exceed: 'Totalul sloturilor pentru toate clădirile nu poate depăși {max}.',
                alert_select_at_least_one: 'Selectează cel puțin 1 jucător pentru Echipa {team}!',
                alert_max_players: 'Maxim 20 de jucători per echipă! Selectați: {count}',
                download_modal_title: 'Descărcări Echipa {team}',
                download_modal_subtitle: 'Atribuirile pentru Echipa {team} sunt gata!',
                alert_no_assignments: 'Nu există atribuiri generate încă! Apasă mai întâi pe „Generează Echipa {team}”.',
                message_excel_downloaded: '✅ Excel descărcat!',
                message_map_wait: '⏳ Se așteaptă încărcarea hărții...',
                confirm_map_without_background: 'Imaginea hărții încă se încarcă. Generezi fără fundal?',
                message_map_cancelled: '⚠️ Anulat. Reîmprospătează pagina pentru a reîncerca.',
                message_generating_map_no_bg: '🎨 Se generează harta Echipei {team} (fără fundal)...',
                message_team_downloaded_list: '✅ Echipa {team} descărcată (format listă - fără hartă)',
                message_generating_map: '🎨 Se generează harta Echipei {team}...',
                message_team_map_downloaded: '✅ Harta Echipei {team} descărcată! ({drawnCount} jucători + {bombSquad} bomb squad)',
                error_generic: '❌ {error}',
                map_footer_text: 'Explorați liber, ajutați-i pe alții',
                onboarding_step: 'Pasul {current} din {total}',
                onboarding_skip: 'Sari turneul',
                onboarding_step1_title: 'Descărcați șablonul',
                onboarding_step1_desc: 'Începeți aici — descărcați șablonul Excel pentru a pregăti lista de jucători.',
                onboarding_step2_title: 'Încărcați jucătorii',
                onboarding_step2_desc: 'Încărcați fișierul Excel completat pentru a încărca jucătorii în base de date.',
                onboarding_step3_title: 'Selectați Echipa A',
                onboarding_step3_desc: 'Faceți clic pe «Echipa A» pentru fiecare jucător pe care îl doriți în Echipa A (până la 20).',
                onboarding_step4_title: 'Selectați Echipa B',
                onboarding_step4_desc: 'Faceți clic pe «Echipa B» pentru fiecare jucător pe care îl doriți în Echipa B (până la 20).',
                onboarding_step5_title: 'Generați și Descărcați',
                onboarding_step5_desc: 'Sunteți gata! Faceți clic pe Generați pentru a crea atribuțiile și a le descărca.'
            }
        };

        const supportedLanguages = ['en', 'fr', 'de', 'it', 'ko', 'ro'];
        let currentLanguage = 'en';

        function interpolateText(text, params = {}) {
            return text.replace(/\{(\w+)\}/g, (match, key) => {
                if (Object.prototype.hasOwnProperty.call(params, key)) {
                    return params[key];
                }
                return match;
            });
        }

        function t(key, params) {
            const langPack = translations[currentLanguage] || translations.en;
            const fallback = translations.en[key] || key;
            const template = langPack[key] || fallback;
            return interpolateText(template, params);
        }

        function applyTranslations() {
            document.documentElement.lang = currentLanguage;
            document.title = t('app_title');
            document.querySelectorAll('[data-i18n]').forEach((element) => {
                element.textContent = t(element.dataset.i18n);
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach((element) => {
                element.setAttribute('placeholder', t(element.dataset.i18nPlaceholder));
            });
            refreshLanguageDependentText();
        }

        function refreshLanguageDependentText() {
            const playerCountEl = document.getElementById('playerCount');
            if (playerCountEl && typeof allPlayers !== 'undefined') {
                playerCountEl.textContent = t('player_count', { count: allPlayers.length });
            }
            const uploadHintEl = document.getElementById('uploadHint');
            if (uploadHintEl && typeof allPlayers !== 'undefined') {
                uploadHintEl.textContent = allPlayers.length > 0 ? t('upload_hint') : '';
            }
        }

        function setLanguage(lang) {
            if (!supportedLanguages.includes(lang)) {
                return;
            }
            currentLanguage = lang;
            try {
                localStorage.setItem('ds_language', lang);
            } catch (error) {
                console.warn('Unable to persist language preference', error);
            }
            applyTranslations();
            document.querySelectorAll('#languageSelect, #loginLanguageSelect').forEach((sel) => { sel.value = lang; });
            renderPlayersTable();
            renderBuildingsTable();
            updateTeamCounters();
            const coordOverlay = document.getElementById('coordPickerOverlay');
            if (coordOverlay && !coordOverlay.classList.contains('hidden')) {
                updateCoordLabel();
            }
            const downloadOverlay = document.getElementById('downloadModalOverlay');
            if (downloadOverlay && !downloadOverlay.classList.contains('hidden') && activeDownloadTeam) {
                const team = activeDownloadTeam;
                document.getElementById('downloadModalTitle').textContent = t('download_modal_title', { team: team });
                document.getElementById('downloadModalSubtitle').textContent = t('download_modal_subtitle', { team: team });
            }
            updateOnboardingTooltip();
        }

        function initLanguage() {
            let stored = null;
            try {
                stored = localStorage.getItem('ds_language');
            } catch (error) {
                stored = null;
            }
            currentLanguage = supportedLanguages.includes(stored) ? stored : 'en';
            applyTranslations();
            document.querySelectorAll('#languageSelect, #loginLanguageSelect').forEach((sel) => {
                sel.value = currentLanguage;
                sel.addEventListener('change', (event) => {
                    setLanguage(event.target.value);
                });
            });
        }

        // ============================================================
        // ONBOARDING TOUR
        // ============================================================
        const ONBOARDING_STEPS = [
            { titleKey: 'onboarding_step1_title', descKey: 'onboarding_step1_desc', targetSelector: '#downloadTemplateBtn',  position: 'bottom' },
            { titleKey: 'onboarding_step2_title', descKey: 'onboarding_step2_desc', targetSelector: '#uploadPlayerBtn',      position: 'bottom' },
            { titleKey: 'onboarding_step3_title', descKey: 'onboarding_step3_desc', targetSelector: '.counter.team-a',       position: 'bottom' },
            { titleKey: 'onboarding_step4_title', descKey: 'onboarding_step4_desc', targetSelector: '.counter.team-b',       position: 'bottom' },
            { titleKey: 'onboarding_step5_title', descKey: 'onboarding_step5_desc', targetSelector: '#floatingButtons',      position: 'top'    }
        ];

        let onboardingActive      = false;
        let currentOnboardingStep = 0;
        let pendingOnboardingStep = null;
        let currentHighlightTarget = null;

        function initOnboarding() {
            try {
                if (localStorage.getItem('ds_onboarding_done')) return;
            } catch (e) { return; }
            onboardingActive = true;
            currentOnboardingStep = 0;
            showOnboardingStep(0);
        }

        function showOnboardingStep(index) {
            if (index >= ONBOARDING_STEPS.length) {
                completeOnboarding();
                return;
            }
            const step   = ONBOARDING_STEPS[index];
            const target = document.querySelector(step.targetSelector);

            // Target not in DOM or hidden — defer until it appears
            if (!target || target.closest('.hidden') || getComputedStyle(target).display === 'none') {
                pendingOnboardingStep = index;
                return;
            }
            pendingOnboardingStep = null;
            currentOnboardingStep = index;

            // Remove previous highlight
            if (currentHighlightTarget) {
                currentHighlightTarget.classList.remove('onboarding-highlight');
            }
            currentHighlightTarget = target;
            target.classList.add('onboarding-highlight');

            // Populate tooltip text
            document.getElementById('onboardingStepLabel').textContent = t('onboarding_step', { current: index + 1, total: ONBOARDING_STEPS.length });
            document.getElementById('onboardingTitle').textContent      = t(step.titleKey);
            document.getElementById('onboardingDesc').textContent       = t(step.descKey);
            document.getElementById('onboardingSkip').textContent       = t('onboarding_skip');

            // Show and position
            const tooltip = document.getElementById('onboardingTooltip');
            tooltip.classList.remove('hidden');
            positionOnboardingTooltip();
        }

        function positionOnboardingTooltip() {
            const tooltip = document.getElementById('onboardingTooltip');
            if (!tooltip || tooltip.classList.contains('hidden')) return;

            const step   = ONBOARDING_STEPS[currentOnboardingStep];
            const target = document.querySelector(step.targetSelector);
            if (!target) return;

            const rect    = target.getBoundingClientRect();
            const tWidth  = tooltip.offsetWidth  || 280;
            const tHeight = tooltip.offsetHeight || 160;
            const vw      = window.innerWidth;
            const vh      = window.innerHeight;
            const gap     = 10;

            let place = step.position; // preferred: 'top' or 'bottom'

            // Flip if not enough room
            if (place === 'bottom' && rect.bottom + gap + tHeight > vh) place = 'top';
            if (place === 'top'    && rect.top    - gap - tHeight < 0)  place = 'bottom';

            let top, arrowOffset;
            if (place === 'bottom') {
                top = rect.bottom + gap;
                tooltip.setAttribute('data-arrow', 'top');
            } else {
                top = rect.top - gap - tHeight;
                tooltip.setAttribute('data-arrow', 'bottom');
            }

            // Horizontal: centre on target, clamp to viewport
            let left = rect.left + rect.width / 2 - tWidth / 2;
            left = Math.max(8, Math.min(left, vw - tWidth - 8));

            // Arrow horizontal offset (relative to tooltip left edge)
            arrowOffset = (rect.left + rect.width / 2) - left - 7; // 7 = half arrow width
            arrowOffset = Math.max(12, Math.min(arrowOffset, tWidth - 26));

            tooltip.style.top  = top  + 'px';
            tooltip.style.left = left + 'px';
            tooltip.style.setProperty('--arrow-offset', arrowOffset + 'px');
        }

        function dismissOnboardingStep() {
            if (!onboardingActive) return;
            // Remove highlight
            if (currentHighlightTarget) {
                currentHighlightTarget.classList.remove('onboarding-highlight');
                currentHighlightTarget = null;
            }
            // Hide tooltip
            document.getElementById('onboardingTooltip').classList.add('hidden');

            const next = currentOnboardingStep + 1;
            if (next >= ONBOARDING_STEPS.length) {
                completeOnboarding();
            } else {
                showOnboardingStep(next);
            }
        }

        function completeOnboarding() {
            onboardingActive = false;
            if (currentHighlightTarget) {
                currentHighlightTarget.classList.remove('onboarding-highlight');
                currentHighlightTarget = null;
            }
            document.getElementById('onboardingTooltip').classList.add('hidden');
            try { localStorage.setItem('ds_onboarding_done', 'true'); } catch (e) { /* ignore */ }
        }

        function updateOnboardingTooltip() {
            if (!onboardingActive) return;
            const step = ONBOARDING_STEPS[currentOnboardingStep];
            document.getElementById('onboardingStepLabel').textContent = t('onboarding_step', { current: currentOnboardingStep + 1, total: ONBOARDING_STEPS.length });
            document.getElementById('onboardingTitle').textContent      = t(step.titleKey);
            document.getElementById('onboardingDesc').textContent       = t(step.descKey);
            document.getElementById('onboardingSkip').textContent       = t('onboarding_skip');
        }

        // Keep tooltip pinned to target on scroll / resize
        window.addEventListener('scroll', () => { if (onboardingActive) positionOnboardingTooltip(); }, { passive: true });
        window.addEventListener('resize', () => { if (onboardingActive) positionOnboardingTooltip(); });

        // ── Dismiss event wiring (runs once DOM is ready) ──
        document.addEventListener('DOMContentLoaded', () => {
            // Step 1 — Download Template button
            document.getElementById('downloadTemplateBtn').addEventListener('click', () => {
                if (onboardingActive && currentOnboardingStep === 0) dismissOnboardingStep();
            });
            // Step 2 — Upload Player Data button
            document.getElementById('uploadPlayerBtn').addEventListener('click', () => {
                if (onboardingActive && currentOnboardingStep === 1) dismissOnboardingStep();
            });
            // Steps 3 & 4 — delegated on players table body
            document.getElementById('playersTableBody').addEventListener('click', (e) => {
                if (!onboardingActive) return;
                const btn = e.target.closest('button');
                if (!btn) return;
                if (currentOnboardingStep === 2 && btn.classList.contains('team-a-btn')) dismissOnboardingStep();
                if (currentOnboardingStep === 3 && btn.classList.contains('team-b-btn')) dismissOnboardingStep();
            });
            // Step 5 — floating generate buttons area
            document.getElementById('floatingButtons').addEventListener('click', () => {
                if (onboardingActive && currentOnboardingStep === 4) dismissOnboardingStep();
            });
            // Skip link
            document.getElementById('onboardingSkip').addEventListener('click', completeOnboarding);
        });

        // ============================================================
        // INITIALIZATION CHECK
        // ============================================================
        
        // Check if Firebase modules are loaded
        if (typeof firebase === 'undefined') {
            alert(t('error_firebase_sdk_missing'));
            console.error('Firebase SDK failed to load from CDN');
        }
        
        if (typeof XLSX === 'undefined') {
            alert(t('error_xlsx_missing'));
            console.error('XLSX library failed to load from CDN');
        }
        
        if (typeof FirebaseManager === 'undefined') {
            alert(t('error_firebase_module_missing'));
            console.error('FirebaseManager not defined - firebase-module.js not loaded');
        }
        
        // ============================================================
        // GLOBAL STATE
        // ============================================================
        
        let allPlayers = [];
        let teamSelections = {
            teamA: [],
            teamB: []
        };
        let assignmentsA = [];
        let assignmentsB = [];
        let mapLoaded = false;
        let uploadPanelExpanded = true;
        let activeDownloadTeam = null;
        
        // Load desert storm map
        // IMPORTANT: Put 'desert-storm-map.png' in the same folder as this HTML file
        const mapImage = new Image();
        let mapLoadRetries = 0;
        const maxRetries = 3;
        
        function loadMapImage() {
            return new Promise((resolve, reject) => {
                mapImage.onload = () => { 
                    mapLoaded = true; 
                    console.log('✅ Map loaded successfully');
                    resolve(true);
                };
                
                mapImage.onerror = () => {
                    console.error('❌ Map failed to load, attempt:', mapLoadRetries + 1);
                    
                    if (mapLoadRetries < maxRetries) {
                        mapLoadRetries++;
                        console.log('Retrying map load...');
                        setTimeout(() => {
                            mapImage.src = 'desert-storm-map.png?' + Date.now();
                        }, 1000 * mapLoadRetries);
                    } else {
                        alert(t('coord_map_not_loaded'));
                        console.error('Map loading failed after', maxRetries, 'attempts');
                        reject(false);
                    }
                };
                
                // Load local map file (no CORS issues!)
                mapImage.src = 'desert-storm-map.png';
            });
        }
        
        // Start loading map immediately
        loadMapImage().catch(() => {
            console.warn('Map failed to load, continuing without it');
        });
        
        // Building positions on the map (scaled for 1080px width from 2048x1446 original)
        const defaultBuildingPositions = {
            'Info Center': [242, 95],
            'Field Hospital 4': [474, 95],
            'Oil Refinery 1': [137, 190],
            'Field Hospital 2': [527, 179],
            'Oil Refinery 2': [580, 311],
            'Field Hospital 1': [153, 311],
            'Field Hospital 3': [200, 385],
            'Science Hub': [495, 395],
        };
        
        const buildingAnchors = {
            'Info Center': 'left',
            'Field Hospital 4': 'right',
            'Oil Refinery 1': 'left',
            'Field Hospital 2': 'right',
            'Oil Refinery 2': 'right',
            'Field Hospital 1': 'left',
            'Field Hospital 3': 'left',
            'Science Hub': 'right',
        };
        
        const textColors = { 1: '#8B0000', 2: '#B85C00', 3: '#006464', 4: '#006699', 5: '#226644', 6: '#556B2F' };
        const bgColors = { 1: 'rgba(255,230,230,0.9)', 2: 'rgba(255,240,220,0.9)', 3: 'rgba(230,255,250,0.9)', 
                          4: 'rgba(230,245,255,0.9)', 5: 'rgba(240,255,240,0.9)', 6: 'rgba(245,255,235,0.9)' };
        
        // Building definitions with priorities (total slots max 20)
        const defaultBuildings = [
            { name: 'Bomb Squad', priority: 1, slots: 4 },
            { name: 'Oil Refinery 1', priority: 3, slots: 2 },
            { name: 'Oil Refinery 2', priority: 3, slots: 2 },
            { name: 'Field Hospital 1', priority: 4, slots: 2 },
            { name: 'Field Hospital 2', priority: 4, slots: 2 },
            { name: 'Field Hospital 3', priority: 4, slots: 2 },
            { name: 'Field Hospital 4', priority: 4, slots: 2 },
            { name: 'Info Center', priority: 5, slots: 2 },
            { name: 'Science Hub', priority: 5, slots: 2 },
        ];
        const MAX_BUILDING_SLOTS_TOTAL = 20;
        const MIN_BUILDING_SLOTS = 0;

        let buildingConfig = defaultBuildings.map((b) => ({ ...b }));
        // Only store user-picked coordinates here; defaults are used as fallback for rendering.
        let buildingPositions = {};
        
        // ============================================================
        // FIREBASE INTEGRATION
        // ============================================================
        
        // Initialize Firebase only if FirebaseManager is available
        if (typeof FirebaseManager !== 'undefined') {
            FirebaseManager.setAuthCallback((isSignedIn, user) => {
                if (isSignedIn) {
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    document.getElementById('userEmail').textContent = user.email;
                    applyTranslations();
                    loadPlayerData();
                    initOnboarding();
                } else {
                    document.getElementById('loginScreen').style.display = 'block';
                    document.getElementById('mainApp').style.display = 'none';
                }
            });
            
            FirebaseManager.setDataLoadCallback((playerDatabase) => {
                console.log('Player database loaded:', Object.keys(playerDatabase).length, 'players');
                loadPlayerData();
                loadBuildingConfig();
                loadBuildingPositions();
            });
        } else {
            console.error('FirebaseManager not available - cannot initialize callbacks');
            // Show error message to user
            setTimeout(() => {
                const loginScreen = document.getElementById('loginScreen');
                if (loginScreen) {
                    loginScreen.innerHTML = `
                        <div style="max-width: 600px; margin: 100px auto; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <h1 style="text-align: center; color: #DC143C;">${t('error_loading_title')}</h1>
                            <p style="color: #333; text-align: center; margin: 20px 0;">${t('error_missing_firebase_line1')}</p>
                            <p style="color: #666; text-align: center; font-size: 14px;">${t('error_missing_firebase_line2')}</p>
                            <ul style="color: #666; margin: 20px 40px;">
                                <li>${t('error_missing_firebase_file1')}</li>
                                <li>${t('error_missing_firebase_file2')}</li>
                            </ul>
                            <p style="color: #666; text-align: center; font-size: 14px; margin-top: 20px;">${t('error_missing_firebase_line3')}</p>
                        </div>
                    `;
                    loginScreen.style.display = 'block';
                }
            }, 100);
        }
        
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(String(str)));
            return div.innerHTML;
        }

        function getTroopLabel(troop) {
            switch (troop) {
                case 'Tank':
                    return t('troops_filter_tank');
                case 'Aero':
                    return t('troops_filter_aero');
                case 'Missile':
                    return t('troops_filter_missile');
                default:
                    return troop;
            }
        }

        let googleSignInInProgress = false;

        async function handleGoogleSignIn() {
            if (googleSignInInProgress) {
                return;
            }
            if (typeof FirebaseManager === 'undefined') {
                alert(t('error_firebase_not_loaded'));
                return;
            }
            const btn = document.getElementById('googleSignInBtn');
            googleSignInInProgress = true;
            if (btn) {
                btn.disabled = true;
            }
            try {
                const result = await FirebaseManager.signInWithGoogle();
                if (!result.success) {
                    alert(t('error_sign_in_failed', { error: result.error }));
                }
            } finally {
                googleSignInInProgress = false;
                if (btn) {
                    btn.disabled = false;
                }
            }
        }
        
        async function handleEmailSignIn() {
            if (typeof FirebaseManager === 'undefined') {
                alert(t('error_firebase_not_loaded'));
                return;
            }
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            if (!email || !password) {
                alert(t('error_enter_email_password'));
                return;
            }
            const result = await FirebaseManager.signInWithEmail(email, password);
            if (!result.success) {
                alert(t('error_sign_in_failed', { error: result.error }));
            }
        }
        
        function showSignUpForm() {
            if (typeof FirebaseManager === 'undefined') {
                alert(t('error_firebase_not_loaded'));
                return;
            }
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            if (!email || !password) {
                alert(t('error_enter_email_password'));
                return;
            }
            if (password.length < 6) {
                alert(t('error_password_length'));
                return;
            }
            if (confirm(t('confirm_create_account', { email: email }))) {
                handleSignUp(email, password);
            }
        }
        
        async function handleSignUp(email, password) {
            if (typeof FirebaseManager === 'undefined') {
                alert(t('error_firebase_not_loaded'));
                return;
            }
            const result = await FirebaseManager.signUpWithEmail(email, password);
            if (result.success) {
                alert(t('success_account_created'));
            } else {
                alert(t('error_sign_up_failed', { error: result.error }));
            }
        }
        
        async function handlePasswordReset() {
            if (typeof FirebaseManager === 'undefined') {
                alert(t('error_firebase_not_loaded'));
                return;
            }
            const email = document.getElementById('emailInput').value;
            if (!email) {
                alert(t('error_enter_email'));
                return;
            }
            const result = await FirebaseManager.resetPassword(email);
            if (result.success) {
                alert(t('success_password_reset'));
            } else {
                alert(t('error_failed', { error: result.error }));
            }
        }
        
        async function handleSignOut() {
            if (typeof FirebaseManager === 'undefined') {
                alert(t('error_firebase_not_loaded'));
                return;
            }
            if (confirm(t('confirm_sign_out'))) {
                await FirebaseManager.signOut();
            }
        }
        
        // ============================================================
        // COLLAPSIBLE PANEL
        // ============================================================
        
        function toggleUploadPanel() {
            uploadPanelExpanded = !uploadPanelExpanded;
            const content = document.getElementById('uploadContent');
            const icon = document.getElementById('uploadExpandIcon');
            
            if (uploadPanelExpanded) {
                content.classList.remove('collapsed');
                icon.classList.add('rotated');
            } else {
                content.classList.add('collapsed');
                icon.classList.remove('rotated');
            }
        }
        
        // ============================================================
        // TEMPLATE GENERATION
        // ============================================================
        
        function downloadPlayerTemplate() {
            const wb = XLSX.utils.book_new();
            
            const instructions = [
                [t('template_title')],
                [''],
                [t('template_instructions')],
                [t('template_step1')],
                [t('template_step2')],
                [t('template_step3')],
                [t('template_step4')],
                [t('template_step5')],
                [''],
                [t('template_header_player_name'), t('template_header_power'), t('template_header_troops')]
            ];
            
            const examples = [
                ['Player1', 65.0, 'Tank'],
                ['Player2', 68.0, 'Aero'],
                ['Player3', 64.0, 'Missile'],
                ['', '', ''],
                ['', '', '']
            ];
            
            const data = [...instructions, ...examples];
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{wch: 25}, {wch: 20}, {wch: 15}];
            
            XLSX.utils.book_append_sheet(wb, ws, t('template_sheet_name'));
            XLSX.writeFile(wb, 'player_database_template.xlsx');
            
            showMessage('uploadMessage', t('message_template_downloaded'), 'success');
        }
        
        // ============================================================
        // PLAYER DATA MANAGEMENT
        // ============================================================
        
        async function uploadPlayerData() {
            if (typeof FirebaseManager === 'undefined') {
                showMessage('uploadMessage', t('error_firebase_not_loaded'), 'error');
                return;
            }
            
            const fileInput = document.getElementById('playerFileInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            showMessage('uploadMessage', t('message_upload_processing'), 'processing');
            
            try {
                // Use Firebase module's upload function which reads from row 10
                const result = await FirebaseManager.uploadPlayerDatabase(file);
                
                if (result.success) {
                    showMessage('uploadMessage', result.message, 'success');
                    loadPlayerData();
                } else {
                    showMessage('uploadMessage', t('message_upload_failed', { error: result.error }), 'error');
                }
            } catch (error) {
                showMessage('uploadMessage', t('message_upload_failed', { error: error.error || error.message }), 'error');
            }
            
            fileInput.value = '';
        }
        
        function loadPlayerData() {
            if (typeof FirebaseManager === 'undefined') {
                console.error('FirebaseManager not available');
                return;
            }
            
            const playerDB = FirebaseManager.getPlayerDatabase();
            const count = Object.keys(playerDB).length;
            
            document.getElementById('playerCount').textContent = t('player_count', { count: count });
            
            if (count > 0) {
                allPlayers = Object.keys(playerDB).map(name => ({
                    name: name,
                    power: playerDB[name].power,
                    troops: playerDB[name].troops
                }));
                
                // Collapse upload panel and show selection
                uploadPanelExpanded = false;
                document.getElementById('uploadContent').classList.add('collapsed');
                document.getElementById('uploadExpandIcon').classList.remove('rotated');
                document.getElementById('uploadHint').textContent = t('upload_hint');
                
                showSelectionInterface();
            } else {
                // Keep upload panel expanded
                uploadPanelExpanded = true;
                document.getElementById('uploadContent').classList.remove('collapsed');
                document.getElementById('uploadExpandIcon').classList.add('rotated');
                document.getElementById('uploadHint').textContent = '';
            }
        }
        
        function showSelectionInterface() {
            document.getElementById('selectionSection').classList.remove('hidden');
            document.getElementById('floatingButtons').style.display = 'flex';
            reserveSpaceForFooter();
            renderPlayersTable();
            updateTeamCounters();
            if (pendingOnboardingStep !== null) {
                const pending = pendingOnboardingStep;
                pendingOnboardingStep = null;
                showOnboardingStep(pending);
            }
        }

        function toggleBuildingsPanel() {
            const panel = document.getElementById('buildingsPanel');
            const opening = panel.classList.contains('hidden');
            panel.classList.toggle('hidden');
            if (opening) {
                loadBuildingConfig();
                loadBuildingPositions();
            } else {
                renderBuildingsTable();
            }
        }

        function getDefaultBuildings() {
            return defaultBuildings.map((b) => ({ ...b }));
        }

        function clampPriority(value, fallback) {
            const number = Number(value);
            if (!Number.isFinite(number)) {
                return fallback;
            }
            return Math.max(1, Math.min(6, Math.round(number)));
        }

        function clampSlots(value, fallback) {
            const number = Number(value);
            if (!Number.isFinite(number)) {
                return fallback;
            }
            return Math.max(MIN_BUILDING_SLOTS, Math.min(MAX_BUILDING_SLOTS_TOTAL, Math.round(number)));
        }

        function getBuildingSlotsTotal(config) {
            if (!Array.isArray(config)) {
                return 0;
            }
            return config.reduce((sum, item) => {
                const slots = Number(item && item.slots);
                return sum + (Number.isFinite(slots) ? slots : 0);
            }, 0);
        }

        function normalizeBuildingConfig(config) {
            if (!Array.isArray(config)) {
                return getDefaultBuildings();
            }
            return defaultBuildings.map((def) => {
                const stored = config.find((b) => b && b.name === def.name);
                const priority = clampPriority(stored && stored.priority, def.priority);
                const slots = clampSlots(stored && stored.slots, def.slots);
                return { name: def.name, slots: slots, priority: priority };
            });
        }

        function getDefaultBuildingPositions() {
            return JSON.parse(JSON.stringify(defaultBuildingPositions));
        }

        function normalizeBuildingPositions(positions) {
            const normalized = {};
            if (!positions || typeof positions !== 'object') {
                return normalized;
            }
            Object.keys(positions).forEach((name) => {
                const value = positions[name];
                if (Array.isArray(value) && value.length === 2) {
                    const x = Number(value[0]);
                    const y = Number(value[1]);
                    if (Number.isFinite(x) && Number.isFinite(y)) {
                        normalized[name] = [Math.round(x), Math.round(y)];
                    }
                }
            });
            return normalized;
        }

        function getEffectiveBuildingPositions() {
            return { ...getDefaultBuildingPositions(), ...buildingPositions };
        }

        function getEffectiveBuildingConfig() {
            return normalizeBuildingConfig(buildingConfig);
        }

        function loadBuildingConfig() {
            if (typeof FirebaseManager === 'undefined') {
                buildingConfig = getDefaultBuildings();
                renderBuildingsTable();
                return;
            }
            const stored = FirebaseManager.getBuildingConfig();
            buildingConfig = normalizeBuildingConfig(stored);
            const totalSlots = getBuildingSlotsTotal(buildingConfig);
            const slotsOverLimit = totalSlots > MAX_BUILDING_SLOTS_TOTAL;
            if (slotsOverLimit) {
                buildingConfig = getDefaultBuildings();
                showMessage('buildingsStatus', t('buildings_slots_exceeded_saved', { max: MAX_BUILDING_SLOTS_TOTAL }), 'error');
            }

            const needsSave = slotsOverLimit || !Array.isArray(stored) || stored.length !== buildingConfig.length || stored.some((item) => {
                if (!item || !item.name) {
                    return true;
                }
                const match = buildingConfig.find((b) => b.name === item.name);
                if (!match) {
                    return true;
                }
                const priority = Number(item.priority);
                const slots = Number(item.slots);
                if (!Number.isFinite(priority) || priority !== match.priority) {
                    return true;
                }
                if (!Number.isFinite(slots) || slots !== match.slots) {
                    return true;
                }
                return false;
            });

            if (needsSave) {
                FirebaseManager.setBuildingConfig(buildingConfig);
                FirebaseManager.saveUserData();
            }

            renderBuildingsTable();
        }

        function loadBuildingPositions() {
            if (typeof FirebaseManager === 'undefined') {
                buildingPositions = {};
                return;
            }
            const stored = FirebaseManager.getBuildingPositions();
            buildingPositions = normalizeBuildingPositions(stored);
        }

        function renderBuildingsTable() {
            const tbody = document.getElementById('buildingsTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            buildingConfig.forEach((b, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${b.name}</td>
                    <td data-label="${t('slots_label')}">
                        <input type="number" min="${MIN_BUILDING_SLOTS}" max="${MAX_BUILDING_SLOTS_TOTAL}" value="${b.slots}" data-index="${index}" data-field="slots" class="building-slots-input">
                    </td>
                    <td data-label="${t('priority_label')}">
                        <input type="number" min="1" max="6" value="${b.priority}" data-index="${index}" data-field="priority" class="building-priority-input">
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function readBuildingConfigFromTable() {
            const tbody = document.getElementById('buildingsTableBody');
            const updated = buildingConfig.map((b) => ({ ...b }));
            if (!tbody) {
                return { updated, totalSlots: getBuildingSlotsTotal(updated) };
            }
            const inputs = tbody.querySelectorAll('input[data-index][data-field]');
            inputs.forEach((input) => {
                const index = Number(input.getAttribute('data-index'));
                if (!Number.isFinite(index) || !updated[index]) {
                    return;
                }
                const value = Number(input.value);
                if (!Number.isFinite(value)) {
                    return;
                }
                const field = input.getAttribute('data-field');
                if (field === 'priority') {
                    updated[index].priority = clampPriority(value, updated[index].priority);
                } else if (field === 'slots') {
                    updated[index].slots = clampSlots(value, updated[index].slots);
                }
            });
            return { updated, totalSlots: getBuildingSlotsTotal(updated) };
        }

        function resetBuildingsToDefault() {
            buildingConfig = getDefaultBuildings();
            renderBuildingsTable();
        }

        async function saveBuildingConfig() {
            const { updated, totalSlots } = readBuildingConfigFromTable();
            if (totalSlots > MAX_BUILDING_SLOTS_TOTAL) {
                showMessage('buildingsStatus', t('buildings_slots_exceeded', { max: MAX_BUILDING_SLOTS_TOTAL, total: totalSlots }), 'error');
                return;
            }

            buildingConfig = normalizeBuildingConfig(updated);
            renderBuildingsTable();

            if (typeof FirebaseManager === 'undefined') {
                showMessage('buildingsStatus', t('buildings_changes_not_saved'), 'error');
                return;
            }

            FirebaseManager.setBuildingConfig(buildingConfig);
            const result = await FirebaseManager.saveUserData();
            if (result.success) {
                showMessage('buildingsStatus', t('buildings_saved'), 'success');
            } else {
                showMessage('buildingsStatus', t('buildings_save_failed', { error: result.error }), 'error');
            }
        }

        function refreshBuildingConfigForAssignments() {
            const panel = document.getElementById('buildingsPanel');
            if (panel && !panel.classList.contains('hidden')) {
                return syncBuildingConfigFromTable();
            }
            loadBuildingConfig();
            return true;
        }

        function syncBuildingConfigFromTable() {
            const tbody = document.getElementById('buildingsTableBody');
            const panel = document.getElementById('buildingsPanel');
            if (!tbody || !panel || panel.classList.contains('hidden')) {
                return true;
            }
            const { updated, totalSlots } = readBuildingConfigFromTable();
            if (totalSlots > MAX_BUILDING_SLOTS_TOTAL) {
                showMessage('buildingsStatus', t('buildings_slots_exceeded', { max: MAX_BUILDING_SLOTS_TOTAL, total: totalSlots }), 'error');
                return false;
            }
            buildingConfig = normalizeBuildingConfig(updated);
            return true;
        }

        let coordBuildingIndex = 0;
        let coordBuildings = [];

        function openCoordinatesPicker() {
            loadBuildingPositions();
            coordBuildings = buildingConfig.filter((b) => b.name !== 'Bomb Squad').map((b) => b.name);
            if (coordBuildings.length === 0) {
                showMessage('coordStatus', t('coord_no_buildings'), 'error');
                return;
            }
            coordBuildingIndex = 0;
            const overlay = document.getElementById('coordPickerOverlay');
            overlay.classList.remove('hidden');
            drawCoordCanvas();
        }

        function closeCoordinatesPicker() {
            document.getElementById('coordPickerOverlay').classList.add('hidden');
        }

        function updateCoordLabel() {
            const name = coordBuildings[coordBuildingIndex];
            const pos = buildingPositions[name];
            document.getElementById('coordBuildingLabel').textContent = name || '';
            document.getElementById('coordBuildingIndex').textContent = `(${coordBuildingIndex + 1}/${coordBuildings.length})`;
            document.getElementById('coordBuildingValue').textContent = pos
                ? t('coord_current', { x: pos[0], y: pos[1] })
                : t('coord_current_not_set');
            document.getElementById('coordPrompt').textContent = t('coord_select_prompt', { name: name });
        }

        function drawCoordCanvas() {
            const canvas = document.getElementById('coordCanvas');
            if (!canvas) return;

            updateCoordLabel();

            if (!mapLoaded) {
                loadMapImage()
                    .then(() => drawCoordCanvas())
                    .catch(() => {
                        showMessage('coordStatus', t('coord_map_not_loaded'), 'error');
                    });
                return;
            }

            const ctx = canvas.getContext('2d');
            const mapHeight = Math.floor(mapImage.height * (1080 / mapImage.width));
            canvas.width = 1080;
            canvas.height = mapHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(mapImage, 0, 0, 1080, mapHeight);

            Object.entries(buildingPositions).forEach(([name, pos]) => {
                if (!pos) return;
                const isActive = name === coordBuildings[coordBuildingIndex];
                ctx.beginPath();
                ctx.arc(pos[0], pos[1], isActive ? 8 : 5, 0, Math.PI * 2);
                ctx.fillStyle = isActive ? '#FDC830' : 'rgba(255,255,255,0.7)';
                ctx.fill();
                ctx.strokeStyle = isActive ? '#000' : 'rgba(0,0,0,0.6)';
                ctx.lineWidth = 2;
                ctx.stroke();
            });
        }

        function coordCanvasClick(event) {
            const canvas = document.getElementById('coordCanvas');
            if (!canvas) return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = Math.round((event.clientX - rect.left) * scaleX);
            const y = Math.round((event.clientY - rect.top) * scaleY);
            const name = coordBuildings[coordBuildingIndex];
            buildingPositions[name] = [x, y];
            updateCoordLabel();
            drawCoordCanvas();
            if (coordBuildingIndex < coordBuildings.length - 1) {
                coordBuildingIndex += 1;
                updateCoordLabel();
                drawCoordCanvas();
            }
        }

        function prevCoordBuilding() {
            if (coordBuildingIndex > 0) {
                coordBuildingIndex -= 1;
                drawCoordCanvas();
            }
        }

        function nextCoordBuilding() {
            if (coordBuildingIndex < coordBuildings.length - 1) {
                coordBuildingIndex += 1;
                drawCoordCanvas();
            }
        }

        async function saveBuildingPositions() {
            if (typeof FirebaseManager === 'undefined') {
                showMessage('coordStatus', t('coord_changes_not_saved'), 'error');
                return;
            }
            FirebaseManager.setBuildingPositions(buildingPositions);
            const result = await FirebaseManager.saveUserData();
            if (result.success) {
                showMessage('coordStatus', t('coord_saved'), 'success');
            } else {
                showMessage('coordStatus', t('coord_save_failed', { error: result.error }), 'error');
            }
        }

        function reserveSpaceForFooter() {
            const bar = document.getElementById('floatingButtons');
            if (!bar) return;
            const visible = bar.style.display !== 'none';
            const barHeight = visible ? bar.getBoundingClientRect().height : 0;
            document.body.style.paddingBottom = visible ? (barHeight + 30) + 'px' : '';
        }

        window.addEventListener('resize', reserveSpaceForFooter);
        
        // ============================================================
        // PLAYER SELECTION INTERFACE
        // ============================================================
        
        function renderPlayersTable() {
            const tbody = document.getElementById('playersTableBody');
            tbody.innerHTML = '';
            
            let displayPlayers = [...allPlayers];
            
            // Apply filters
            const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
            const troopsFilter = document.getElementById('troopsFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;
            
            if (searchTerm) {
                displayPlayers = displayPlayers.filter(p => 
                    p.name.toLowerCase().includes(searchTerm)
                );
            }
            
            if (troopsFilter) {
                displayPlayers = displayPlayers.filter(p => p.troops === troopsFilter);
            }
            
            switch(sortFilter) {
                case 'power-desc':
                    displayPlayers.sort((a, b) => b.power - a.power);
                    break;
                case 'power-asc':
                    displayPlayers.sort((a, b) => a.power - b.power);
                    break;
                case 'name-asc':
                    displayPlayers.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'name-desc':
                    displayPlayers.sort((a, b) => b.name.localeCompare(a.name));
                    break;
            }
            
            displayPlayers.forEach(player => {
                const row = document.createElement('tr');
                
                const isTeamA = teamSelections.teamA.includes(player.name);
                const isTeamB = teamSelections.teamB.includes(player.name);
                
                if (isTeamA) row.classList.add('selected-a');
                if (isTeamB) row.classList.add('selected-b');
                
                const teamADisabled = teamSelections.teamA.length >= 20 && !isTeamA;
                const teamBDisabled = teamSelections.teamB.length >= 20 && !isTeamB;
                
                row.innerHTML = `
                    <td><strong>${escapeHtml(player.name)}</strong></td>
                    <td>${player.power}M</td>
                    <td>${escapeHtml(getTroopLabel(player.troops))}</td>
                    <td>
                        <div class="team-buttons">
                            <button class="team-btn team-a-btn ${isTeamA ? 'active' : ''}"
                                    ${teamADisabled ? 'disabled' : ''}>
                                ${t('team_a_button')}
                            </button>
                            <button class="team-btn team-b-btn ${isTeamB ? 'active' : ''}"
                                    ${teamBDisabled ? 'disabled' : ''}>
                                ${t('team_b_button')}
                            </button>
                            ${(isTeamA || isTeamB) ? `<button class="clear-btn">${t('clear_button')}</button>` : ''}
                        </div>
                    </td>
                `;

                row.querySelector('.team-a-btn').addEventListener('click', () => toggleTeam(player.name, 'A'));
                row.querySelector('.team-b-btn').addEventListener('click', () => toggleTeam(player.name, 'B'));
                const clearBtn = row.querySelector('.clear-btn');
                if (clearBtn) clearBtn.addEventListener('click', () => clearPlayerSelection(player.name));

                tbody.appendChild(row);
            });
        }
        
        function toggleTeam(playerName, team) {
            if (team === 'A') {
                const index = teamSelections.teamA.indexOf(playerName);
                if (index > -1) {
                    teamSelections.teamA.splice(index, 1);
                } else {
                    const bIndex = teamSelections.teamB.indexOf(playerName);
                    if (bIndex > -1) {
                        teamSelections.teamB.splice(bIndex, 1);
                    }
                    if (teamSelections.teamA.length < 20) {
                        teamSelections.teamA.push(playerName);
                    }
                }
            } else {
                const index = teamSelections.teamB.indexOf(playerName);
                if (index > -1) {
                    teamSelections.teamB.splice(index, 1);
                } else {
                    const aIndex = teamSelections.teamA.indexOf(playerName);
                    if (aIndex > -1) {
                        teamSelections.teamA.splice(aIndex, 1);
                    }
                    if (teamSelections.teamB.length < 20) {
                        teamSelections.teamB.push(playerName);
                    }
                }
            }
            
            updateTeamCounters();
            renderPlayersTable();
        }
        
        function clearPlayerSelection(playerName) {
            const aIndex = teamSelections.teamA.indexOf(playerName);
            if (aIndex > -1) teamSelections.teamA.splice(aIndex, 1);
            
            const bIndex = teamSelections.teamB.indexOf(playerName);
            if (bIndex > -1) teamSelections.teamB.splice(bIndex, 1);
            
            updateTeamCounters();
            renderPlayersTable();
        }
        
        function clearAllSelections() {
            if (confirm(t('confirm_clear_all'))) {
                teamSelections.teamA = [];
                teamSelections.teamB = [];
                assignmentsA = [];
                assignmentsB = [];
                closeDownloadModal();
                updateTeamCounters();
                renderPlayersTable();
            }
        }
        
        function filterPlayers() {
            renderPlayersTable();
        }
        
        function updateTeamCounters() {
            const teamACount = teamSelections.teamA.length;
            const teamBCount = teamSelections.teamB.length;
            
            document.getElementById('teamACount').textContent = teamACount;
            document.getElementById('teamBCount').textContent = teamBCount;
            document.getElementById('teamAFloatCount').textContent = teamACount;
            document.getElementById('teamBFloatCount').textContent = teamBCount;
            
            const teamACounter = document.querySelector('.counter.team-a');
            const teamBCounter = document.querySelector('.counter.team-b');
            const generateBtnA = document.getElementById('generateBtnA');
            const generateBtnB = document.getElementById('generateBtnB');
            
            // Team A handling
            if (teamACount === 20) {
                teamACounter.classList.add('full');
            } else {
                teamACounter.classList.remove('full');
            }
            
            // Enable/disable Team A generate button (enable if at least 1 player selected)
            if (teamACount > 0) {
                generateBtnA.disabled = false;
            } else {
                generateBtnA.disabled = true;
            }
            
            // Team B handling
            if (teamBCount === 20) {
                teamBCounter.classList.add('full');
            } else {
                teamBCounter.classList.remove('full');
            }
            
            // Enable/disable Team B generate button (enable if at least 1 player selected)
            if (teamBCount > 0) {
                generateBtnB.disabled = false;
            } else {
                generateBtnB.disabled = true;
            }
        }
        
        // ============================================================
        // ASSIGNMENT GENERATION
        // ============================================================
        
        function generateTeamAssignments(team) {
            if (typeof FirebaseManager === 'undefined') {
                alert(t('error_firebase_not_loaded'));
                return;
            }

            const buildingConfigOk = refreshBuildingConfigForAssignments();
            if (!buildingConfigOk) {
                alert(t('alert_total_slots_exceed', { max: MAX_BUILDING_SLOTS_TOTAL }));
                return;
            }
            
            const selections = team === 'A' ? teamSelections.teamA : teamSelections.teamB;
            
            if (selections.length === 0) {
                alert(t('alert_select_at_least_one', { team: team }));
                return;
            }
            
            if (selections.length > 20) {
                alert(t('alert_max_players', { count: selections.length }));
                return;
            }
            
            const playerDB = FirebaseManager.getPlayerDatabase();
            
            const teamPlayers = selections.map(name => ({
                name: name,
                power: playerDB[name].power,
                troops: playerDB[name].troops
            })).sort((a, b) => b.power - a.power);
            
            const assignments = assignTeamToBuildings(teamPlayers);
            
            if (team === 'A') {
                assignmentsA = assignments;
            } else {
                assignmentsB = assignments;
            }

            openDownloadModal(team);
            
            console.log(`Team ${team} assignments generated for ${selections.length} players:`, assignments);
        }
        
        function assignTeamToBuildings(players) {
            const assignments = [];
            let available = [...players]; // already sorted by power desc

            const sortedBuildings = [...getEffectiveBuildingConfig()].sort((a, b) => {
                if (a.priority !== b.priority) {
                    return a.priority - b.priority;
                }
                return a.name.localeCompare(b.name);
            });

            // Group consecutive buildings by priority
            const groups = [];
            sortedBuildings.forEach(building => {
                const last = groups[groups.length - 1];
                if (last && last[0].priority === building.priority) {
                    last.push(building);
                } else {
                    groups.push([building]);
                }
            });

            groups.forEach(group => {
                const pairsNeeded = group.map(b => Math.floor(b.slots / 2));
                const maxPairs = Math.max(...pairsNeeded);

                // Phase 1: round-robin top player picks across the group.
                // Each building claims one top player per round until it has
                // enough (slots / 2). This ensures same-priority buildings
                // each get an equally strong anchor player.
                const topPicks = new Map();
                group.forEach(b => topPicks.set(b.name, []));

                for (let round = 0; round < maxPairs; round++) {
                    group.forEach((building, idx) => {
                        if (topPicks.get(building.name).length < pairsNeeded[idx] && available.length > 0) {
                            topPicks.get(building.name).push(available[0]);
                            available = available.slice(1);
                        }
                    });
                }

                // Phase 2: for each building, pair each top pick with a
                // mix partner (search next 3 by power for a different troop).
                group.forEach(building => {
                    topPicks.get(building.name).forEach(top => {
                        assignments.push({
                            building: building.name,
                            priority: building.priority,
                            player: top.name
                        });

                        const partner = findMixPartner(top, available);
                        if (partner) {
                            assignments.push({
                                building: building.name,
                                priority: building.priority,
                                player: partner.name
                            });
                            available = available.filter(p => p.name !== partner.name);
                        }
                    });
                });
            });

            return assignments;
        }

        // Searches the next 3 available players by power for a different
        // troop type than the given player. Falls back to next by power.
        function findMixPartner(player, available) {
            if (available.length === 0) return null;
            const candidates = available.slice(0, 3);
            const mixIndex = candidates.findIndex(p => p.troops !== player.troops);
            return mixIndex !== -1 ? candidates[mixIndex] : available[0];
        }
        
        // ============================================================
        // DOWNLOAD MODAL
        // ============================================================

        function openDownloadModal(team) {
            const isA = team === 'A';
            const gradient = isA ? 'linear-gradient(135deg, #4169E1, #1E90FF)' : 'linear-gradient(135deg, #DC143C, #FF6347)';
            const color = isA ? '#4169E1' : '#DC143C';
            activeDownloadTeam = team;

            document.getElementById('downloadModalTitle').textContent = t('download_modal_title', { team: team });
            document.getElementById('downloadModalTitle').style.color = color;
            document.getElementById('downloadModalSubtitle').textContent = t('download_modal_subtitle', { team: team });
            document.getElementById('downloadMapBtn').style.background = gradient;
            document.getElementById('downloadMapBtn').onclick = () => downloadTeamMap(team);
            document.getElementById('downloadExcelBtn').style.background = gradient;
            document.getElementById('downloadExcelBtn').onclick = () => downloadTeamExcel(team);
            document.getElementById('downloadStatus').innerHTML = '';
            document.getElementById('downloadModalOverlay').classList.remove('hidden');
        }

        function closeDownloadModal() {
            activeDownloadTeam = null;
            document.getElementById('downloadModalOverlay').classList.add('hidden');
        }

        // ============================================================
        // DOWNLOAD FUNCTIONS
        // ============================================================

        function downloadTeamExcel(team) {
            const wb = XLSX.utils.book_new();
            const assignments = team === 'A' ? assignmentsA : assignmentsB;
            
            if (assignments.length === 0) {
                alert(t('alert_no_assignments', { team: team }));
                return;
            }
            
            const data = assignments.map(a => ({
                [t('excel_header_building')]: a.building,
                [t('excel_header_priority')]: a.priority,
                [t('excel_header_player')]: a.player
            }));
            
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), t('excel_sheet_name', { team: team }));
            XLSX.writeFile(wb, `desert_storm_team_${team}_assignments.xlsx`);
            
            const statusId = 'downloadStatus';
            showMessage(statusId, t('message_excel_downloaded'), 'success');
        }
        
        function downloadTeamMap(team) {
            const assignments = team === 'A' ? assignmentsA : assignmentsB;
            
            if (assignments.length === 0) {
                alert(t('alert_no_assignments', { team: team }));
                return;
            }
            
            const statusId = 'downloadStatus';
            
            if (!mapLoaded) {
                showMessage(statusId, t('message_map_wait'), 'processing');
                // Wait up to 10 seconds for map to load
                let waitTime = 0;
                const checkInterval = setInterval(() => {
                    waitTime += 500;
                    if (mapLoaded) {
                        clearInterval(checkInterval);
                        generateMap(team, assignments, statusId);
                    } else if (waitTime >= 10000) {
                        clearInterval(checkInterval);
                        if (confirm(t('confirm_map_without_background'))) {
                            generateMapWithoutBackground(team, assignments, statusId);
                        } else {
                            showMessage(statusId, t('message_map_cancelled'), 'warning');
                        }
                    }
                }, 500);
                return;
            }
            
            generateMap(team, assignments, statusId);
        }
        
        function generateMapWithoutBackground(team, assignments, statusId) {
            showMessage(statusId, t('message_generating_map_no_bg', { team: team }), 'processing');
            
            try {
                const grouped = {};
                const bombSquad = [];
                
                assignments.forEach(a => {
                    if (!a.player) return;
                    if (a.building === 'Bomb Squad') {
                        bombSquad.push(a);
                    } else {
                        if (!grouped[a.building]) grouped[a.building] = [];
                        grouped[a.building].push(a);
                    }
                });
                
                // Create simplified version without map
                const canvas = document.createElement('canvas');
                canvas.width = 1080;
                canvas.height = 800;
                const ctx = canvas.getContext('2d');
                
                // Background
                ctx.fillStyle = team === 'A' ? '#E8F4FF' : '#FFE8E8';
                ctx.fillRect(0, 0, 1080, 800);
                
                // Title
                const grad = ctx.createLinearGradient(0, 0, 1080, 100);
                grad.addColorStop(0, team === 'A' ? '#4169E1' : '#DC143C');
                grad.addColorStop(1, team === 'A' ? '#1E90FF' : '#FF6347');
                ctx.fillStyle = grad;
                ctx.fillRect(0, 0, 1080, 100);
                
                ctx.font = 'bold 48px Arial';
                ctx.fillStyle = 'white';
                ctx.textAlign = 'center';
                ctx.fillText(`TEAM ${team} - DESERT STORM`, 540, 60);
                
                // List assignments
                ctx.fillStyle = '#333';
                ctx.font = '16px Arial';
                ctx.textAlign = 'left';
                let y = 150;
                
                assignments.forEach((a, i) => {
                    if (a.player) {
                        ctx.fillText(`${i+1}. ${a.player} → ${a.building}`, 50, y);
                        y += 30;
                    }
                });
                
                // Download
                const dataURL = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = dataURL;
                a.download = `team_${team}_desert_storm_nomap.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                showMessage(statusId, t('message_team_downloaded_list', { team: team }), 'success');
            } catch (error) {
                console.error(error);
                showMessage(statusId, t('error_generic', { error: error.message }), 'error');
            }
        }
        
        function generateMap(team, assignments, statusId) {
            showMessage(statusId, t('message_generating_map', { team: team }), 'processing');
            
            try {
                const grouped = {};
                const bombSquad = [];
                
                assignments.forEach(a => {
                    if (!a.player) return;
                    if (a.building === 'Bomb Squad') {
                        bombSquad.push(a);
                    } else {
                        if (!grouped[a.building]) grouped[a.building] = [];
                        grouped[a.building].push(a);
                    }
                });
                
                const titleHeight = 100;
                const bombHeight = 250;
                const mapHeight = Math.floor(mapImage.height * (1080 / mapImage.width));
                const totalHeight = titleHeight + mapHeight + bombHeight;
                
                const canvas = document.createElement('canvas');
                canvas.width = 1080;
                canvas.height = totalHeight;
                const ctx = canvas.getContext('2d');
                
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, 1080, totalHeight);
                
                const grad = ctx.createLinearGradient(0, 0, 1080, titleHeight);
                grad.addColorStop(0, team === 'A' ? '#4169E1' : '#DC143C');
                grad.addColorStop(1, team === 'A' ? '#1E90FF' : '#FF6347');
                ctx.fillStyle = grad;
                ctx.fillRect(0, 0, 1080, titleHeight);
                
                ctx.font = 'bold 48px Arial';
                ctx.fillStyle = 'white';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(`TEAM ${team} - DESERT STORM`, 540, titleHeight / 2);
                
                ctx.drawImage(mapImage, 0, titleHeight, 1080, mapHeight);
                
                let drawnCount = 0;
                const effectivePositions = getEffectiveBuildingPositions();
                Object.keys(grouped).forEach(building => {
                    if (!effectivePositions[building]) return;
                    
                    const [x, y_base] = effectivePositions[building];
                    const y = y_base + titleHeight;
                    const players = grouped[building];
                    const anchor = buildingAnchors[building] || 'left';
                    
                    players.slice(0, 2).forEach((player, i) => {
                        const name = player.player;
                        
                        ctx.font = 'bold 14px Arial';
                        const metrics = ctx.measureText(name);
                        const pad = 8;
                        const boxW = metrics.width + pad * 2;
                        const boxH = 24;
                        
                        const yPos = y + (i * 35) - 15;
                        let boxX = anchor === 'left' ? x - boxW - 15 : x + 15;
                        const boxY = yPos - boxH / 2;
                        
                        if (boxX < 5) boxX = 5;
                        else if (boxX + boxW > 1075) boxX = 1075 - boxW;
                        
                        ctx.fillStyle = bgColors[player.priority] || 'rgba(255,255,255,0.9)';
                        ctx.beginPath();
                        ctx.roundRect(boxX, boxY, boxW, boxH, 8);
                        ctx.fill();
                        
                        ctx.strokeStyle = 'black';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        
                        ctx.fillStyle = textColors[player.priority] || '#000000';
                        ctx.textAlign = 'left';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(name, boxX + pad, yPos);
                        
                        drawnCount++;
                    });
                });
                
                // Bomb Squad
                const bombY = titleHeight + mapHeight + 30;
                ctx.fillStyle = 'rgba(240,240,240,0.9)';
                ctx.beginPath();
                ctx.roundRect(240, bombY, 600, 180, 15);
                ctx.fill();
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                ctx.font = 'bold 20px Arial';
                ctx.fillStyle = team === 'A' ? '#4169E1' : '#DC143C';
                ctx.textAlign = 'center';
                ctx.fillText('BOMB SQUAD', 540, bombY + 25);
                
                let pY = bombY + 60;
                bombSquad.forEach((player, i) => {
                    const row = Math.floor(i / 2);
                    const col = i % 2;
                    const name = player.player;
                    
                    ctx.font = 'bold 14px Arial';
                    const m = ctx.measureText(name);
                    const bw = m.width + 12;
                    const xPos = 540 - 140 + (col * 280);
                    const yPos = pY + (row * 35);
                    
                    ctx.fillStyle = team === 'A' ? 'rgba(230,240,255,0.95)' : 'rgba(255,230,240,0.95)';
                    ctx.beginPath();
                    ctx.roundRect(xPos - bw/2, yPos - 10, bw, 20, 8);
                    ctx.fill();
                    
                    ctx.strokeStyle = team === 'A' ? '#4169E1' : '#DC143C';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    ctx.fillStyle = team === 'A' ? '#4169E1' : '#DC143C';
                    ctx.textAlign = 'center';
                    ctx.fillText(name, xPos, yPos);
                });
                
                ctx.font = '12px Arial';
                ctx.fillStyle = 'gray';
                ctx.fillText(t('map_footer_text'), 540, bombY + 160);
                
                const dataURL = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = dataURL;
                a.download = `team_${team}_desert_storm.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                showMessage(statusId, t('message_team_map_downloaded', { team: team, drawnCount: drawnCount, bombSquad: bombSquad.length }), 'success');
            } catch (error) {
                console.error(error);
                const statusId = 'downloadStatus';
                showMessage(statusId, t('error_generic', { error: error.message }), 'error');
            }
        }
        
        // ============================================================
        // UTILITY FUNCTIONS
        // ============================================================
        
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            if (type === 'success') {
                setTimeout(() => {
                    element.innerHTML = '';
                }, 5000);
            }
        }

        initLanguage();

        document.addEventListener('click', (event) => {
            if (event.target && event.target.id === 'coordCanvas') {
                coordCanvasClick(event);
            }
        });
    </script>
</body>
</html>


