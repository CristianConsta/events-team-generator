<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://apis.google.com https://www.gstatic.com https://accounts.google.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://lh3.googleusercontent.com; connect-src 'self' https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://www.googleapis.com https://*.googleapis.com; font-src 'self' data:; base-uri 'none'; frame-ancestors 'none'; frame-src https://accounts.google.com https://*.google.com https://*.firebaseapp.com https://last-war-game-desert-storm.firebaseapp.com; form-action 'self';">
    <title>Desert Storm - Player Selection</title>
    <script src="vendor/xlsx.full.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="vendor/firebase-app-compat.js"></script>
    <script src="vendor/firebase-auth-compat.js"></script>
    <script src="vendor/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-module.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213E 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; color: #FDC830; font-size: 2.5rem; margin-bottom: 30px; }
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .page-header h1 { margin: 0; }
        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(253, 200, 48, 0.3);
        }
        .card h2 { color: #FDC830; margin-bottom: 15px; }
        button {
            background: linear-gradient(135deg, #FF6B35, #F7931E);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 5px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 107, 53, 0.5); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        button.secondary { background: linear-gradient(135deg, #FDC830, #F7931E); }
        .hidden { display: none !important; }
        .coord-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 12, 20, 0.7);
            backdrop-filter: blur(3px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        input[type="file"] { display: none; }
        
        /* Collapsible Panel */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 15px 0;
            border-bottom: 2px solid rgba(253, 200, 48, 0.3);
            user-select: none;
        }
        .collapsible-header:hover { opacity: 0.8; }
        .collapsible-content {
            margin-top: 20px;
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, margin-top 0.3s ease-out;
        }
        .collapsible-content.collapsed {
            max-height: 0;
            margin-top: 0;
        }
        .expand-icon {
            font-size: 24px;
            transition: transform 0.3s;
            display: inline-block;
        }
        .expand-icon.rotated {
            transform: rotate(180deg);
        }
        
        /* Player Selection Interface */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filters input, .filters select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
        }
        .filters input::placeholder { color: rgba(255,255,255,0.6); }
        
        /* Fix dropdown option colors */
        .filters select option {
            background: #2c2c2c;
            color: white;
            padding: 10px;
        }
        .filters select option:hover {
            background: #3c3c3c;
        }
        
        .team-counters {
            display: flex;
            gap: 30px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .counter {
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
        }
        .counter.team-a { background: linear-gradient(135deg, #4169E1, #1E90FF); }
        .counter.team-b { background: linear-gradient(135deg, #DC143C, #FF6347); }
        .counter.full { animation: pulse 1s infinite; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .players-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .players-table th {
            background: rgba(253, 200, 48, 0.3);
            padding: 12px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #FDC830;
        }
        .players-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .players-table tr:hover {
            background: rgba(255,255,255,0.05);
        }
        .players-table tr.selected-a {
            background: rgba(65, 105, 225, 0.2);
        }
        .players-table tr.selected-b {
            background: rgba(220, 20, 60, 0.2);
        }
        
        .team-buttons {
            display: flex;
            gap: 10px;
        }
        .team-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: 2px solid;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
            margin: 0;
        }
        .team-btn.team-a-btn {
            border-color: #4169E1;
            color: #4169E1;
        }
        .team-btn.team-a-btn:hover { background: #4169E1; color: white; }
        .team-btn.team-a-btn.active { background: #4169E1; color: white; }
        .team-btn.team-b-btn {
            border-color: #DC143C;
            color: #DC143C;
        }
        .team-btn.team-b-btn:hover { background: #DC143C; color: white; }
        .team-btn.team-b-btn.active { background: #DC143C; color: white; }
        .team-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .clear-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            color: rgba(255,255,255,0.6);
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin: 0;
        }
        .clear-btn:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .generate-section {
            text-align: center;
            padding: 30px;
            margin-top: 20px;
        }
        .generate-btn {
            background: linear-gradient(135deg, #00C853, #64DD17);
            padding: 20px 50px;
            font-size: 20px;
            box-shadow: 0 4px 15px rgba(0, 200, 83, 0.4);
        }
        .generate-btn:disabled {
            background: linear-gradient(135deg, #666, #888);
            box-shadow: none;
        }
        
        /* Floating Generate Buttons */
        .floating-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(26, 26, 46, 0) 0%, rgba(26, 26, 46, 0.95) 20%, rgba(26, 26, 46, 1) 100%);
            padding: 20px;
            display: flex;
            gap: 20px;
            justify-content: center;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        }
        .floating-buttons button {
            min-width: 280px;
            padding: 18px 40px;
            font-size: 18px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        .floating-buttons button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
        }
        
        .message { padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center; font-weight: bold; }
        .success { background: rgba(144, 238, 144, 0.2); border: 2px solid #90EE90; color: #90EE90; }
        .error { background: rgba(255, 107, 53, 0.2); border: 2px solid #FF6B35; color: #FF6B35; }
        .warning { background: rgba(255, 193, 7, 0.2); border: 2px solid #FFC107; color: #FFC107; }
        .processing { background: rgba(253, 200, 48, 0.2); border: 2px solid #FDC830; color: #FDC830; }
        
        /* Team specific sections */
        .team-section {
            border-left: 4px solid;
            padding-left: 20px;
            margin-top: 20px;
        }
        .team-section.team-a-section {
            border-left-color: #4169E1;
        }
        .team-section.team-b-section {
            border-left-color: #DC143C;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" style="display: none;">
        <div style="max-width: 400px; margin: 100px auto; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h1 style="text-align: center; color: #333;">🏜️ Desert Storm</h1>
            <h3 style="text-align: center; color: #666; margin-bottom: 30px;">Sign in to continue</h3>
            
            <button id="googleSignInBtn" onclick="handleGoogleSignIn()" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; cursor: pointer; background: white; border: 1px solid #ddd; border-radius: 8px; color: #333;">
                🔵 Sign in with Google
            </button>
            
            <div style="text-align: center; margin: 20px 0; color: #999;">or</div>
            
            <input type="email" id="emailInput" placeholder="Email" style="width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;">
            <input type="password" id="passwordInput" placeholder="Password" style="width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;">
            
            <button onclick="handleEmailSignIn()" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 8px;">
                Sign In
            </button>
            
            <button onclick="showSignUpForm()" style="width: 100%; padding: 12px; margin: 5px 0; font-size: 14px; cursor: pointer; background: #2196F3; color: white; border: none; border-radius: 8px;">
                Create New Account
            </button>
            
            <button onclick="handlePasswordReset()" style="width: 100%; padding: 8px; margin: 10px 0; font-size: 12px; cursor: pointer; background: transparent; color: #666; border: none;">
                Forgot Password?
            </button>
            
            <div id="statusMessage" style="margin-top: 20px; padding: 10px; border-radius: 8px; text-align: center; display: none;"></div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display: none;">
        <!-- User Header -->
        <div style="background: rgba(255,255,255,0.1); padding: 15px; margin-bottom: 20px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto 20px auto;">
            <div>
                <span id="userEmail" style="color: #FDC830; font-weight: bold;"></span>
                <span id="playerCount" style="color: #fff; margin-left: 20px;"></span>
                <span id="syncStatus" style="color: #90EE90; margin-left: 20px;">☁️ Synced</span>
            </div>
            <button onclick="handleSignOut()" style="padding: 8px 20px; background: #FF6B35; color: white; border: none; border-radius: 8px; cursor: pointer;">
                Sign Out
            </button>
        </div>

        <div class="container">
            <div class="page-header">
                <h1>🏜️ DESERT STORM</h1>
                <button class="secondary" onclick="toggleBuildingsPanel()">Buildings &amp; Priorities</button>
            </div>

            <div id="buildingsPanel" class="card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <h2 style="margin: 0;">Buildings &amp; Priorities</h2>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="clear-btn" onclick="openCoordinatesPicker()">Map Coordinates</button>
                        <button class="clear-btn" onclick="toggleBuildingsPanel()">Close</button>
                    </div>
                </div>
                <p style="opacity: 0.9; margin: 15px 0;">Update building priorities. Names and slots are fixed to match the map.</p>
                <div style="overflow-x: auto;">
                    <table class="players-table" id="buildingsTable">
                        <thead>
                            <tr>
                                <th>Building</th>
                                <th>Slots</th>
                                <th>Priority</th>
                            </tr>
                        </thead>
                        <tbody id="buildingsTableBody">
                            <!-- Building rows will be rendered here -->
                        </tbody>
                    </table>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                    <button class="secondary" onclick="resetBuildingsToDefault()">Reset to Default</button>
                    <button onclick="saveBuildingConfig()">Save Changes</button>
                </div>
                <div id="buildingsStatus"></div>
            </div>

            <div id="coordPickerOverlay" class="coord-overlay hidden">
                <div style="width: min(1000px, 95vw); max-height: 90vh; overflow: auto; background: rgba(26, 26, 46, 0.98); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <h2 style="margin: 0;">Map Coordinates Picker</h2>
                        <button class="clear-btn" onclick="closeCoordinatesPicker()">Close</button>
                    </div>
                    <p style="opacity: 0.9; margin: 10px 0 15px;">Click on the map to set the position for the selected building. Coordinates update one by one.</p>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center; margin-bottom: 6px;">
                        <strong id="coordBuildingLabel">Building</strong>
                        <span id="coordBuildingIndex" style="opacity: 0.7;"></span>
                    </div>
                    <div id="coordPrompt" style="opacity: 0.85; margin-bottom: 10px;">Click on the map to set coordinates.</div>
                    <div id="coordBuildingValue" style="opacity: 0.7; margin-bottom: 10px;"></div>
                    <canvas id="coordCanvas" style="width: 100%; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2);"></canvas>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                        <button class="secondary" onclick="prevCoordBuilding()">Prev</button>
                        <button class="secondary" onclick="nextCoordBuilding()">Next</button>
                        <button onclick="saveBuildingPositions()">Save Coordinates</button>
                    </div>
                    <div id="coordStatus" style="margin-top: 10px;"></div>
                </div>
            </div>
            
            <!-- Upload Section (Collapsible when players exist) -->
            <div id="uploadSection" class="card">
                <div class="collapsible-header" onclick="toggleUploadPanel()">
                    <div>
                        <h2 style="display: inline; margin: 0;">📊 Player Database</h2>
                        <span id="uploadHint" style="margin-left: 15px; opacity: 0.7; font-size: 14px;"></span>
                    </div>
                    <span class="expand-icon rotated" id="uploadExpandIcon">▼</span>
                </div>
                
                <div class="collapsible-content" id="uploadContent">
                    <p style="opacity: 0.9; margin-bottom: 20px;">Upload your player data. Template headers start at row 10: Player Name, E1 Total Power(M), E1 Troops.</p>
                    
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="secondary" onclick="downloadPlayerTemplate()">📥 Download Template</button>
                        <button onclick="document.getElementById('playerFileInput').click()">📤 Upload Player Data</button>
                        <input type="file" id="playerFileInput" accept=".xlsx,.xls" onchange="uploadPlayerData()">
                    </div>
                    
                    <div id="uploadMessage"></div>
                </div>
            </div>
            
            <!-- Player Selection Section -->
            <div id="selectionSection" class="card hidden">
                <h2>⚔️ Select Teams</h2>
                <p style="opacity: 0.9; margin-bottom: 20px;">Select players for Team A and Team B independently. Maximum 20 players per team.</p>
                
                <!-- Team Counters -->
                <div class="team-counters">
                    <div class="counter team-a">
                        Team A: <span id="teamACount">0</span>/20
                    </div>
                    <div class="counter team-b">
                        Team B: <span id="teamBCount">0</span>/20
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="filters">
                    <input type="text" id="searchFilter" placeholder="🔍 Search player name..." onkeyup="filterPlayers()">
                    <select id="troopsFilter" onchange="filterPlayers()">
                        <option value="">All Troop Types</option>
                        <option value="Tank">Tank</option>
                        <option value="Aero">Aero</option>
                        <option value="Missile">Missile</option>
                    </select>
                    <select id="sortFilter" onchange="filterPlayers()">
                        <option value="power-desc">Sort by Power (High to Low)</option>
                        <option value="power-asc">Sort by Power (Low to High)</option>
                        <option value="name-asc">Sort by Name (A-Z)</option>
                        <option value="name-desc">Sort by Name (Z-A)</option>
                    </select>
                    <button class="secondary" onclick="clearAllSelections()">Clear All Selections</button>
                </div>
                
                <!-- Players Table -->
                <div style="overflow-x: auto;">
                    <table class="players-table" id="playersTable">
                        <thead>
                            <tr>
                                <th>Player Name</th>
                                <th>E1 Power (M)</th>
                                <th>Troop Type</th>
                                <th>Team Selection</th>
                            </tr>
                        </thead>
                        <tbody id="playersTableBody">
                            <!-- Players will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Team A & B Sections removed - replaced with floating buttons -->
            
            
            <!-- Team A Download Section -->
            <div id="downloadSectionA" class="card hidden">
                <div class="team-section team-a-section">
                    <h2 style="color: #4169E1;">✅ Team A Downloads</h2>
                    <p style="opacity: 0.9; margin-bottom: 20px;">Team A assignments are ready!</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <button style="background: linear-gradient(135deg, #4169E1, #1E90FF); font-size: 17px; padding: 16px 35px;" onclick="downloadTeamMap('A')">
                            🗺️ Team A Map
                        </button>
                        <button style="background: linear-gradient(135deg, #4169E1, #1E90FF);" onclick="downloadTeamExcel('A')">
                            📊 Team A Excel
                        </button>
                    </div>
                    <div id="downloadStatusA"></div>
                </div>
            </div>
            
            
            <!-- Team B Download Section -->
            <div id="downloadSectionB" class="card hidden">
                <div class="team-section team-b-section">
                    <h2 style="color: #DC143C;">✅ Team B Downloads</h2>
                    <p style="opacity: 0.9; margin-bottom: 20px;">Team B assignments are ready!</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <button style="background: linear-gradient(135deg, #DC143C, #FF6347); font-size: 17px; padding: 16px 35px;" onclick="downloadTeamMap('B')">
                            🗺️ Team B Map
                        </button>
                        <button style="background: linear-gradient(135deg, #DC143C, #FF6347);" onclick="downloadTeamExcel('B')">
                            📊 Team B Excel
                        </button>
                    </div>
                    <div id="downloadStatusB"></div>
                </div>
            </div>
        </div>

        <!-- Floating Generate Buttons -->
        <div class="floating-buttons" id="floatingButtons" style="display: none;">
            <button class="generate-btn" id="generateBtnA" onclick="generateTeamAssignments('A')" style="background: linear-gradient(135deg, #4169E1, #1E90FF);" disabled>
                <span style="display: block; font-size: 14px; opacity: 0.9;">Team A (<span id="teamAFloatCount">0</span>/20)</span>
                🚀 Generate Team A
            </button>
            <button class="generate-btn" id="generateBtnB" onclick="generateTeamAssignments('B')" style="background: linear-gradient(135deg, #DC143C, #FF6347);" disabled>
                <span style="display: block; font-size: 14px; opacity: 0.9;">Team B (<span id="teamBFloatCount">0</span>/20)</span>
                🚀 Generate Team B
            </button>
        </div>
    </div>

    <script>
        // ============================================================
        // INITIALIZATION CHECK
        // ============================================================
        
        // Check if Firebase modules are loaded
        if (typeof firebase === 'undefined') {
            alert('❌ Firebase SDK not loaded! Make sure you have internet connection.');
            console.error('Firebase SDK failed to load from CDN');
        }
        
        if (typeof XLSX === 'undefined') {
            alert('❌ XLSX library not loaded! Make sure you have internet connection.');
            console.error('XLSX library failed to load from CDN');
        }
        
        if (typeof FirebaseManager === 'undefined') {
            alert('❌ firebase-module.js not found! Make sure firebase-module.js is in the same folder as this HTML file.');
            console.error('FirebaseManager not defined - firebase-module.js not loaded');
        }
        
        // ============================================================
        // GLOBAL STATE
        // ============================================================
        
        let allPlayers = [];
        let teamSelections = {
            teamA: [],
            teamB: []
        };
        let assignmentsA = [];
        let assignmentsB = [];
        let mapLoaded = false;
        let uploadPanelExpanded = true;
        
        // Load desert storm map
        // IMPORTANT: Put 'desert-storm-map.png' in the same folder as this HTML file
        const mapImage = new Image();
        let mapLoadRetries = 0;
        const maxRetries = 3;
        
        function loadMapImage() {
            return new Promise((resolve, reject) => {
                mapImage.onload = () => { 
                    mapLoaded = true; 
                    console.log('✅ Map loaded successfully');
                    resolve(true);
                };
                
                mapImage.onerror = () => {
                    console.error('❌ Map failed to load, attempt:', mapLoadRetries + 1);
                    
                    if (mapLoadRetries < maxRetries) {
                        mapLoadRetries++;
                        console.log('Retrying map load...');
                        setTimeout(() => {
                            mapImage.src = 'desert-storm-map.png?' + Date.now();
                        }, 1000 * mapLoadRetries);
                    } else {
                        alert('⚠️ Map image not found! Please make sure "desert-storm-map.png" is in the same folder as this HTML file.');
                        console.error('Map loading failed after', maxRetries, 'attempts');
                        reject(false);
                    }
                };
                
                // Load local map file (no CORS issues!)
                mapImage.src = 'desert-storm-map.png';
            });
        }
        
        // Start loading map immediately
        loadMapImage().catch(() => {
            console.warn('Map failed to load, continuing without it');
        });
        
        // Building positions on the map (scaled for 1080px width from 2048x1446 original)
        const defaultBuildingPositions = {
            'Info Center': [242, 95],
            'Field Hospital 4': [474, 95],
            'Oil Refinery 1': [137, 190],
            'Field Hospital 2': [527, 179],
            'Oil Refinery 2': [580, 311],
            'Field Hospital 1': [153, 311],
            'Field Hospital 3': [200, 385],
            'Science Hub': [495, 395],
        };
        
        const buildingAnchors = {
            'Info Center': 'left',
            'Field Hospital 4': 'right',
            'Oil Refinery 1': 'left',
            'Field Hospital 2': 'right',
            'Oil Refinery 2': 'right',
            'Field Hospital 1': 'left',
            'Field Hospital 3': 'left',
            'Science Hub': 'right',
        };
        
        const textColors = { 1: '#8B0000', 2: '#B85C00', 3: '#006464', 4: '#006699', 5: '#226644', 6: '#556B2F' };
        const bgColors = { 1: 'rgba(255,230,230,0.9)', 2: 'rgba(255,240,220,0.9)', 3: 'rgba(230,255,250,0.9)', 
                          4: 'rgba(230,245,255,0.9)', 5: 'rgba(240,255,240,0.9)', 6: 'rgba(245,255,235,0.9)' };
        
        // Building definitions with priorities (20 players total)
        const defaultBuildings = [
            { name: 'Bomb Squad', priority: 1, slots: 4 },
            { name: 'Oil Refinery 1', priority: 3, slots: 2 },
            { name: 'Oil Refinery 2', priority: 3, slots: 2 },
            { name: 'Field Hospital 1', priority: 4, slots: 2 },
            { name: 'Field Hospital 2', priority: 4, slots: 2 },
            { name: 'Field Hospital 3', priority: 4, slots: 1 },
            { name: 'Field Hospital 4', priority: 4, slots: 1 },
            { name: 'Info Center', priority: 5, slots: 1 },
            { name: 'Science Hub', priority: 5, slots: 1 },
        ];

        let buildingConfig = defaultBuildings.map((b) => ({ ...b }));
        // Only store user-picked coordinates here; defaults are used as fallback for rendering.
        let buildingPositions = {};
        
        // ============================================================
        // FIREBASE INTEGRATION
        // ============================================================
        
        // Initialize Firebase only if FirebaseManager is available
        if (typeof FirebaseManager !== 'undefined') {
            FirebaseManager.setAuthCallback((isSignedIn, user) => {
                if (isSignedIn) {
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    document.getElementById('userEmail').textContent = user.email;
                    loadPlayerData();
                } else {
                    document.getElementById('loginScreen').style.display = 'block';
                    document.getElementById('mainApp').style.display = 'none';
                }
            });
            
            FirebaseManager.setDataLoadCallback((playerDatabase) => {
                console.log('Player database loaded:', Object.keys(playerDatabase).length, 'players');
                loadPlayerData();
                loadBuildingConfig();
                loadBuildingPositions();
            });
        } else {
            console.error('FirebaseManager not available - cannot initialize callbacks');
            // Show error message to user
            setTimeout(() => {
                const loginScreen = document.getElementById('loginScreen');
                if (loginScreen) {
                    loginScreen.innerHTML = '<div style="max-width: 600px; margin: 100px auto; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"><h1 style="text-align: center; color: #DC143C;">❌ Error Loading Application</h1><p style="color: #333; text-align: center; margin: 20px 0;">The firebase-module.js file is missing or not in the same folder as this HTML file.</p><p style="color: #666; text-align: center; font-size: 14px;">Please ensure both files are in the same directory:</p><ul style="color: #666; margin: 20px 40px;"><li>desert_storm_final.html</li><li>firebase-module.js</li></ul><p style="color: #666; text-align: center; font-size: 14px; margin-top: 20px;">Then refresh the page.</p></div>';
                    loginScreen.style.display = 'block';
                }
            }, 100);
        }
        
        let googleSignInInProgress = false;

        async function handleGoogleSignIn() {
            if (googleSignInInProgress) {
                return;
            }
            if (typeof FirebaseManager === 'undefined') {
                alert('Firebase not loaded. Please refresh the page.');
                return;
            }
            const btn = document.getElementById('googleSignInBtn');
            googleSignInInProgress = true;
            if (btn) {
                btn.disabled = true;
            }
            try {
                const result = await FirebaseManager.signInWithGoogle();
                if (!result.success) {
                    alert('Sign-in failed: ' + result.error);
                }
            } finally {
                googleSignInInProgress = false;
                if (btn) {
                    btn.disabled = false;
                }
            }
        }
        
        async function handleEmailSignIn() {
            if (typeof FirebaseManager === 'undefined') {
                alert('Firebase not loaded. Please refresh the page.');
                return;
            }
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }
            const result = await FirebaseManager.signInWithEmail(email, password);
            if (!result.success) {
                alert('Sign-in failed: ' + result.error);
            }
        }
        
        function showSignUpForm() {
            if (typeof FirebaseManager === 'undefined') {
                alert('Firebase not loaded. Please refresh the page.');
                return;
            }
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }
            if (password.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }
            if (confirm('Create new account with: ' + email)) {
                handleSignUp(email, password);
            }
        }
        
        async function handleSignUp(email, password) {
            if (typeof FirebaseManager === 'undefined') {
                alert('Firebase not loaded. Please refresh the page.');
                return;
            }
            const result = await FirebaseManager.signUpWithEmail(email, password);
            if (result.success) {
                alert('Account created! Check your email for verification.');
            } else {
                alert('Sign-up failed: ' + result.error);
            }
        }
        
        async function handlePasswordReset() {
            if (typeof FirebaseManager === 'undefined') {
                alert('Firebase not loaded. Please refresh the page.');
                return;
            }
            const email = document.getElementById('emailInput').value;
            if (!email) {
                alert('Please enter your email address');
                return;
            }
            const result = await FirebaseManager.resetPassword(email);
            if (result.success) {
                alert('Password reset email sent!');
            } else {
                alert('Failed: ' + result.error);
            }
        }
        
        async function handleSignOut() {
            if (typeof FirebaseManager === 'undefined') {
                alert('Firebase not loaded. Please refresh the page.');
                return;
            }
            if (confirm('Sign out?')) {
                await FirebaseManager.signOut();
            }
        }
        
        // ============================================================
        // COLLAPSIBLE PANEL
        // ============================================================
        
        function toggleUploadPanel() {
            uploadPanelExpanded = !uploadPanelExpanded;
            const content = document.getElementById('uploadContent');
            const icon = document.getElementById('uploadExpandIcon');
            
            if (uploadPanelExpanded) {
                content.classList.remove('collapsed');
                icon.classList.add('rotated');
            } else {
                content.classList.add('collapsed');
                icon.classList.remove('rotated');
            }
        }
        
        // ============================================================
        // TEMPLATE GENERATION
        // ============================================================
        
        function downloadPlayerTemplate() {
            const wb = XLSX.utils.book_new();
            
            const instructions = [
                ['PLAYER DATABASE TEMPLATE'],
                [''],
                ['Instructions:'],
                ['1. Fill Player Name column with exact names from game'],
                ['2. Fill E1 Total Power(M) column with numeric value (e.g., 65.0)'],
                ['3. Fill E1 Troops column with: Tank, Aero, or Missile'],
                ['4. Upload this file to the system'],
                ['5. Select teams in the web interface'],
                [''],
                ['Player Name', 'E1 Total Power(M)', 'E1 Troops']
            ];
            
            const examples = [
                ['Player1', 65.0, 'Tank'],
                ['Player2', 68.0, 'Aero'],
                ['Player3', 64.0, 'Missile'],
                ['', '', ''],
                ['', '', '']
            ];
            
            const data = [...instructions, ...examples];
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{wch: 25}, {wch: 20}, {wch: 15}];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Players');
            XLSX.writeFile(wb, 'player_database_template.xlsx');
            
            showMessage('uploadMessage', '✅ Template downloaded! Headers start at row 10.', 'success');
        }
        
        // ============================================================
        // PLAYER DATA MANAGEMENT
        // ============================================================
        
        async function uploadPlayerData() {
            if (typeof FirebaseManager === 'undefined') {
                showMessage('uploadMessage', '❌ Firebase not loaded. Please refresh the page.', 'error');
                return;
            }
            
            const fileInput = document.getElementById('playerFileInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            showMessage('uploadMessage', '⏳ Processing file...', 'processing');
            
            try {
                // Use Firebase module's upload function which reads from row 10
                const result = await FirebaseManager.uploadPlayerDatabase(file);
                
                if (result.success) {
                    showMessage('uploadMessage', result.message, 'success');
                    loadPlayerData();
                } else {
                    showMessage('uploadMessage', '❌ Upload failed: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('uploadMessage', '❌ Upload failed: ' + (error.error || error.message), 'error');
            }
            
            fileInput.value = '';
        }
        
        function loadPlayerData() {
            if (typeof FirebaseManager === 'undefined') {
                console.error('FirebaseManager not available');
                return;
            }
            
            const playerDB = FirebaseManager.getPlayerDatabase();
            const count = Object.keys(playerDB).length;
            
            document.getElementById('playerCount').textContent = count + ' players stored';
            
            if (count > 0) {
                allPlayers = Object.keys(playerDB).map(name => ({
                    name: name,
                    power: playerDB[name].power,
                    troops: playerDB[name].troops
                }));
                
                // Collapse upload panel and show selection
                uploadPanelExpanded = false;
                document.getElementById('uploadContent').classList.add('collapsed');
                document.getElementById('uploadExpandIcon').classList.remove('rotated');
                document.getElementById('uploadHint').textContent = '(Click to expand if you need to update player data)';
                
                showSelectionInterface();
            } else {
                // Keep upload panel expanded
                uploadPanelExpanded = true;
                document.getElementById('uploadContent').classList.remove('collapsed');
                document.getElementById('uploadExpandIcon').classList.add('rotated');
                document.getElementById('uploadHint').textContent = '';
            }
        }
        
        function showSelectionInterface() {
            document.getElementById('selectionSection').classList.remove('hidden');
            document.getElementById('floatingButtons').style.display = 'flex';
            reserveSpaceForFooter();
            renderPlayersTable();
            updateTeamCounters();
        }

        function toggleBuildingsPanel() {
            const panel = document.getElementById('buildingsPanel');
            const opening = panel.classList.contains('hidden');
            panel.classList.toggle('hidden');
            if (opening) {
                loadBuildingConfig();
                loadBuildingPositions();
            } else {
                renderBuildingsTable();
            }
        }

        function getDefaultBuildings() {
            return defaultBuildings.map((b) => ({ ...b }));
        }

        function normalizeBuildingConfig(config) {
            if (!Array.isArray(config)) {
                return getDefaultBuildings();
            }
            const defaultsByName = new Map(defaultBuildings.map((b) => [b.name, b]));
            return defaultBuildings.map((def) => {
                const stored = config.find((b) => b && b.name === def.name);
                const priority = stored && Number.isFinite(Number(stored.priority)) ? Number(stored.priority) : def.priority;
                return { name: def.name, slots: def.slots, priority: priority };
            });
        }

        function getDefaultBuildingPositions() {
            return JSON.parse(JSON.stringify(defaultBuildingPositions));
        }

        function normalizeBuildingPositions(positions) {
            const normalized = {};
            if (!positions || typeof positions !== 'object') {
                return normalized;
            }
            Object.keys(positions).forEach((name) => {
                const value = positions[name];
                if (Array.isArray(value) && value.length === 2) {
                    const x = Number(value[0]);
                    const y = Number(value[1]);
                    if (Number.isFinite(x) && Number.isFinite(y)) {
                        normalized[name] = [Math.round(x), Math.round(y)];
                    }
                }
            });
            return normalized;
        }

        function getEffectiveBuildingPositions() {
            return { ...getDefaultBuildingPositions(), ...buildingPositions };
        }

        function getEffectiveBuildingConfig() {
            return normalizeBuildingConfig(buildingConfig);
        }

        function loadBuildingConfig() {
            if (typeof FirebaseManager === 'undefined') {
                buildingConfig = getDefaultBuildings();
                renderBuildingsTable();
                return;
            }
            const stored = FirebaseManager.getBuildingConfig();
            buildingConfig = normalizeBuildingConfig(stored);

            const needsSave = !Array.isArray(stored) || stored.length !== buildingConfig.length || stored.some((item) => {
                if (!item || !item.name) {
                    return true;
                }
                const match = buildingConfig.find((b) => b.name === item.name);
                if (!match) {
                    return true;
                }
                const priority = Number(item.priority);
                const slots = Number(item.slots);
                if (!Number.isFinite(priority) || priority !== match.priority) {
                    return true;
                }
                if (!Number.isFinite(slots) || slots !== match.slots) {
                    return true;
                }
                return false;
            });

            if (needsSave) {
                FirebaseManager.setBuildingConfig(buildingConfig);
                FirebaseManager.saveUserData();
            }

            renderBuildingsTable();
        }

        function loadBuildingPositions() {
            if (typeof FirebaseManager === 'undefined') {
                buildingPositions = {};
                return;
            }
            const stored = FirebaseManager.getBuildingPositions();
            buildingPositions = normalizeBuildingPositions(stored);
        }

        function renderBuildingsTable() {
            const tbody = document.getElementById('buildingsTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            buildingConfig.forEach((b, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${b.name}</td>
                    <td>${b.slots}</td>
                    <td>
                        <input type="number" min="1" max="6" value="${b.priority}" data-index="${index}" style="width: 80px;">
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function resetBuildingsToDefault() {
            buildingConfig = getDefaultBuildings();
            renderBuildingsTable();
        }

        async function saveBuildingConfig() {
            const tbody = document.getElementById('buildingsTableBody');
            const inputs = tbody.querySelectorAll('input[data-index]');
            const updated = buildingConfig.map((b) => ({ ...b }));

            inputs.forEach((input) => {
                const index = Number(input.getAttribute('data-index'));
                const value = Number(input.value);
                if (Number.isFinite(value)) {
                    updated[index].priority = Math.max(1, Math.min(6, Math.round(value)));
                }
            });

            buildingConfig = normalizeBuildingConfig(updated);
            renderBuildingsTable();

            if (typeof FirebaseManager === 'undefined') {
                showMessage('buildingsStatus', 'Firebase not loaded. Changes not saved.', 'error');
                return;
            }

            FirebaseManager.setBuildingConfig(buildingConfig);
            const result = await FirebaseManager.saveUserData();
            if (result.success) {
                showMessage('buildingsStatus', '✅ Buildings & priorities saved.', 'success');
            } else {
                showMessage('buildingsStatus', '❌ Save failed: ' + result.error, 'error');
            }
        }

        function refreshBuildingConfigForAssignments() {
            const panel = document.getElementById('buildingsPanel');
            if (panel && !panel.classList.contains('hidden')) {
                syncBuildingConfigFromTable();
            } else {
                loadBuildingConfig();
            }
        }

        function syncBuildingConfigFromTable() {
            const tbody = document.getElementById('buildingsTableBody');
            const panel = document.getElementById('buildingsPanel');
            if (!tbody || !panel || panel.classList.contains('hidden')) {
                return;
            }
            const inputs = tbody.querySelectorAll('input[data-index]');
            const updated = buildingConfig.map((b) => ({ ...b }));
            inputs.forEach((input) => {
                const index = Number(input.getAttribute('data-index'));
                const value = Number(input.value);
                if (Number.isFinite(value)) {
                    updated[index].priority = Math.max(1, Math.min(6, Math.round(value)));
                }
            });
            buildingConfig = normalizeBuildingConfig(updated);
        }

        let coordBuildingIndex = 0;
        let coordBuildings = [];

        function openCoordinatesPicker() {
            loadBuildingPositions();
            coordBuildings = buildingConfig.map((b) => b.name);
            if (coordBuildings.length === 0) {
                showMessage('coordStatus', 'No buildings available for coordinates.', 'error');
                return;
            }
            coordBuildingIndex = 0;
            const overlay = document.getElementById('coordPickerOverlay');
            overlay.classList.remove('hidden');
            drawCoordCanvas();
        }

        function closeCoordinatesPicker() {
            document.getElementById('coordPickerOverlay').classList.add('hidden');
        }

        function updateCoordLabel() {
            const name = coordBuildings[coordBuildingIndex];
            const pos = buildingPositions[name];
            document.getElementById('coordBuildingLabel').textContent = name || '';
            document.getElementById('coordBuildingIndex').textContent = `(${coordBuildingIndex + 1}/${coordBuildings.length})`;
            document.getElementById('coordBuildingValue').textContent = pos ? `Current: x ${pos[0]}, y ${pos[1]}` : 'Current: not set';
            document.getElementById('coordPrompt').textContent = `Select coordinates for ${name}`;
        }

        function drawCoordCanvas() {
            const canvas = document.getElementById('coordCanvas');
            if (!canvas) return;

            updateCoordLabel();

            if (!mapLoaded) {
                loadMapImage()
                    .then(() => drawCoordCanvas())
                    .catch(() => {
                        showMessage('coordStatus', 'Map image not loaded. Please verify desert-storm-map.png exists.', 'error');
                    });
                return;
            }

            const ctx = canvas.getContext('2d');
            const mapHeight = Math.floor(mapImage.height * (1080 / mapImage.width));
            canvas.width = 1080;
            canvas.height = mapHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(mapImage, 0, 0, 1080, mapHeight);

            Object.entries(buildingPositions).forEach(([name, pos]) => {
                if (!pos) return;
                const isActive = name === coordBuildings[coordBuildingIndex];
                ctx.beginPath();
                ctx.arc(pos[0], pos[1], isActive ? 8 : 5, 0, Math.PI * 2);
                ctx.fillStyle = isActive ? '#FDC830' : 'rgba(255,255,255,0.7)';
                ctx.fill();
                ctx.strokeStyle = isActive ? '#000' : 'rgba(0,0,0,0.6)';
                ctx.lineWidth = 2;
                ctx.stroke();
            });
        }

        function coordCanvasClick(event) {
            const canvas = document.getElementById('coordCanvas');
            if (!canvas) return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = Math.round((event.clientX - rect.left) * scaleX);
            const y = Math.round((event.clientY - rect.top) * scaleY);
            const name = coordBuildings[coordBuildingIndex];
            buildingPositions[name] = [x, y];
            updateCoordLabel();
            drawCoordCanvas();
            if (coordBuildingIndex < coordBuildings.length - 1) {
                coordBuildingIndex += 1;
                updateCoordLabel();
                drawCoordCanvas();
            }
        }

        function prevCoordBuilding() {
            if (coordBuildingIndex > 0) {
                coordBuildingIndex -= 1;
                drawCoordCanvas();
            }
        }

        function nextCoordBuilding() {
            if (coordBuildingIndex < coordBuildings.length - 1) {
                coordBuildingIndex += 1;
                drawCoordCanvas();
            }
        }

        async function saveBuildingPositions() {
            if (typeof FirebaseManager === 'undefined') {
                showMessage('coordStatus', 'Firebase not loaded. Changes not saved.', 'error');
                return;
            }
            FirebaseManager.setBuildingPositions(buildingPositions);
            const result = await FirebaseManager.saveUserData();
            if (result.success) {
                showMessage('coordStatus', '✅ Coordinates saved.', 'success');
            } else {
                showMessage('coordStatus', '❌ Save failed: ' + result.error, 'error');
            }
        }

        function reserveSpaceForFooter() {
            const bar = document.getElementById('floatingButtons');
            if (!bar) return;
            const visible = bar.style.display !== 'none';
            const barHeight = visible ? bar.getBoundingClientRect().height : 0;
            document.body.style.paddingBottom = visible ? (barHeight + 30) + 'px' : '';
        }

        window.addEventListener('resize', reserveSpaceForFooter);
        
        // ============================================================
        // PLAYER SELECTION INTERFACE
        // ============================================================
        
        function renderPlayersTable() {
            const tbody = document.getElementById('playersTableBody');
            tbody.innerHTML = '';
            
            let displayPlayers = [...allPlayers];
            
            // Apply filters
            const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
            const troopsFilter = document.getElementById('troopsFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;
            
            if (searchTerm) {
                displayPlayers = displayPlayers.filter(p => 
                    p.name.toLowerCase().includes(searchTerm)
                );
            }
            
            if (troopsFilter) {
                displayPlayers = displayPlayers.filter(p => p.troops === troopsFilter);
            }
            
            switch(sortFilter) {
                case 'power-desc':
                    displayPlayers.sort((a, b) => b.power - a.power);
                    break;
                case 'power-asc':
                    displayPlayers.sort((a, b) => a.power - b.power);
                    break;
                case 'name-asc':
                    displayPlayers.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'name-desc':
                    displayPlayers.sort((a, b) => b.name.localeCompare(a.name));
                    break;
            }
            
            displayPlayers.forEach(player => {
                const row = document.createElement('tr');
                
                const isTeamA = teamSelections.teamA.includes(player.name);
                const isTeamB = teamSelections.teamB.includes(player.name);
                
                if (isTeamA) row.classList.add('selected-a');
                if (isTeamB) row.classList.add('selected-b');
                
                const teamADisabled = teamSelections.teamA.length >= 20 && !isTeamA;
                const teamBDisabled = teamSelections.teamB.length >= 20 && !isTeamB;
                
                // Escape player name for use in onclick
                const escapedName = player.name.replace(/'/g, "\\'");
                
                row.innerHTML = `
                    <td><strong>${player.name}</strong></td>
                    <td>${player.power}M</td>
                    <td>${player.troops}</td>
                    <td>
                        <div class="team-buttons">
                            <button class="team-btn team-a-btn ${isTeamA ? 'active' : ''}" 
                                    onclick="toggleTeam('${escapedName}', 'A')"
                                    ${teamADisabled ? 'disabled' : ''}>
                                Team A
                            </button>
                            <button class="team-btn team-b-btn ${isTeamB ? 'active' : ''}" 
                                    onclick="toggleTeam('${escapedName}', 'B')"
                                    ${teamBDisabled ? 'disabled' : ''}>
                                Team B
                            </button>
                            ${(isTeamA || isTeamB) ? '<button class="clear-btn" onclick="clearPlayerSelection(\'' + escapedName + '\')">Clear</button>' : ''}
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function toggleTeam(playerName, team) {
            if (team === 'A') {
                const index = teamSelections.teamA.indexOf(playerName);
                if (index > -1) {
                    teamSelections.teamA.splice(index, 1);
                } else {
                    const bIndex = teamSelections.teamB.indexOf(playerName);
                    if (bIndex > -1) {
                        teamSelections.teamB.splice(bIndex, 1);
                    }
                    if (teamSelections.teamA.length < 20) {
                        teamSelections.teamA.push(playerName);
                    }
                }
            } else {
                const index = teamSelections.teamB.indexOf(playerName);
                if (index > -1) {
                    teamSelections.teamB.splice(index, 1);
                } else {
                    const aIndex = teamSelections.teamA.indexOf(playerName);
                    if (aIndex > -1) {
                        teamSelections.teamA.splice(aIndex, 1);
                    }
                    if (teamSelections.teamB.length < 20) {
                        teamSelections.teamB.push(playerName);
                    }
                }
            }
            
            updateTeamCounters();
            renderPlayersTable();
        }
        
        function clearPlayerSelection(playerName) {
            const aIndex = teamSelections.teamA.indexOf(playerName);
            if (aIndex > -1) teamSelections.teamA.splice(aIndex, 1);
            
            const bIndex = teamSelections.teamB.indexOf(playerName);
            if (bIndex > -1) teamSelections.teamB.splice(bIndex, 1);
            
            updateTeamCounters();
            renderPlayersTable();
        }
        
        function clearAllSelections() {
            if (confirm('Clear all team selections?')) {
                teamSelections.teamA = [];
                teamSelections.teamB = [];
                assignmentsA = [];
                assignmentsB = [];
                document.getElementById('downloadSectionA').classList.add('hidden');
                document.getElementById('downloadSectionB').classList.add('hidden');
                updateTeamCounters();
                renderPlayersTable();
            }
        }
        
        function filterPlayers() {
            renderPlayersTable();
        }
        
        function updateTeamCounters() {
            const teamACount = teamSelections.teamA.length;
            const teamBCount = teamSelections.teamB.length;
            
            document.getElementById('teamACount').textContent = teamACount;
            document.getElementById('teamBCount').textContent = teamBCount;
            document.getElementById('teamAFloatCount').textContent = teamACount;
            document.getElementById('teamBFloatCount').textContent = teamBCount;
            
            const teamACounter = document.querySelector('.counter.team-a');
            const teamBCounter = document.querySelector('.counter.team-b');
            const generateBtnA = document.getElementById('generateBtnA');
            const generateBtnB = document.getElementById('generateBtnB');
            
            // Team A handling
            if (teamACount === 20) {
                teamACounter.classList.add('full');
            } else {
                teamACounter.classList.remove('full');
            }
            
            // Enable/disable Team A generate button (enable if at least 1 player selected)
            if (teamACount > 0) {
                generateBtnA.disabled = false;
            } else {
                generateBtnA.disabled = true;
            }
            
            // Team B handling
            if (teamBCount === 20) {
                teamBCounter.classList.add('full');
            } else {
                teamBCounter.classList.remove('full');
            }
            
            // Enable/disable Team B generate button (enable if at least 1 player selected)
            if (teamBCount > 0) {
                generateBtnB.disabled = false;
            } else {
                generateBtnB.disabled = true;
            }
        }
        
        // ============================================================
        // ASSIGNMENT GENERATION
        // ============================================================
        
        function generateTeamAssignments(team) {
            if (typeof FirebaseManager === 'undefined') {
                alert('Firebase not loaded. Please refresh the page.');
                return;
            }

            refreshBuildingConfigForAssignments();
            
            const selections = team === 'A' ? teamSelections.teamA : teamSelections.teamB;
            
            if (selections.length === 0) {
                alert(`Please select at least 1 player for Team ${team}!`);
                return;
            }
            
            if (selections.length > 20) {
                alert(`Maximum 20 players per team! Currently selected: ${selections.length}`);
                return;
            }
            
            const playerDB = FirebaseManager.getPlayerDatabase();
            
            const teamPlayers = selections.map(name => ({
                name: name,
                power: playerDB[name].power,
                troops: playerDB[name].troops
            })).sort((a, b) => b.power - a.power);
            
            const assignments = assignTeamToBuildings(teamPlayers);
            
            if (team === 'A') {
                assignmentsA = assignments;
                document.getElementById('downloadSectionA').classList.remove('hidden');
                reserveSpaceForFooter();
                document.getElementById('downloadSectionA').scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                assignmentsB = assignments;
                document.getElementById('downloadSectionB').classList.remove('hidden');
                reserveSpaceForFooter();
                document.getElementById('downloadSectionB').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            console.log(`Team ${team} assignments generated for ${selections.length} players:`, assignments);
        }
        
        function assignTeamToBuildings(players) {
            const assignments = [];
            let playerIndex = 0;

            const sortedBuildings = [...getEffectiveBuildingConfig()].sort((a, b) => {
                if (a.priority !== b.priority) {
                    return a.priority - b.priority;
                }
                return a.name.localeCompare(b.name);
            });
            
            sortedBuildings.forEach(building => {
                for (let i = 0; i < building.slots; i++) {
                    if (playerIndex < players.length) {
                        assignments.push({
                            building: building.name,
                            priority: building.priority,
                            player: players[playerIndex].name
                        });
                        playerIndex++;
                    }
                }
            });
            
            return assignments;
        }
        
        // ============================================================
        // DOWNLOAD FUNCTIONS
        // ============================================================
        
        function downloadTeamExcel(team) {
            const wb = XLSX.utils.book_new();
            const assignments = team === 'A' ? assignmentsA : assignmentsB;
            
            if (assignments.length === 0) {
                alert('No assignments generated yet! Click "Generate Team ' + team + ' Assignments" first.');
                return;
            }
            
            const data = assignments.map(a => ({ 
                'Building': a.building, 
                'Priority': a.priority, 
                'Player': a.player 
            }));
            
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), `Team ${team}`);
            XLSX.writeFile(wb, `desert_storm_team_${team}_assignments.xlsx`);
            
            const statusId = team === 'A' ? 'downloadStatusA' : 'downloadStatusB';
            showMessage(statusId, '✅ Excel downloaded!', 'success');
        }
        
        function downloadTeamMap(team) {
            const assignments = team === 'A' ? assignmentsA : assignmentsB;
            
            if (assignments.length === 0) {
                alert('No assignments generated yet! Click "Generate Team ' + team + ' Assignments" first.');
                return;
            }
            
            const statusId = team === 'A' ? 'downloadStatusA' : 'downloadStatusB';
            
            if (!mapLoaded) {
                showMessage(statusId, '⏳ Waiting for map to load...', 'processing');
                // Wait up to 10 seconds for map to load
                let waitTime = 0;
                const checkInterval = setInterval(() => {
                    waitTime += 500;
                    if (mapLoaded) {
                        clearInterval(checkInterval);
                        generateMap(team, assignments, statusId);
                    } else if (waitTime >= 10000) {
                        clearInterval(checkInterval);
                        if (confirm('Map image is still loading. Generate without map background?')) {
                            generateMapWithoutBackground(team, assignments, statusId);
                        } else {
                            showMessage(statusId, '⚠️ Cancelled. Refresh page to retry loading map.', 'warning');
                        }
                    }
                }, 500);
                return;
            }
            
            generateMap(team, assignments, statusId);
        }
        
        function generateMapWithoutBackground(team, assignments, statusId) {
            showMessage(statusId, `🎨 Generating Team ${team} map (no background)...`, 'processing');
            
            try {
                const grouped = {};
                const bombSquad = [];
                
                assignments.forEach(a => {
                    if (!a.player) return;
                    if (a.building === 'Bomb Squad') {
                        bombSquad.push(a);
                    } else {
                        if (!grouped[a.building]) grouped[a.building] = [];
                        grouped[a.building].push(a);
                    }
                });
                
                // Create simplified version without map
                const canvas = document.createElement('canvas');
                canvas.width = 1080;
                canvas.height = 800;
                const ctx = canvas.getContext('2d');
                
                // Background
                ctx.fillStyle = team === 'A' ? '#E8F4FF' : '#FFE8E8';
                ctx.fillRect(0, 0, 1080, 800);
                
                // Title
                const grad = ctx.createLinearGradient(0, 0, 1080, 100);
                grad.addColorStop(0, team === 'A' ? '#4169E1' : '#DC143C');
                grad.addColorStop(1, team === 'A' ? '#1E90FF' : '#FF6347');
                ctx.fillStyle = grad;
                ctx.fillRect(0, 0, 1080, 100);
                
                ctx.font = 'bold 48px Arial';
                ctx.fillStyle = 'white';
                ctx.textAlign = 'center';
                ctx.fillText(`TEAM ${team} - DESERT STORM`, 540, 60);
                
                // List assignments
                ctx.fillStyle = '#333';
                ctx.font = '16px Arial';
                ctx.textAlign = 'left';
                let y = 150;
                
                assignments.forEach((a, i) => {
                    if (a.player) {
                        ctx.fillText(`${i+1}. ${a.player} → ${a.building}`, 50, y);
                        y += 30;
                    }
                });
                
                // Download
                const dataURL = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = dataURL;
                a.download = `team_${team}_desert_storm_nomap.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                showMessage(statusId, `✅ Team ${team} downloaded (list format - no map)`, 'success');
            } catch (error) {
                console.error(error);
                showMessage(statusId, '❌ ' + error.message, 'error');
            }
        }
        
        function generateMap(team, assignments, statusId) {
            showMessage(statusId, `🎨 Generating Team ${team} map...`, 'processing');
            
            try {
                const grouped = {};
                const bombSquad = [];
                
                assignments.forEach(a => {
                    if (!a.player) return;
                    if (a.building === 'Bomb Squad') {
                        bombSquad.push(a);
                    } else {
                        if (!grouped[a.building]) grouped[a.building] = [];
                        grouped[a.building].push(a);
                    }
                });
                
                const titleHeight = 100;
                const bombHeight = 250;
                const mapHeight = Math.floor(mapImage.height * (1080 / mapImage.width));
                const totalHeight = titleHeight + mapHeight + bombHeight;
                
                const canvas = document.createElement('canvas');
                canvas.width = 1080;
                canvas.height = totalHeight;
                const ctx = canvas.getContext('2d');
                
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, 1080, totalHeight);
                
                const grad = ctx.createLinearGradient(0, 0, 1080, titleHeight);
                grad.addColorStop(0, team === 'A' ? '#4169E1' : '#DC143C');
                grad.addColorStop(1, team === 'A' ? '#1E90FF' : '#FF6347');
                ctx.fillStyle = grad;
                ctx.fillRect(0, 0, 1080, titleHeight);
                
                ctx.font = 'bold 48px Arial';
                ctx.fillStyle = 'white';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(`TEAM ${team} - DESERT STORM`, 540, titleHeight / 2);
                
                ctx.drawImage(mapImage, 0, titleHeight, 1080, mapHeight);
                
                let drawnCount = 0;
                const effectivePositions = getEffectiveBuildingPositions();
                Object.keys(grouped).forEach(building => {
                    if (!effectivePositions[building]) return;
                    
                    const [x, y_base] = effectivePositions[building];
                    const y = y_base + titleHeight;
                    const players = grouped[building];
                    const anchor = buildingAnchors[building] || 'left';
                    
                    players.slice(0, 2).forEach((player, i) => {
                        const name = player.player;
                        
                        ctx.font = 'bold 14px Arial';
                        const metrics = ctx.measureText(name);
                        const pad = 8;
                        const boxW = metrics.width + pad * 2;
                        const boxH = 24;
                        
                        const yPos = y + (i * 35) - 15;
                        let boxX = anchor === 'left' ? x - boxW - 15 : x + 15;
                        const boxY = yPos - boxH / 2;
                        
                        if (boxX < 5) boxX = 5;
                        else if (boxX + boxW > 1075) boxX = 1075 - boxW;
                        
                        ctx.fillStyle = bgColors[player.priority] || 'rgba(255,255,255,0.9)';
                        ctx.beginPath();
                        ctx.roundRect(boxX, boxY, boxW, boxH, 8);
                        ctx.fill();
                        
                        ctx.strokeStyle = 'black';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        
                        ctx.fillStyle = textColors[player.priority] || '#000000';
                        ctx.textAlign = 'left';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(name, boxX + pad, yPos);
                        
                        drawnCount++;
                    });
                });
                
                // Bomb Squad
                const bombY = titleHeight + mapHeight + 30;
                ctx.fillStyle = 'rgba(240,240,240,0.9)';
                ctx.beginPath();
                ctx.roundRect(240, bombY, 600, 180, 15);
                ctx.fill();
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                ctx.font = 'bold 20px Arial';
                ctx.fillStyle = team === 'A' ? '#4169E1' : '#DC143C';
                ctx.textAlign = 'center';
                ctx.fillText('BOMB SQUAD', 540, bombY + 25);
                
                let pY = bombY + 60;
                bombSquad.forEach((player, i) => {
                    const row = Math.floor(i / 2);
                    const col = i % 2;
                    const name = player.player;
                    
                    ctx.font = 'bold 14px Arial';
                    const m = ctx.measureText(name);
                    const bw = m.width + 12;
                    const xPos = 540 - 140 + (col * 280);
                    const yPos = pY + (row * 35);
                    
                    ctx.fillStyle = team === 'A' ? 'rgba(230,240,255,0.95)' : 'rgba(255,230,240,0.95)';
                    ctx.beginPath();
                    ctx.roundRect(xPos - bw/2, yPos - 10, bw, 20, 8);
                    ctx.fill();
                    
                    ctx.strokeStyle = team === 'A' ? '#4169E1' : '#DC143C';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    ctx.fillStyle = team === 'A' ? '#4169E1' : '#DC143C';
                    ctx.textAlign = 'center';
                    ctx.fillText(name, xPos, yPos);
                });
                
                ctx.font = '12px Arial';
                ctx.fillStyle = 'gray';
                ctx.fillText('Roam free, help others', 540, bombY + 160);
                
                const dataURL = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = dataURL;
                a.download = `team_${team}_desert_storm.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                showMessage(statusId, `✅ Team ${team} map downloaded! (${drawnCount} players + ${bombSquad.length} bomb squad)`, 'success');
            } catch (error) {
                console.error(error);
                const statusId = team === 'A' ? 'downloadStatusA' : 'downloadStatusB';
                showMessage(statusId, '❌ ' + error.message, 'error');
            }
        }
        
        // ============================================================
        // UTILITY FUNCTIONS
        // ============================================================
        
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            if (type === 'success') {
                setTimeout(() => {
                    element.innerHTML = '';
                }, 5000);
            }
        }

        document.addEventListener('click', (event) => {
            if (event.target && event.target.id === 'coordCanvas') {
                coordCanvasClick(event);
            }
        });
    </script>
</body>
</html>


