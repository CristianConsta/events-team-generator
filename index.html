<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://apis.google.com https://www.gstatic.com https://accounts.google.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://lh3.googleusercontent.com; connect-src 'self' https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://www.googleapis.com https://*.googleapis.com; font-src 'self' data:; base-uri 'none'; frame-src https://accounts.google.com https://*.google.com https://*.firebaseapp.com https://last-war-game-desert-storm.firebaseapp.com; form-action 'self';">
    <link rel="icon" href="data:,">
    <title>Desert Storm - Player Selection</title>
    <script src="vendor/xlsx.full.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="vendor/firebase-app-compat.js"></script>
    <script src="vendor/firebase-auth-compat.js"></script>
    <script src="vendor/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-module.js"></script>

    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" style="display: none;">
        <div style="max-width: 400px; margin: 100px auto; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h1 style="text-align: center; color: #333;" data-i18n="login_title">🏜️ Desert Storm</h1>
            <h3 style="text-align: center; color: #666; margin-bottom: 30px;" data-i18n="login_subtitle">Sign in to continue</h3>
            
            <button id="googleSignInBtn" onclick="handleGoogleSignIn()" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; cursor: pointer; background: white; border: 1px solid #ddd; border-radius: 8px; color: #333;">
                🔵 <span data-i18n="login_google">Sign in with Google</span>
            </button>
            
            <div style="text-align: center; margin: 20px 0; color: #999;" data-i18n="login_or">or</div>
            
            <input type="email" id="emailInput" placeholder="Email" data-i18n-placeholder="login_email_placeholder" style="width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;">
            <input type="password" id="passwordInput" placeholder="Password" data-i18n-placeholder="login_password_placeholder" style="width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;">
            
            <button onclick="handleEmailSignIn()" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 8px;">
                <span data-i18n="login_sign_in">Sign In</span>
            </button>
            
            <button onclick="showSignUpForm()" style="width: 100%; padding: 12px; margin: 5px 0; font-size: 14px; cursor: pointer; background: #2196F3; color: white; border: none; border-radius: 8px;">
                <span data-i18n="login_create_account">Create New Account</span>
            </button>
            
            <button onclick="handlePasswordReset()" style="width: 100%; padding: 8px; margin: 10px 0; font-size: 12px; cursor: pointer; background: transparent; color: #666; border: none;">
                <span data-i18n="login_forgot_password">Forgot Password?</span>
            </button>
            
            <select id="loginLanguageSelect" style="display: block; margin: 18px auto 0; padding: 6px 10px; border-radius: 6px; border: 1px solid #ddd; background: #fff; color: #333; font-size: 13px; cursor: pointer;">
                <option value="en">EN</option>
                <option value="fr">FR</option>
                <option value="de">DE</option>
                <option value="it">IT</option>
                <option value="ko">KO</option>
                <option value="ro">RO</option>
            </select>

            <div id="statusMessage" style="margin-top: 20px; padding: 10px; border-radius: 8px; text-align: center; display: none;"></div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display: none;">
        <!-- User Header -->
        <div id="userHeader" style="background: rgba(255,255,255,0.1); padding: 15px; margin-bottom: 20px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto 20px auto;">
            <div>
                <div style="display: flex; align-items: center; gap: 6px;">
                    <span id="userEmail" style="color: var(--gold); font-weight: bold;"></span>
                    <span id="allianceDisplay" style="display: none; color: var(--gold); font-weight: bold; opacity: 0.7; cursor: pointer;" onclick="toggleAlliancePanel()"></span>
                </div>
                <div id="playerCount" style="color: rgba(255,255,255,0.65); font-size: 13px;"></div>
            </div>
            <div id="headerRight" style="display: flex; align-items: center; gap: 10px;">
                <button id="notificationBtn" onclick="toggleNotificationsPanel()" title="Notifications" style="position: relative; padding: 8px 10px; background: transparent; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer; display: flex; align-items: center; margin: 0;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                    <span id="notificationBadge" style="display: none; position: absolute; top: -4px; right: -4px; background: #DC143C; color: white; font-size: 10px; font-weight: bold; width: 18px; height: 18px; border-radius: 50%; align-items: center; justify-content: center;">0</span>
                </button>
                <select id="languageSelect">
                    <option value="en">EN</option>
                    <option value="fr">FR</option>
                    <option value="de">DE</option>
                    <option value="it">IT</option>
                    <option value="ko">KO</option>
                    <option value="ro">RO</option>
                </select>
                <button id="signOutBtn" onclick="handleSignOut()" title="Sign Out" style="padding: 8px 10px; background: #FF6B35; color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                </button>
            </div>
        </div>

        <div class="container">
            <div class="page-header">
                <h1 data-i18n="main_title">🏜️ DESERT STORM</h1>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="secondary header-icon-btn" onclick="toggleAlliancePanel()" title="Alliance">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        <span class="btn-label" data-i18n="alliance_button">Alliance</span>
                    </button>
                    <button class="secondary header-icon-btn" onclick="toggleBuildingsPanel()" title="Buildings &amp; Priorities">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><line x1="9" y1="6" x2="9" y2="6.01"/><line x1="15" y1="6" x2="15" y2="6.01"/><line x1="9" y1="10" x2="9" y2="10.01"/><line x1="15" y1="10" x2="15" y2="10.01"/><line x1="9" y1="14" x2="9" y2="14.01"/><line x1="15" y1="14" x2="15" y2="14.01"/><line x1="9" y1="18" x2="15" y2="18"/></svg>
                        <span class="btn-label" data-i18n="buildings_button">Buildings &amp; Priorities</span>
                    </button>
                </div>
            </div>

            <div id="buildingsPanel" class="card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <h2 style="margin: 0;" data-i18n="buildings_panel_title">Buildings &amp; Priorities</h2>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="clear-btn" onclick="openCoordinatesPicker()"><span data-i18n="map_coordinates">Map Coordinates</span></button>
                        <button class="clear-btn" onclick="toggleBuildingsPanel()"><span data-i18n="close">Close</span></button>
                    </div>
                </div>
                <p style="opacity: 0.9; margin: 15px 0;" data-i18n="buildings_intro">Update building slots and priorities. Total slots across all buildings must be 20 or less.</p>
                <div style="overflow-x: auto;">
                    <table class="players-table" id="buildingsTable">
                        <thead>
                            <tr>
                                <th data-i18n="buildings_table_building">Building</th>
                                <th data-i18n="buildings_table_slots">Slots</th>
                                <th data-i18n="buildings_table_priority">Priority</th>
                            </tr>
                        </thead>
                        <tbody id="buildingsTableBody">
                            <!-- Building rows will be rendered here -->
                        </tbody>
                    </table>
                </div>
                <div id="buildingsActions" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                    <button class="secondary" onclick="resetBuildingsToDefault()"><span data-i18n="reset_default">Reset to Default</span></button>
                    <button onclick="saveBuildingConfig()"><span data-i18n="save_changes">Save Changes</span></button>
                </div>
                <div id="buildingsStatus"></div>
            </div>

            <div id="alliancePanel" class="card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <h2 style="margin: 0;" data-i18n="alliance_panel_title">Alliance</h2>
                    <button class="clear-btn" onclick="toggleAlliancePanel()"><span data-i18n="close">Close</span></button>
                </div>
                <div id="alliancePanelContent"></div>
            </div>

            <div id="notificationsPanel" class="card hidden" style="position: fixed; top: 60px; right: 20px; z-index: 1500; max-width: 380px; width: calc(100vw - 40px); max-height: 400px; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.4); border: 1px solid rgba(var(--gold-rgb), 0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: var(--gold);" data-i18n="notifications_title">Notifications</h3>
                    <button class="clear-btn" onclick="toggleNotificationsPanel()"><span data-i18n="close">Close</span></button>
                </div>
                <div id="notificationsList"></div>
            </div>

            <div id="uploadTargetModal" class="coord-overlay hidden">
                <div style="width: min(400px, 90vw); background: rgba(26, 26, 46, 0.98); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); padding: 30px;">
                    <h2 style="margin: 0 0 10px;" data-i18n="upload_target_title">Upload Destination</h2>
                    <p style="opacity: 0.9; margin-bottom: 20px;" data-i18n="upload_target_desc">Where should this player data be stored?</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <button onclick="uploadToPersonal()" style="padding: 16px;"><span data-i18n="upload_target_personal">My Database</span></button>
                        <button onclick="uploadToAlliance()" class="secondary" style="padding: 16px;"><span data-i18n="upload_target_alliance">Alliance Database</span></button>
                    </div>
                    <button class="clear-btn" onclick="closeUploadTargetModal()" style="display: block; margin: 15px auto 0;"><span data-i18n="close">Close</span></button>
                </div>
            </div>

            <div id="coordPickerOverlay" class="coord-overlay hidden">
                <div style="width: min(1000px, 95vw); max-height: 90vh; overflow: auto; background: rgba(26, 26, 46, 0.98); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); padding: 20px;">
                    <div id="coordHeader" style="display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <h2 style="margin: 0;" data-i18n="coord_picker_title">Map Coordinates Picker</h2>
                        <button class="clear-btn" onclick="closeCoordinatesPicker()"><span data-i18n="close">Close</span></button>
                    </div>
                    <p style="opacity: 0.9; margin: 10px 0 15px;" data-i18n="coord_picker_help">Click on the map to set the position for the selected building. Coordinates update one by one.</p>
                    <div id="coordBuildingRow" style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center; margin-bottom: 6px;">
                        <strong id="coordBuildingLabel" data-i18n="coord_label_building">Building</strong>
                        <span id="coordBuildingIndex" style="opacity: 0.7;"></span>
                    </div>
                    <div id="coordPrompt" style="opacity: 0.85; margin-bottom: 10px;" data-i18n="coord_prompt_default">Click on the map to set coordinates.</div>
                    <div id="coordBuildingValue" style="opacity: 0.7; margin-bottom: 10px;"></div>
                    <canvas id="coordCanvas" style="width: 100%; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2);"></canvas>
                    <div id="coordActions" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                        <button class="secondary" onclick="prevCoordBuilding()"><span data-i18n="coord_prev">Prev</span></button>
                        <button class="secondary" onclick="nextCoordBuilding()"><span data-i18n="coord_next">Next</span></button>
                        <button onclick="saveBuildingPositions()"><span data-i18n="coord_save">Save Coordinates</span></button>
                    </div>
                    <div id="coordStatus" style="margin-top: 10px;"></div>
                </div>
            </div>
            
            <!-- Upload Section (Collapsible when players exist) -->
            <div id="uploadSection" class="card">
                <div class="collapsible-header" onclick="toggleUploadPanel()">
                    <div>
                        <h2 style="display: inline; margin: 0;" data-i18n="player_db_title">📊 Player Database</h2>
                        <span id="uploadHint" style="margin-left: 15px; opacity: 0.7; font-size: 14px;"></span>
                    </div>
                    <span class="expand-icon rotated" id="uploadExpandIcon">▼</span>
                </div>
                
                <div class="collapsible-content" id="uploadContent">
                    <p style="opacity: 0.9; margin-bottom: 20px;" data-i18n="upload_help">Upload your player data. Template headers start at row 10: Player Name, E1 Total Power(M), E1 Troops.</p>
                    
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button id="downloadTemplateBtn" class="secondary" onclick="downloadPlayerTemplate()">📥 <span data-i18n="download_template">Download Template</span></button>
                        <button id="uploadPlayerBtn" onclick="document.getElementById('playerFileInput').click()">📤 <span data-i18n="upload_player_data">Upload Player Data</span></button>
                        <input type="file" id="playerFileInput" accept=".xlsx,.xls" onchange="uploadPlayerData()">
                    </div>
                    
                    <div id="uploadMessage"></div>
                </div>
            </div>
            
            <!-- Player Selection Section -->
            <div id="selectionSection" class="card hidden">
                <h2 data-i18n="select_teams_title">⚔️ Select Teams</h2>
                <p style="opacity: 0.9; margin-bottom: 20px;" data-i18n="select_teams_help">Select players for Team A and Team B independently. Maximum 20 players per team.</p>
                
                <!-- Team Counters -->
                <div class="team-counters">
                    <div class="counter team-a">
                        <span data-i18n="team_a_label">Team A</span>:
                        <span id="teamAStarterCount">0</span>/20 |
                        <span data-i18n="subs_short">Sub</span>: <span id="teamASubCount">0</span>/10
                    </div>
                    <div class="counter team-b">
                        <span data-i18n="team_b_label">Team B</span>:
                        <span id="teamBStarterCount">0</span>/20 |
                        <span data-i18n="subs_short">Sub</span>: <span id="teamBSubCount">0</span>/10
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="filters">
                    <input type="text" id="searchFilter" placeholder="🔍 Search player name..." data-i18n-placeholder="search_placeholder" onkeyup="filterPlayers()">
                    <div class="filter-dropdown" id="troopsFilterWrapper">
                        <button class="filter-icon-btn" id="troopsFilterBtn">
                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M2 4h14l-5 6v4l-4 2V10L2 4z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/></svg>
                        </button>
                        <div class="filter-dropdown-panel" id="troopsFilterPanel">
                            <div class="filter-option selected" data-value="" data-i18n="troops_filter_all">All Troop Types</div>
                            <div class="filter-option" data-value="Tank" data-i18n="troops_filter_tank">Tank</div>
                            <div class="filter-option" data-value="Aero" data-i18n="troops_filter_aero">Aero</div>
                            <div class="filter-option" data-value="Missile" data-i18n="troops_filter_missile">Missile</div>
                        </div>
                    </div>
                    <div class="filter-dropdown" id="sortFilterWrapper">
                        <button class="filter-icon-btn" id="sortFilterBtn">
                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M6 11l3 3 3-3M12 7L9 4 6 7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                        <div class="filter-dropdown-panel" id="sortFilterPanel">
                            <div class="filter-option selected" data-value="power-desc" data-i18n="sort_power_desc">Sort by Power (High to Low)</div>
                            <div class="filter-option" data-value="power-asc" data-i18n="sort_power_asc">Sort by Power (Low to High)</div>
                            <div class="filter-option" data-value="name-asc" data-i18n="sort_name_asc">Sort by Name (A-Z)</div>
                            <div class="filter-option" data-value="name-desc" data-i18n="sort_name_desc">Sort by Name (Z-A)</div>
                        </div>
                    </div>
                    <button class="filter-icon-btn" id="clearAllBtn" onclick="clearAllSelections()" style="margin-left: auto;" title="Clear All">
                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><circle cx="9" cy="9" r="7" stroke="currentColor" stroke-width="1.5"/><path d="M6 6l6 6M12 6l-6 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
                    </button>
                </div>
                
                <!-- Players Table -->
                <div style="overflow-x: auto;">
                    <table class="players-table" id="playersTable">
                        <thead>
                            <tr>
                                <th data-i18n="table_header_player_name">Player Name</th>
                                <th data-i18n="table_header_power">E1 Power (M)</th>
                                <th data-i18n="table_header_troop">Troop Type</th>
                                <th data-i18n="table_header_team_selection">Team Selection</th>
                            </tr>
                        </thead>
                        <tbody id="playersTableBody">
                            <!-- Players will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Team A & B Sections removed - replaced with floating buttons -->
            
            
            <!-- Download Modal -->
            <div id="downloadModalOverlay" class="coord-overlay hidden">
                <div style="width: min(480px, 90vw); background: rgba(26, 26, 46, 0.98); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); padding: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h2 id="downloadModalTitle" style="margin: 0;"></h2>
                        <button class="clear-btn" onclick="closeDownloadModal()"><span data-i18n="close">Close</span></button>
                    </div>
                    <p id="downloadModalSubtitle" style="opacity: 0.9; margin: 0 0 25px;"></p>
                    <div id="downloadBtnGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <button id="downloadMapBtn" style="font-size: 17px; padding: 16px 25px;">
                            🗺️ <span data-i18n="download_map">Map</span>
                        </button>
                        <button id="downloadExcelBtn" style="padding: 16px 25px;">
                            📊 <span data-i18n="download_excel">Excel</span>
                        </button>
                    </div>
                    <div id="downloadStatus" style="margin-top: 15px;"></div>
                </div>
            </div>
        </div>

        <!-- Floating Generate Buttons -->
        <div class="floating-buttons" id="floatingButtons" style="display: none;">
            <button class="generate-btn" id="generateBtnA" onclick="generateTeamAssignments('A')" style="background: linear-gradient(135deg, var(--team-a), #1E90FF);" disabled>
                <span style="display: block; font-size: 14px; opacity: 0.9;"><span data-i18n="team_a_label">Team A</span> (<span id="teamAFloatStarterCount">0</span>/20 | <span data-i18n="subs_short">Sub</span>: <span id="teamAFloatSubCount">0</span>/10)</span>
                🚀 <span data-i18n="generate_team_a">Generate Team A</span>
            </button>
            <button class="generate-btn" id="generateBtnB" onclick="generateTeamAssignments('B')" style="background: linear-gradient(135deg, var(--team-b), #FF6347);" disabled>
                <span style="display: block; font-size: 14px; opacity: 0.9;"><span data-i18n="team_b_label">Team B</span> (<span id="teamBFloatStarterCount">0</span>/20 | <span data-i18n="subs_short">Sub</span>: <span id="teamBFloatSubCount">0</span>/10)</span>
                🚀 <span data-i18n="generate_team_b">Generate Team B</span>
            </button>
        </div>

        <!-- Onboarding Tour Tooltip (reused for each step) -->
        <div id="onboardingTooltip" class="onboarding-tooltip hidden">
            <div class="onboarding-step-label" id="onboardingStepLabel"></div>
            <div class="onboarding-title"      id="onboardingTitle"></div>
            <div class="onboarding-desc"       id="onboardingDesc"></div>
            <div class="onboarding-skip"       id="onboardingSkip"></div>
        </div>
    </div>

    <script src="translations.js"></script>
    <script src="app.js"></script>
</body>
</html>


